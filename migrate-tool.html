<!doctype html>
<html lang="ja">
<head>
  <!--
  APP: Smart Price Migration Tool
  VERSION: v0.2.0
  DATE(JST): 2026-02-09 14:09 JST
  TITLE: Smart Price Migrate Tool (Detect & Compare)
  CHANGES:
  - 旧データ候補DB/Storeの自動検出（IndexedDB + localStorage）
  - 現在オリジンの総点検サマリJSON生成（コピー/保存）
  - サマリ2つの比較（件数差分・「多い方=生」提案）
  BUILD_PARAM(b): ?b=2026-02-09_1409_compare
  DEBUG_PARAM: &debug=1
  POLICY: UI_FREEZE / 単一HTML / 読むより押す（ボタン中心）
  -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Price / Migrate Tool v0.2.0</title>
  <style>
    :root {
      --bg:#111; --panel:#1b1b1b; --panel2:#151515; --txt:#f5f5f5; --muted:#b9b9b9;
      --accent:#b71c1c; --accent2:#333; --ok:#2e7d32; --warn:#f9a825; --bad:#c62828;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --ui: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    html, body { height:100%; }
    body { margin:0; background:var(--bg); color:var(--txt); font-family:var(--ui); }
    header {
      background:linear-gradient(0deg, #8e1414, var(--accent));
      padding:12px 16px;
      font-weight:700;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    header .sub { font-weight:600; color:#ffecec; opacity:0.95; font-size:12px; }
    main { padding:14px; max-width:1200px; margin:0 auto; }
    .grid { display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width: 1020px) { .grid { grid-template-columns: 1fr 1fr; } }
    .card {
      background:var(--panel); border-radius:14px; padding:12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.06);
    }
    .card h2 { margin:0 0 10px 0; font-size:14px; color:#fff; }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    button {
      appearance:none; border:0; border-radius:12px;
      padding:12px 14px; font-weight:700; cursor:pointer;
      background:var(--accent2); color:var(--txt);
      box-shadow: 0 8px 20px rgba(0,0,0,0.25);
    }
    button.primary { background:var(--accent); }
    button.ok { background:var(--ok); }
    button.warn { background:var(--warn); color:#111; }
    button:disabled { opacity:0.55; cursor:not-allowed; }
    .note { color:var(--muted); font-size:12px; line-height:1.4; }
    .mono { font-family:var(--mono); }
    textarea, pre, input {
      width:100%;
      background:var(--panel2);
      color:var(--txt);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:12px;
      padding:10px;
      font-family:var(--mono);
      font-size:12px;
      box-sizing:border-box;
    }
    textarea { min-height: 170px; resize: vertical; }
    pre { margin:0; overflow:auto; min-height: 140px; }
    .badge {
      display:inline-block; padding:4px 8px; border-radius:999px;
      font-size:12px; font-weight:800; margin-left:8px;
    }
    .b-ok { background: rgba(46,125,50,0.25); border:1px solid rgba(46,125,50,0.5); }
    .b-warn { background: rgba(249,168,37,0.25); border:1px solid rgba(249,168,37,0.5); }
    .b-bad { background: rgba(198,40,40,0.25); border:1px solid rgba(198,40,40,0.5); }
    .tbl {
      width:100%; border-collapse:collapse; overflow:hidden; border-radius:12px;
      border:1px solid rgba(255,255,255,0.08);
    }
    .tbl th, .tbl td {
      padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.06);
      font-size:12px;
    }
    .tbl th { text-align:left; color:#fff; background: rgba(255,255,255,0.04); }
    .right { text-align:right; }
    .k { color:#fff; }
    .small { font-size:12px; }
    .hr { height:1px; background: rgba(255,255,255,0.08); margin:10px 0; }
    .foot { margin-top:10px; color:var(--muted); font-size:11px; }
  </style>
</head>
<body>
  <header>
    <div>
      <div>Smart Price / Migrate Tool <span class="sub">v0.2.0</span></div>
      <div class="sub mono">BUILD: 2026-02-09_1409_compare</div>
    </div>
    <div class="sub mono" id="hdrNow">2026-02-09 14:09 JST</div>
  </header>

  <main>
    <div class="card" style="margin-bottom:12px;">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="small"><b>使い方（読むより押す）</b></div>
          <div class="note">
            ①「このURLのデータを点検」→ ②「サマリJSONをコピー」。
            旧URLでも同じ操作をしてサマリをコピー。
            最後に「比較」に2つ貼り付けて、<b>どっちが“生”か</b>を決めます。
          </div>
        </div>
        <div class="row">
          <button class="primary" id="btnScan">① このURLのデータを点検</button>
          <button class="ok" id="btnCopy" disabled>② サマリJSONをコピー</button>
        </div>
      </div>
      <div class="hr"></div>
      <div class="note">
        ※ 旧データがあるかどうかは、<b>このURL（このオリジン）</b>に保存されているIndexedDB/localStorageだけを見ます。<br/>
        別のURLの中身は直接見れないので、旧URL側でも同じツールでサマリを作ってください。
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <h2>点検結果（このURL）</h2>
        <div class="row">
          <span class="badge b-warn" id="badgeState">未点検</span>
          <span class="note mono" id="originLine"></span>
        </div>
        <div class="hr"></div>
        <pre id="outText" class="mono"></pre>
        <div class="foot mono" id="sumLine"></div>
      </section>

      <section class="card">
        <h2>比較（サマリ2つ貼り付け → 判定）</h2>
        <div class="note">旧URLでコピーしたサマリと、新URLでコピーしたサマリをここに貼り付け。</div>
        <div class="row" style="margin:10px 0;">
          <button class="primary" id="btnCompare">③ 比較して「生」を提案</button>
          <button class="warn" id="btnSwap">左右を入れ替え</button>
          <button id="btnClear">クリア</button>
        </div>
        <div class="grid" style="grid-template-columns:1fr 1fr; gap:10px;">
          <div>
            <div class="small"><b>A（例：旧URL）</b></div>
            <textarea id="inA" placeholder="ここにサマリJSON（A）を貼る"></textarea>
          </div>
          <div>
            <div class="small"><b>B（例：新URL）</b></div>
            <textarea id="inB" placeholder="ここにサマリJSON（B）を貼る"></textarea>
          </div>
        </div>
        <div class="hr"></div>
        <div id="cmpArea" class="mono"></div>
      </section>
    </div>

    <section class="card" style="margin-top:12px;">
      <h2>次の一手（あなたが押すボタンだけ）</h2>
      <div class="note">
        比較で「生（master）」が決まったら、<b>生のURL</b>で <b>migrate-tool.html</b> を開いて「Export」してJSON保存。<br/>
        そのJSONを、反対側（取り込みたいURL）で「Import」して取り込む。<br/>
        ※ Import/Exportが見えない・動かない場合は、<b>まずPagesが有効か／URLが正しいか／Service Workerが古くないか</b>を先に潰します。
      </div>
    </section>
  </main>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const DEBUG = qs.get('debug') === '1';
  const BUILD = '2026-02-09_1409_compare';
  const VERSION = 'v0.2.0';

  const el = (id)=>document.getElementById(id);
  const outText = el('outText');
  const badge = el('badgeState');
  const originLine = el('originLine');
  const sumLine = el('sumLine');
  const btnScan = el('btnScan');
  const btnCopy = el('btnCopy');
  const btnCompare = el('btnCompare');
  const btnSwap = el('btnSwap');
  const btnClear = el('btnClear');
  const inA = el('inA');
  const inB = el('inB');
  const cmpArea = el('cmpArea');

  originLine.textContent = location.origin + location.pathname;

  function setBadge(type, text){
    badge.classList.remove('b-ok','b-warn','b-bad');
    badge.classList.add(type);
    badge.textContent = text;
  }

  function log(s){ outText.textContent += s + "\\n"; }

  function fmt(n){
    try { return (n ?? 0).toLocaleString('ja-JP'); } catch(e) { return String(n ?? 0); }
  }

  function safeJsonParse(s){
    const t = (s||'').trim();
    if(!t) throw new Error('空です');
    return JSON.parse(t);
  }

  async function listDatabases(){
    if (indexedDB.databases) {
      try { return await indexedDB.databases(); } catch(e) {}
    }
    return null;
  }

  function openDb(name){
    return new Promise((resolve, reject)=>{
      const req = indexedDB.open(name);
      req.onsuccess = ()=> resolve(req.result);
      req.onerror = ()=> reject(req.error || new Error('open失敗: '+name));
      req.onblocked = ()=> reject(new Error('blocked: '+name));
    });
  }

  function countStore(db, storeName){
    return new Promise((resolve, reject)=>{
      try {
        const tx = db.transaction(storeName, 'readonly');
        const st = tx.objectStore(storeName);
        const req = st.count();
        req.onsuccess = ()=> resolve(req.result || 0);
        req.onerror = ()=> reject(req.error || new Error('count失敗: '+storeName));
      } catch(e) {
        reject(e);
      }
    });
  }

  function getLocalStorageSummary(){
    const keys = [];
    for (let i=0; i<localStorage.length; i++) {
      const k = localStorage.key(i);
      keys.push(k);
    }
    keys.sort();
    let approxChars = 0;
    const top = [];
    for (const k of keys) {
      const v = localStorage.getItem(k) || '';
      approxChars += (k.length + v.length);
      top.push({k, len: v.length});
    }
    top.sort((a,b)=> (b.len||0)-(a.len||0));
    return {
      count: keys.length,
      approxChars,
      topKeys: top.slice(0, 12)
    };
  }

  function detectLegacyHints(dbs, storeIndex){
    const hints = [];
    const names = (dbs||[]).map(d=> (d && d.name) ? d.name : String(d)).filter(Boolean);
    const joined = names.join(' | ');
    const patterns = [
      /smart_price_img_db/i,
      /smartPriceIm/i,
      /smart_price_i/i,
      /firebase/i,
      /heart/i,
      /local/i
    ];
    for (const p of patterns){
      if (p.test(joined)) hints.push('DB名に「'+p.source+'」が見つかりました');
    }
    const storeNames = Object.keys(storeIndex || {});
    const storeJoined = storeNames.join(' | ');
    const storePatterns = [
      /items/i, /history/i, /prices/i, /images/i, /img/i, /receipts?/i, /stores/i
    ];
    for (const p of storePatterns){
      if (p.test(storeJoined)) hints.push('Store名に「'+p.source+'」が見つかりました');
    }
    return hints;
  }

  let lastSummary = null;

  async function scan(){
    outText.textContent = '';
    setBadge('b-warn','点検中…');
    btnCopy.disabled = true;

    const summary = {
      tool: 'SmartPriceMigrateTool',
      version: VERSION,
      build: BUILD,
      capturedAtJST: new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }),
      url: location.href,
      origin: location.origin,
      indexedDB: {
        databases: [],
        stores: {},
        totals: { dbCount: 0, storeCount: 0, recordCount: 0 }
      },
      localStorage: getLocalStorageSummary(),
      legacyHints: []
    };

    log('URL: ' + summary.url);
    log('ORIGIN: ' + summary.origin);
    log('---');
    log('localStorage: keys=' + fmt(summary.localStorage.count) + ' / approxChars=' + fmt(summary.localStorage.approxChars));
    if (summary.localStorage.topKeys.length) {
      log('localStorage top keys:');
      for (const t of summary.localStorage.topKeys) log('  - ' + t.k + ' (len=' + fmt(t.len) + ')');
    }

    log('---');
    let dbs = await listDatabases();
    if (!dbs) {
      log('indexedDB.databases() が使えません。DB名の自動列挙ができない環境です。');
      log('（Chromeの新しめ環境では出ます）');
      summary.indexedDB.databases = null;
      setBadge('b-warn','DB列挙不可（環境）');
      lastSummary = summary;
      btnCopy.disabled = false;
      sumLine.textContent = 'サマリ準備OK（ただしDB列挙不可）';
      return;
    }
    summary.indexedDB.databases = dbs;
    summary.indexedDB.totals.dbCount = dbs.length;
    log('IndexedDB DB count: ' + fmt(dbs.length));
    log('---');

    const storeIndex = {};
    for (const d of dbs) {
      const name = d.name;
      try {
        const db = await openDb(name);
        const v = db.version;
        const storeNames = Array.from(db.objectStoreNames || []);
        summary.indexedDB.stores[name] = { version: v, stores: {} };
        log('DB: ' + name + ' (ver ' + v + ')');
        if (!storeNames.length) log('  (stores: none)');
        summary.indexedDB.totals.storeCount += storeNames.length;
        for (const stName of storeNames) {
          let c = 0;
          try { c = await countStore(db, stName); } catch(e) { c = -1; }
          summary.indexedDB.stores[name].stores[stName] = c;
          storeIndex[stName] = true;
          if (c >= 0) {
            summary.indexedDB.totals.recordCount += c;
            log('  - ' + stName + ' : ' + fmt(c));
          } else {
            log('  - ' + stName + ' : (count失敗)');
          }
        }
        db.close();
      } catch(e) {
        log('DB: ' + name + ' (open失敗) ' + String(e && e.message ? e.message : e));
      }
      log('');
    }

    summary.legacyHints = detectLegacyHints(dbs, storeIndex);

    log('---');
    log('Totals: db=' + fmt(summary.indexedDB.totals.dbCount) +
        ' / stores=' + fmt(summary.indexedDB.totals.storeCount) +
        ' / records=' + fmt(summary.indexedDB.totals.recordCount));
    if (summary.legacyHints.length) {
      log('---');
      log('旧データ候補ヒント:');
      for (const h of summary.legacyHints) log('  * ' + h);
    } else {
      log('---');
      log('旧データ候補ヒント: 特になし（それでもDBが空とは限りません）');
    }

    const rec = summary.indexedDB.totals.recordCount;
    if (rec > 0 || summary.localStorage.count > 0) {
      setBadge('b-ok','データあり');
    } else {
      setBadge('b-bad','空っぽの可能性');
    }
    sumLine.textContent = 'サマリ準備OK（②でコピーできます）';
    lastSummary = summary;
    btnCopy.disabled = false;
  }

  async function copySummary(){
    if (!lastSummary) return;
    const s = JSON.stringify(lastSummary, null, 2);
    try {
      await navigator.clipboard.writeText(s);
      sumLine.textContent = 'コピーしました（サマリJSON）';
    } catch(e) {
      sumLine.textContent = 'クリップボードに失敗。下のJSONを手でコピーしてください。';
      outText.textContent = s;
    }
  }

  function scoreSummary(sum){
    const idb = sum?.indexedDB?.totals?.recordCount ?? 0;
    const ls = sum?.localStorage?.count ?? 0;
    const lsChars = sum?.localStorage?.approxChars ?? 0;
    return {
      recordCount: idb,
      localStorageKeys: ls,
      localStorageChars: lsChars,
      score: (idb * 1000000) + (ls * 1000) + Math.min(lsChars, 999999)
    };
  }

  function flattenStores(sum){
    const rows = [];
    const stores = sum?.indexedDB?.stores || {};
    for (const [dbName, dbObj] of Object.entries(stores)) {
      const st = dbObj?.stores || {};
      for (const [storeName, c] of Object.entries(st)) {
        rows.push({ dbName, storeName, count: c });
      }
    }
    return rows;
  }

  function compare(){
    cmpArea.innerHTML = '';
    let A, B;
    try { A = safeJsonParse(inA.value); } catch(e) { cmpArea.textContent = 'AのJSONが読めません: ' + e.message; return; }
    try { B = safeJsonParse(inB.value); } catch(e) { cmpArea.textContent = 'BのJSONが読めません: ' + e.message; return; }

    const aS = scoreSummary(A);
    const bS = scoreSummary(B);

    const master = (aS.score >= bS.score) ? 'A' : 'B';
    const masterWhy = (master === 'A')
      ? `Aの方が多い（records ${fmt(aS.recordCount)} vs ${fmt(bS.recordCount)} / localStorageKeys ${fmt(aS.localStorageKeys)} vs ${fmt(bS.localStorageKeys)}）`
      : `Bの方が多い（records ${fmt(bS.recordCount)} vs ${fmt(aS.recordCount)} / localStorageKeys ${fmt(bS.localStorageKeys)} vs ${fmt(aS.localStorageKeys)}）`;

    const aRows = flattenStores(A);
    const bRows = flattenStores(B);
    const key = (r)=> `${r.dbName}::${r.storeName}`;
    const mapA = new Map(aRows.map(r=> [key(r), r]));
    const mapB = new Map(bRows.map(r=> [key(r), r]));
    const keys = Array.from(new Set([...mapA.keys(), ...mapB.keys()])).sort();

    let html = '';
    html += `<div class="mono">MASTER提案: <b>${master}</b> <span class="badge ${master==='A'?'b-ok':'b-warn'}">生（master）候補</span></div>`;
    html += `<div class="note">理由: ${masterWhy}</div>`;
    html += `<div class="hr"></div>`;
    html += `<table class="tbl">
      <thead><tr>
        <th>DB / Store</th>
        <th class="right">A件数</th>
        <th class="right">B件数</th>
        <th class="right">差（A-B）</th>
      </tr></thead><tbody>`;

    for (const k of keys) {
      const ar = mapA.get(k);
      const br = mapB.get(k);
      const ac = (ar && typeof ar.count === 'number') ? ar.count : 0;
      const bc = (br && typeof br.count === 'number') ? br.count : 0;
      const diff = ac - bc;
      const tag = (diff===0) ? '' : (diff>0 ? ' style="color:#a5d6a7;"' : ' style="color:#ef9a9a;"');
      html += `<tr>
        <td class="k">${k}</td>
        <td class="right">${fmt(ac)}</td>
        <td class="right">${fmt(bc)}</td>
        <td class="right"${tag}>${diff===0? '0' : (diff>0? '+'+fmt(diff): fmt(diff))}</td>
      </tr>`;
    }
    html += `</tbody></table>`;
    html += `<div class="hr"></div>`;
    html += `<div class="note">
      次の手順：<br>
      1) MASTER側URLで <b>migrate-tool.html</b> を開く → Export（JSON保存）<br>
      2) 反対側URLで migrate-tool.html → Import（読み込み）<br>
      3) 取り込み後に、もう一度この比較で「差がほぼ0」になったか確認
    </div>`;

    html += `<div class="hr"></div>`;
    html += `<div class="mono"><b>localStorage</b></div>`;
    html += `<table class="tbl"><tbody>
      <tr><th>A keys</th><td class="right">${fmt(aS.localStorageKeys)}</td><th>B keys</th><td class="right">${fmt(bS.localStorageKeys)}</td></tr>
      <tr><th>A chars</th><td class="right">${fmt(aS.localStorageChars)}</td><th>B chars</th><td class="right">${fmt(bS.localStorageChars)}</td></tr>
    </tbody></table>`;

    cmpArea.innerHTML = html;
  }

  btnScan.addEventListener('click', ()=> scan());
  btnCopy.addEventListener('click', ()=> copySummary());
  btnCompare.addEventListener('click', ()=> compare());
  btnSwap.addEventListener('click', ()=> { const tmp = inA.value; inA.value = inB.value; inB.value = tmp; });
  btnClear.addEventListener('click', ()=> { inA.value=''; inB.value=''; cmpArea.textContent=''; });

  const hdrNow = document.getElementById('hdrNow');
  setInterval(()=>{
    hdrNow.textContent = new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }) + ' JST';
  }, 15000);

  outText.textContent = '①を押すと、このURLに残っているIndexedDB/localStorageを点検します。\\n';
})();
</script>
</body>
</html>
