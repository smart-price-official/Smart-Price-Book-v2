<!DOCTYPE html>
<!--
APP: Smart Price
VERSION: v19.9.45
P26-02-08 20:45 JST
TITLE: è¨­å®šç”»é¢çµ±åˆç‰ˆï¼ˆé‹å–¶è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼/ç´¹ä»‹ãƒ»å®¶æ—å…±æœ‰/ãŠå•ã„åˆã‚ã›/æœªç¢ºå®šå“ç®¡ç†/æ¤œè¨¼ãƒ„ãƒ¼ãƒ«ï¼‰
CHANGES:
- è¨­å®šç”»é¢ã«ã€Œå‹äººç´¹ä»‹ï¼å®¶æ—å…±æœ‰ã€ã€Œé‹å–¶è€…ã¸è³ªå•ï¼ä¸å…·åˆå ±å‘Šã€ã€Œé‹å–¶è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆadminæ™‚ã®ã¿ï¼‰ã€ã‚’çµ±åˆï¼ˆUI_FREEZE: ç”»é¢è¿½åŠ ãªã—ï¼‰
- Firebase URLã¯é€šå¸¸ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«éè¡¨ç¤ºã€adminæ™‚ã®ã¿èª­ã¿å–ã‚Šå°‚ç”¨ã§è¡¨ç¤º
- ãŠå•ã„åˆã‚ã›ã‚’localStorageã«ä¿å­˜ï¼ˆæœ€å¤§50ä»¶ï¼‰ã—ã€adminã§ä¸€è¦§ãƒ»ã‚³ãƒ”ãƒ¼
- æœªç¢ºå®šå•†å“ï¼ˆæ˜¨æ—¥åˆ†ï¼šå•†å“å/ãƒ¡ãƒ¼ã‚«ãƒ¼/ç”»åƒã®æ¬ è½ï¼‰ã‚’adminã§è£œå®Œãƒ»ç¢ºå®š
- è‡ªå·±æ¤œè¨¼ï¼ˆVERSION/BUILD/config/ä¸»è¦é–¢æ•°ï¼‰ã‚’è¨­å®šå†…ã«è¿½åŠ 
BUILD_PARAM(b): ?b=2026-02-08_2045_initfix_exportimport_nofb
DEBUG_PARAM: &debug=1
POLICY: UI_FREEZE / å˜ä¸€HTML / VERSION SSOT
-->
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#D50000">
  <title>Smart Price v19.9.45</title>
  <!-- âœ… VERSIONæƒ…å ±ã‚’æœ€å„ªå…ˆã§å®šç¾©ï¼ˆBOOT PROBEã‚ˆã‚Šå…ˆã«èª­ã¿è¾¼ã‚€ï¼‰ -->
  <script>
    window.VERSION_INFO = 'v19.9.51';
    window.APP_VERSION = 'v19.9.45';
    window.FULL_VERSION = 'v19.9.45 [0207]';
    P26-02-08_2045_initfix_exportimport_nofb';
  </script>
  <!-- âœ… SW RESET TOOL (v19.9.45) : ?reset=sw -->
  <script>
  (function() {
    try {
      var params = new URLSearchParams(location.search);
      if (params.get('reset') === 'sw') {
        // remove reset to avoid loops
        params.delete('reset');
        var target = location.pathname + (params.toString() ? ('?' + params.toString()) : '');
        var showMsg = params.has('debug');

        function showOverlay() {
          if (!showMsg) return;
          try {
            var ov = document.createElement('div');
            ov.id = 'sw-reset-overlay';
            ov.style.cssText =
              'position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:999999;' +
              'display:flex;align-items:center;justify-content:center;padding:24px;';
            var box = document.createElement('div');
            box.style.cssText =
              'background:#1e1e1e;color:#fff;padding:22px 18px;border-radius:14px;' +
              'border:2px solid #00c853;max-width:420px;width:100%;text-align:center;';
            box.innerHTML =
              '<div style="font-size:1.25rem;font-weight:700;margin-bottom:10px;">âœ… æ›´æ–°ãƒ„ãƒ¼ãƒ«å®Ÿè¡Œä¸­</div>' +
              '<div style="color:#bbb;font-size:0.92rem;line-height:1.5;">' +
              'Service Worker ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ã¦ã„ã¾ã™ã€‚<br>è‡ªå‹•ã§æœ€æ–°ã‚’èª­ã¿è¾¼ã¿ã¾ã™â€¦' +
              '</div>';
            ov.appendChild(box);
            document.documentElement.appendChild(ov);
          } catch(e) {}
        }

        (async function() {
          showOverlay();
          try {
            // 1) unregister SW
            if ('serviceWorker' in navigator) {
              var regs = await navigator.serviceWorker.getRegistrations();
              for (var i=0; i<regs.length; i++) {
                try { await regs[i].unregister(); } catch(e) {}
              }
            }
            // 2) delete caches
            if (window.caches && caches.keys) {
              var keys = await caches.keys();
              for (var k=0; k<keys.length; k++) {
                try { await caches.delete(keys[k]); } catch(e) {}
              }
            }
          } catch(e) {
            // no alert (UI_FREEZE). debug only: console
            try { console.warn('[SW-RESET] failed', e); } catch(_e) {}
          } finally {
            // 3) redirect without reset
            try { location.replace(target); } catch(e) { location.href = target; }
          }
        })();
      }
    } catch(e) {
      // ignore
    }
  })();
  </script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <style>
    body { font-family: sans-serif; background-color: #121212; color: #e0e0e0; padding-bottom: 90px; touch-action: manipulation; }
    .header { background: linear-gradient(135deg, #D50000, #9b0000); padding: 12px 15px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
    .v-badge { background: #ff5252; color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; margin-left: 10px; font-weight: bold; }
    .store-area { background: #1e1e1e; padding: 10px; border-bottom: 1px solid #333; min-height: 55px; }
    .store-list { display: flex; overflow-x: auto; gap: 8px; padding: 5px 0; -webkit-overflow-scrolling: touch; }
    .store-tag { padding: 6px 14px; border: 1px solid #444; border-radius: 20px; white-space: nowrap; font-size: 0.85rem; background: #2c2c2c; color: #ccc; }
    .store-tag.active { background: #D50000; color: white; border-color: #D50000; }
    .store-tag.gps-btn { border: 1px solid #ff5252; color: #ff5252; }
    .store-tag.gps-btn.on { background: #ff5252; color: white; }
    .store-tag.add-store { border: 1px dashed #777; color: #ddd; background: #262626; }
    .store-tag.add-store:active { background: #333; }
    .gps-status { font-size: 0.6rem; margin-left: 4px; opacity: 0.9; }

    .card { background-color: #1e1e1e; border: 1px solid #333; margin-bottom: 10px; border-radius: 12px; overflow: hidden; }
    .price-card { padding: 12px; border-left: 4px solid #444; cursor: pointer; }
    .price-card.cheap { border-left-color: #ff5252; background: linear-gradient(90deg, #2a1a1a 0%, #1e1e1e 100%); }
    .prod-thumb { width: 68px; height: 68px; object-fit: contain; background: #fff; border-radius: 8px; margin-right: 12px; }

    .price-main { font-size: 1.25rem; font-weight: bold; color: #fff; line-height: 1; }
    .stats-strip { display: flex; flex-direction: column; background: #262626; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.75rem; border: 1px solid #333; }
    .stats-row { display: flex; justify-content: space-around; width: 100%; }
    .stat-item { text-align: center; flex: 1; color: #aaa; }
    .stat-val { display: block; font-weight: bold; color: #fff; font-size: 0.9rem; }

    .history-row { font-size: 0.8rem; padding: 10px 0; border-top: 1px solid #333; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
    
    /* âœ… P0: è³¼å…¥å±¥æ­´é¸æŠæ™‚ã®èµ¤æ ã‚’#priceSectionã¨åŒã˜ä»•æ§˜ã¸çµ±ä¸€ */
    .selected {
      border: 1px solid #ff5252 !important;
      border-radius: 12px !important; /* è§’ä¸¸çµ±ä¸€ï¼ˆä»–ã‚«ãƒ¼ãƒ‰ã¨åŒã˜åŠå¾„ï¼‰ */
      background: rgba(213,0,0,0.12);
      box-sizing: border-box !important; /* æ ã‚ºãƒ¬äºˆé˜² */
      max-width: 100% !important; /* æ ã‚ºãƒ¬äºˆé˜² */
      overflow: hidden !important; /* æ ã‚ºãƒ¬äºˆé˜² */
      padding: 12px !important; /* å·¦å³ä½™ç™½ï¼ˆæ ç·šã«å¯¾ã—ã¦æƒ…å ±ãŒè¿‘ã™ãã‚‹ã®ã‚’è§£æ¶ˆï¼‰ */
      margin: 0 !important; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ */
    }

    #camera-area { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; background: black; z-index: 2000; }
    #interactive { width: 100%; height: 100%; position: relative; }
    #interactive video { width: 100%; height: 100%; object-fit: cover; }
    /* âœ… ã‚¹ã‚­ãƒ£ãƒŠç”»é¢ï¼šåˆã‚ã›çª“ï¼ˆè§’ä¸¸ã‚¬ã‚¤ãƒ‰æ ï¼‰- æ—¢å­˜UIã¨çµ±ä¸€ */
    .scan-frame { 
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%); 
      width: 280px; 
      height: 180px; 
      z-index: 2001; /* videoã‚ˆã‚Šå‰é¢ã«å›ºå®š */
      box-shadow: 0 0 0 4000px rgba(0,0,0,0.65); /* å‘¨å›²ã‚’æš—ãã™ã‚‹ */
      border: 2px solid #ff5252; /* ç·šå¹…ã‚’çµ±ä¸€ï¼ˆ2pxï¼‰ */
      border-radius: 12px; /* è§’ä¸¸ã‚’çµ±ä¸€ï¼ˆcardã¨åŒã˜ï¼‰ */
      display: block; /* å¿…ãšè¡¨ç¤º */
      pointer-events: none; /* ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆç„¡è¦– */
    }
    
    /* âœ… ã‚¹ã‚­ãƒ£ãƒ³ãƒãƒ¼ï¼ˆèµ°æŸ»ãƒ©ã‚¤ãƒ³ï¼‰- DOMè¦ç´ ã§ç¢ºå®Ÿè¡¨ç¤º */
    .scan-laser { 
      position: absolute; 
      top: 15%; /* åˆæœŸä½ç½® */
      left: 5%; 
      width: 90%; 
      height: 3px; /* å°‘ã—å¤ªã‚ã«ï¼ˆè¦–èªæ€§å‘ä¸Šï¼‰ */
      background: linear-gradient(180deg, rgba(255,0,0,0.3), rgba(255,0,0,1), rgba(255,0,0,0.3)); /* ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã§ç«‹ä½“æ„Ÿ */
      box-shadow: 
        0 0 8px 1px rgba(255,0,0,0.8), 
        0 0 15px 3px rgba(255,0,0,0.5); /* ã‚°ãƒ­ãƒ¼åŠ¹æœ */
      animation: scan-move 2s infinite ease-in-out; 
      z-index: 2002; /* scan-frameã‚ˆã‚Šå‰é¢ */
      border-radius: 2px; 
      will-change: transform; /* ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– */
      pointer-events: none; /* ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆç„¡è¦– */
      transform: translateZ(0); /* ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã‚¢ã‚¯ã‚»ãƒ©ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æœ‰åŠ¹åŒ– */
      backface-visibility: hidden; /* ã¡ã‚‰ã¤ãé˜²æ­¢ */
    }
    
    /* âœ… ã‚¹ã‚­ãƒ£ãƒ³ãƒãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ - ã‚·ãƒ³ãƒ—ãƒ«ãƒ»ç¢ºå®Ÿ */
    @keyframes scan-move { 
      0% { 
        top: 15%; 
        opacity: 0.6; 
      } 
      50% { 
        top: 82%; /* ä¸‹ç«¯ä»˜è¿‘ã¾ã§ */
        opacity: 1; 
      } 
      100% { 
        top: 15%; 
        opacity: 0.6; 
      } 
    }

    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; justify-content: center; align-items: center; }
    .modal-content { background: #1e1e1e; padding: 25px; border-radius: 20px; width: 95%; max-width: 450px; border: 1px solid #D50000; }

    .toast-container{
  position: fixed;
  top: auto;
  bottom: 110px; /* fallback */
  left: 50%;
  transform: translateX(-50%);
  width: min(92vw, 420px);
  z-index: 5000;
  pointer-events: none;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.toast-item{
  background: rgba(50,50,50,0.95);
  color: #fff;
  padding: 10px 14px;
  border-radius: 14px;
  font-size: 0.88rem;
  line-height: 1.25;
  border: 1px solid #777;
  box-shadow: 0 4px 15px rgba(0,0,0,0.5);
  opacity: 0;
  transform: translateY(-6px);
  transition: opacity .18s ease, transform .18s ease;
  word-break: break-word;
  white-space: pre-wrap;
}
.toast-item.show{
  opacity: 1;
  transform: translateY(0);
}
.toast-item.small{
  font-size: 0.82rem;
  padding: 9px 12px;
}

    .city-chips { display: flex; overflow-x: auto; gap: 5px; padding: 5px 0; margin-bottom: 10px; -webkit-overflow-scrolling: touch; }
    .city-chip { font-size: 0.75rem; padding: 4px 12px; border-radius: 15px; background: #333; color: #ccc; border: 1px solid #555; white-space: nowrap; cursor: pointer; }
    .city-chip:active { background: #D50000; color: white; }

    .url-box { font-size: 0.9rem; padding: 12px; border-radius: 12px; }
    .hint { font-size: 0.75rem; color: #aaa; line-height: 1.4; }

    /* âœ… ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ« - é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ä»˜ãã€ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ */
    #debug-panel {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      width: 92%;
      max-width: 820px;
      background: rgba(0,0,0,0.92);
      color: #9ff;
      font: 11px/1.5 monospace;
      padding: 10px 12px 12px 12px;
      border-radius: 8px;
      z-index: 99999;
      border: 1px solid #ff5252;
      box-shadow: 0 4px 20px rgba(255,0,0,0.3);
      max-height: 60vh;
      overflow-y: auto;
      display: none;
      pointer-events: none;
    }
    #debug-panel.show {
      display: block;
      pointer-events: auto;
    }
    #debug-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid #444;
    }
    #debug-panel-title {
      color: #ff5252;
      font-weight: bold;
      font-size: 12px;
    }
    #debug-panel-close {
      background: #ff5252;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 2px 8px;
      cursor: pointer;
      font-size: 11px;
      font-family: monospace;
    }
    #debug-panel-close:hover {
      background: #ff1744;
    }
    #debug-panel-content {
      font-size: 11px;
    }
    #debug-panel-content div {
      margin-bottom: 2px;
    }
    #debug-panel-content b {
      color: #ffeb3b;
    }

    /* âœ… ãƒ‡ãƒãƒƒã‚°ãƒœã‚¿ãƒ³ - å³ä¸‹å›ºå®š */
    #debug-toggle-btn {
      position: fixed;
      bottom: 120px;
      right: 15px;
      width: 50px;
      height: 50px;
      background: rgba(213,0,0,0.9);
      color: white;
      border: 2px solid #ff5252;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 99998;
      font-size: 18px;
      font-weight: bold;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      display: none;
    }
    #debug-toggle-btn.show {
      display: flex;
    }
    #debug-toggle-btn:active {
      transform: scale(0.95);
    }
  </style>
</head>

<body>
<header class="header d-flex justify-content-between align-items-center">
   <h5 class="m-0 fw-bold text-white"><i class="bi bi-cart4"></i> Smart Price <span class="v-badge" id="version-badge">v19.9.45</span></h5>
  <button class="btn btn-sm btn-outline-light" onclick="openSettings()"><i class="bi bi-gear-fill"></i></button>
</header>

<div class="store-area"><div id="store-list" class="store-list"></div></div>

<div class="container p-3">
  <div id="mainView">
    <div class="row g-2 mb-4">
      <div class="col-7"><button id="scanBtnTop" class="btn btn-danger w-100 py-3 rounded-4 shadow" onclick="startScanner()"><i class="bi bi-upc-scan fs-1"></i><br>ã‚¹ã‚­ãƒ£ãƒ³</button></div>
      <div class="col-5"><button class="btn btn-dark w-100 py-3 rounded-4 border-secondary shadow" onclick="showVeggieMenu()"><i class="bi bi-keyboard fs-1"></i><br>æ‰‹å…¥åŠ›</button></div>
    </div>
    <div id="historyList"></div>
  </div>

  <div id="formView" style="display:none;">
    <div class="card p-3 shadow-lg">
      <div id="curStoreIndicator" class="text-danger small fw-bold mb-2 text-center" style="opacity:0.8;"></div>

      <div class="text-center mb-2">
        <button id="storeJumpBtn" class="btn btn-sm btn-outline-secondary w-100" style="display:none;" onclick="jumpToStoreChips()">åº—åã‚’å¤‰æ›´ï¼ˆä¸Šã«ç§»å‹•ï¼‰</button>
      </div>

      <div id="formMainUI">
        <div class="d-flex mb-3">
          <div style="position:relative; width:90px; height:90px; margin-right:12px;">
            <img id="previewImg" style="width:100%; height:100%; object-fit:contain; background:white; border-radius:10px;">
            <div class="position-absolute bottom-0 start-0 w-100 d-flex justify-content-between px-1 pb-1">
              <button class="btn btn-dark btn-sm p-1 opacity-75" onclick="document.getElementById('imgInput').click()"><i class="bi bi-folder2-open"></i></button>
              <button class="btn btn-dark btn-sm p-1 opacity-75" onclick="searchImageWeb()"><i class="bi bi-search"></i></button>
            </div>
            <input type="file" id="imgInput" accept="image/*" style="display:none;" onchange="handleImage(this)">
          </div>
          <div class="flex-grow-1">
            <input type="text" id="inputName" class="form-control bg-dark text-white border-secondary mb-2" placeholder="å•†å“åï¼ˆå†…å®¹é‡ï¼‰">
            <select id="inputCategory" class="form-control bg-dark text-white border-secondary mb-2" style="font-size:0.85rem; padding:4px;"></select>
            <!-- âœ… ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªå¾©æ´»ï¼ˆæœ€å°UIï¼‰ -->
            <select id="inputSubCategory" class="form-control bg-dark text-white border-secondary mb-2" style="font-size:0.85rem; padding:4px; display:none;"></select>
            <input type="text" id="inputMaker" class="form-control bg-dark text-white border-secondary py-1" style="font-size:0.85rem;" placeholder="ãƒ¡ãƒ¼ã‚«ãƒ¼å">
          </div>
        </div>

        <div id="priceSection" class="mb-3 p-3 border rounded border-danger" style="background:#1a1a1a; border-width: 1px !important; box-sizing: border-box; max-width: 100%; overflow: hidden; padding: 12px !important;">
          <div id="calcOptionArea" class="d-flex align-items-center mb-2">
            <div class="btn-group btn-group-sm w-100 me-2">
              <input type="radio" class="btn-check" name="taxMode" id="taxEx" value="ex" checked>
              <label class="btn btn-outline-danger" for="taxEx">ç¨åˆ¥</label>
              <input type="radio" class="btn-check" name="taxMode" id="taxIn" value="in">
              <label class="btn btn-outline-danger" for="taxIn">ç¨è¾¼</label>
            </div>
            <div class="input-group input-group-sm w-50">
              <input type="number" id="inputDisc" class="form-control bg-dark text-white border-secondary" placeholder="0">
              <span class="input-group-text bg-dark text-secondary border-secondary">%å¼•</span>
            </div>
          </div>
          <input type="number" id="inputPrice" class="form-control text-end fw-bold text-danger border-0 bg-transparent fs-1" placeholder="0">
        </div>

        <div id="statsBox" class="stats-strip"></div>
        <div id="detailHistory" class="mb-3" style="display:none;"></div>

        <div class="text-center mb-3">
          <button id="toggleHistBtn" class="btn btn-sm btn-outline-secondary w-100" onclick="toggleHistoryList()">è³¼å…¥å±¥æ­´ã‚’è¡¨ç¤ºï¼ˆã‚¿ãƒƒãƒ—ã§ç·¨é›†ï¼‰</button>
        </div>

        <div class="d-flex gap-2 mb-3">
          <button id="delHistBtn" class="btn btn-outline-secondary py-3 fw-bold flex-grow-0 px-3 shadow" style="display:none;" onclick="confirmDeleteHist()">å‰Šé™¤</button>
          <button id="saveBtn" class="btn btn-danger py-3 fw-bold fs-5 shadow flex-grow-1" onclick="saveData()">ä¿å­˜</button>
        </div>
      </div>

      <button class="btn btn-link text-secondary w-100" onclick="showHome()">æˆ»ã‚‹</button>
    </div>
  </div>
</div>

<div id="camera-area">
  <div id="interactive">
    <!-- scan-frame ã¨ scan-laser ã¯å‹•çš„ç”Ÿæˆï¼ˆensureScanbarDom()ã§ç”Ÿæˆï¼‰ -->
  </div>
  <button onclick="stopScanner()" class="btn btn-danger position-absolute top-0 end-0 m-4 fs-3 shadow-lg">Ã—</button>
</div>

<div id="dialogModal" class="modal">
  <div class="modal-content text-center">
    <h6 id="dialogTitle" class="text-secondary mb-3">Smart Price</h6>
    <p id="dialogMsg" class="text-white mb-4"></p>
    <div id="dialogInputArea" style="display:none;"><input type="text" id="dialogInput" class="form-control bg-dark text-white mb-3"></div>
    <div class="d-flex gap-2">
      <button id="dialogCancel" class="btn btn-dark flex-grow-1" style="display:none;">ã‚„ã‚ã‚‹</button>
      <button id="dialogOk" class="btn btn-danger flex-grow-1">OK</button>
    </div>
  </div>
</div>

<div id="settingsModal" class="modal">
  <div class="modal-content">
    <h5 class="text-white mb-4 text-center">è¨­å®š</h5>

    <div class="mb-3">
      <label class="small text-secondary">ç”Ÿæ´»åœï¼ˆå¸‚ï¼‰</label>
      <input type="text" id="home-city-input" class="form-control bg-dark text-white border-secondary mb-1" placeholder="ä¾‹ï¼šåœŸæµ¦å¸‚ã€ã¤ãã°å¸‚">
      <div class="small text-secondary" style="opacity:.9;">è¤‡æ•°ã®å ´åˆã¯ã€Œã€ã€ã§åŒºåˆ‡ã£ã¦ãã ã•ã„</div>
      <div id="city-history-chips" class="city-chips"></div>
    </div>

    <details id="referralDetails" class="mb-3">
      <summary class="small text-secondary" style="cursor:pointer;">å‹äººç´¹ä»‹ï¼å®¶æ—å…±æœ‰</summary>
      <div class="mt-2">
        <div class="small text-secondary mb-1">ã‚ãªãŸã®ç´¹ä»‹ID</div>
        <div class="d-flex gap-2 mb-2">
          <input id="ref-my-id" class="form-control bg-dark text-white border-secondary" readonly>
          <button class="btn btn-dark" onclick="spCopy('ref-my-id')">ã‚³ãƒ”ãƒ¼</button>
        </div>

        <div class="small text-secondary mb-1">ç´¹ä»‹ãƒªãƒ³ã‚¯</div>
        <textarea id="ref-link" class="form-control bg-dark text-white border-secondary url-box mb-2" rows="2" readonly></textarea>

        <div class="d-flex gap-2 mb-3">
          <button class="btn btn-dark flex-grow-1" onclick="spCopy('ref-link')">ã‚³ãƒ”ãƒ¼</button>
          <button class="btn btn-danger flex-grow-1" onclick="spShareReferral()">å…±æœ‰</button>
        </div>

        <div class="small text-secondary mb-1">å®¶æ—å…±æœ‰ã‚³ãƒ¼ãƒ‰ï¼ˆä»»æ„ï¼‰</div>
        <div class="d-flex gap-2 mb-2">
          <input id="family-code-input" class="form-control bg-dark text-white border-secondary" placeholder="ä¾‹ï¼šFAMILY-001">
          <button class="btn btn-warning" onclick="spSaveFamilyCode()">ä¿å­˜</button>
        </div>
        <div id="family-code-status" class="small text-secondary"></div>

        <div id="ref-from-status" class="small text-secondary mt-2" style="opacity:.9;"></div>
      </div>
    </details>

    <details id="supportDetails" class="mb-3">
      <summary class="small text-secondary" style="cursor:pointer;">é‹å–¶è€…ã¸è³ªå•ï¼ä¸å…·åˆå ±å‘Š</summary>
      <div class="mt-2">
        <label class="small text-secondary">ç—‡çŠ¶ï¼ˆä½•ãŒèµ·ããŸã‹ï¼‰</label>
        <textarea id="support-symptom" class="form-control bg-dark text-white border-secondary mb-2" rows="3" placeholder="ä¾‹ï¼šãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿è¾¼ã¿å¾Œã€å•†å“åãŒé•ã†â€¦"></textarea>

        <div class="row g-2">
          <div class="col-6">
            <label class="small text-secondary">æ©Ÿç¨®</label>
            <input id="support-device" class="form-control bg-dark text-white border-secondary mb-2" placeholder="ä¾‹ï¼šPixel 9">
          </div>
          <div class="col-6">
            <label class="small text-secondary">OS</label>
            <input id="support-os" class="form-control bg-dark text-white border-secondary mb-2" placeholder="ä¾‹ï¼šAndroid 15">
          </div>
        </div>

        <label class="small text-secondary">ãƒ–ãƒ©ã‚¦ã‚¶</label>
        <input id="support-browser" class="form-control bg-dark text-white border-secondary mb-2" placeholder="ä¾‹ï¼šChrome / Edge">

        <label class="small text-secondary">ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆï¼ˆä»»æ„ï¼‰</label>
        <input id="support-screens" type="file" accept="image/*" multiple class="form-control bg-dark text-white border-secondary mb-2">
        <div id="support-preview" class="d-flex flex-wrap gap-2 mb-2"></div>

        <div class="d-flex gap-2 mb-2">
          <button class="btn btn-dark flex-grow-1" onclick="spCopySupport()">å†…å®¹ã‚³ãƒ”ãƒ¼</button>
          <button class="btn btn-danger flex-grow-1" onclick="spShareSupport()">å…±æœ‰</button>
        </div>
        <div class="d-flex gap-2 mb-2">
          <button class="btn btn-warning w-100" onclick="spSaveSupport()">ä¿å­˜</button>
        </div>

        <div class="hint" style="margin:0;">â€»ã‚³ãƒ”ãƒ¼ã—ãŸæ–‡ç« ã«ã€å¿…è¦ãªã‚‰ã‚¹ã‚¯ã‚·ãƒ§ã‚‚æ·»ãˆã¦é€ã£ã¦ãã ã•ã„ã€‚</div>
      </div>
    </details>

    <details id="operatorDetails" class="mb-3">
      <summary class="small text-secondary" style="cursor:pointer;">é‹å–¶è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼</summary>
      <div class="mt-2">
        <div id="operatorNote" class="hint mb-2">â€»é‹å–¶è€…ãƒ¢ãƒ¼ãƒ‰ï¼ˆURLã« <b>&amp;mode=admin</b> ï¼‰ã§æœ‰åŠ¹åŒ–ã•ã‚Œã¾ã™ã€‚</div>

        <div id="operatorEnabled" style="display:none;">
          <div class="mb-2">
            <div class="small text-secondary mb-1">Firebase URLï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰</div>
            <div class="d-flex gap-2">
              <input type="text" id="fb-url-input" class="form-control bg-dark text-white border-secondary" readonly>
              <button class="btn btn-dark" onclick="spCopy('fb-url-input')">ã‚³ãƒ”ãƒ¼</button>
            </div>
          </div>

          <details class="mb-2">
            <summary class="small text-secondary" style="cursor:pointer;">æœªç¢ºå®šå•†å“ï¼ˆæ˜¨æ—¥åˆ†ï¼‰</summary>
            <div class="mt-2">
              <div id="admin-unconfirmed-list" class="small"></div>
              <button class="btn btn-warning w-100 py-2 fw-bold mt-2" onclick="spConfirmUnconfirmedAll()">ã¾ã¨ã‚ã¦ç¢ºå®š</button>
            </div>
          </details>

          <details class="mb-2">
            <summary class="small text-secondary" style="cursor:pointer;">ãŠå•ã„åˆã‚ã›å±¥æ­´</summary>
            <div class="mt-2" id="admin-support-list" class="small"></div>
          </details>

          <details class="mb-2">
            <summary class="small text-secondary" style="cursor:pointer;">æ¤œè¨¼ãƒ„ãƒ¼ãƒ«</summary>
            <div class="mt-2">
              <button class="btn btn-outline-secondary w-100 py-2 fw-bold mb-2" onclick="spRunSelfCheck()">æ¤œè¨¼ã™ã‚‹</button>
              <textarea id="selfcheck-log" class="form-control bg-dark text-white border-secondary" rows="6" readonly></textarea>
              <div class="d-flex gap-2 mt-2">
                <button class="btn btn-dark flex-grow-1" onclick="spCopy('selfcheck-log')">ãƒ­ã‚°ã‚³ãƒ”ãƒ¼</button>
              </div>
            </div>
          </details>
        </div>
      </div>
    </details>

    <button id="syncBtn" class="btn btn-warning w-100 py-3 fw-bold mb-2 shadow" onclick="startMigration()">è¨­å®šä¿å­˜ã¨åŒæœŸ</button>
    <button class="btn btn-outline-secondary w-100 py-2 fw-bold mb-2" onclick="openWebModal()">ãƒ–ãƒ©ã‚¦ã‚¶ç‰ˆã¸ï¼ˆURLè¡¨ç¤ºï¼‰</button>
    <div id="debugBackupButtons" style="display:none;">
      <button class="btn btn-success w-100 py-2 fw-bold mb-2" onclick="exportBackup()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‡ºåŠ›</button>
      <button class="btn btn-info w-100 py-2 fw-bold mb-2" onclick="importBackup()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—èª­ã¿è¾¼ã¿</button>
    </div>
    <button class="btn btn-link text-secondary w-100" onclick="closeSettings()">é–‰ã˜ã‚‹</button>
  </div>
</div>

</div>

<div id="webModal" class="modal">
  <div class="modal-content">
    <h5 class="text-white mb-3 text-center">ãƒ–ãƒ©ã‚¦ã‚¶ç‰ˆï¼ˆURLï¼‰</h5>
    <div class="hint mb-3">
      ãƒ»PWAï¼ˆãƒ›ãƒ¼ãƒ è¿½åŠ ï¼‰ã ã¨ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒè¦‹ãˆãªã„ã®ã§ã€ã“ã“ã§URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦Chrome/Edgeã§é–‹ã‘ã¾ã™ã€‚<br>
      ãƒ»æ›´æ–°ç¢ºèªã¯ <b>ã¾ãšãƒ–ãƒ©ã‚¦ã‚¶ã§</b> é–‹ãã®ãŒå®‰å…¨ã§ã™ã€‚
    </div>

    <label class="small text-secondary">é€šå¸¸URLï¼ˆã‚³ãƒ”ãƒ¼ã—ã¦é–‹ãï¼‰</label>
    <textarea id="webUrlNormal" class="form-control bg-dark text-white border-secondary url-box mb-2" rows="2" readonly></textarea>
    <div class="d-flex gap-2 mb-3">
      <button class="btn btn-dark flex-grow-1" onclick="copyUrl('webUrlNormal')">ã‚³ãƒ”ãƒ¼</button>
      <button class="btn btn-danger flex-grow-1" onclick="openUrlFromBox('webUrlNormal')">é–‹ã</button>
    </div>

    <label class="small text-secondary">ãƒ‡ãƒãƒƒã‚°URLï¼ˆ&debug=1ï¼‰</label>
    <textarea id="webUrlDebug" class="form-control bg-dark text-white border-secondary url-box mb-2" rows="2" readonly></textarea>
    <div class="d-flex gap-2 mb-3">
      <button class="btn btn-dark flex-grow-1" onclick="copyUrl('webUrlDebug')">ã‚³ãƒ”ãƒ¼</button>
      <button class="btn btn-danger flex-grow-1" onclick="openUrlFromBox('webUrlDebug')">é–‹ã</button>
    </div>

    <div class="hint mb-3" style="background:#1a1a1a; padding:10px; border-radius:8px; border:1px solid #333;">
      <b style="color:#ff5252;">ğŸ“± ã‚¢ãƒ—ãƒªã¨ã—ã¦ä½¿ã†ï¼ˆPWAï¼‰</b><br>
      <span style="font-size:0.7rem; color:#aaa;">
      <b>Androidï¼ˆChrome/Edgeï¼‰ï¼š</b> ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã â†’ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆâ‹®ï¼‰â†’ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€<br>
      <b>iOSï¼ˆSafariï¼‰ï¼š</b> ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã â†’ å…±æœ‰ãƒœã‚¿ãƒ³ï¼ˆâ–¡â†‘ï¼‰â†’ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€<br>
      <b>æ›´æ–°ãŒåæ˜ ã•ã‚Œãªã„æ™‚ï¼š</b> ãƒ›ãƒ¼ãƒ ç”»é¢ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‰Šé™¤ â†’ å†åº¦è¿½åŠ ã—ã¦ãã ã•ã„
      </span>
    </div>

    <!-- âœ… PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ï¼ˆbeforeinstallpromptãŒã‚ã‚‹æ™‚ã ã‘è¡¨ç¤ºï¼‰ -->
    <button id="pwaInstallBtn" class="btn btn-danger w-100 mb-2" style="display:none;" onclick="installPWA()">
      ğŸ“± ä»Šã™ãã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    </button>

    <button class="btn btn-link text-secondary w-100" onclick="closeWebModal()">æˆ»ã‚‹</button>
  </div>
</div>

<div id="toast-container" class="toast-container" aria-live="polite" aria-atomic="true"></div>
<!-- âœ… P0: debug=1ã®ã¨ãã ã‘æœ€çµ‚ã‚¨ãƒ©ãƒ¼ã‚’å›ºå®šè¡¨ç¤º -->
<div id="debug-error-display" style="display:none; position:fixed; top:10px; right:10px; background:rgba(255,0,0,0.9); color:#fff; padding:8px 12px; border-radius:5px; font-size:0.75rem; z-index:99997; max-width:300px; word-break:break-word; box-shadow:0 2px 10px rgba(0,0,0,0.5); border:2px solid #ff0000;"></div>

<!-- Firebase SDK (v9 compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
  const APP_VERSION = "v19.9.45"; // ç”»é¢è¡¨ç¤ºç”¨ï¼ˆæ•°å­—ã®ã¿ï¼‰ // ç”»é¢è¡¨ç¤ºç”¨ï¼ˆæ•°å­—ã®ã¿ï¼‰
  const FULL_VERSION = "v19.9.45 [0207]"; // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆè©³ç´°ï¼‰ // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼ˆè©³ç´°ï¼‰
  P26-02-08_2045_initfix_exportimport_nofb"; // ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ä¸€è‡´ã•ã›ã‚‹

  // ========= Firebase Configuration =========
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyCYjQ79KgsohOPlEViHBX5BygVUvX-70l4",
    authDomain: "smartpricedb.firebaseapp.com",
    databaseURL: "https://smartpricedb-default-rtdb.firebaseio.com",
    projectId: "smartpricedb",
    storageBucket: "smartpricedb.firebasestorage.app",
    messagingSenderId: "892635601514",
    appId: "1:892635601514:web:3a496e522a9972e8de0813",
    measurementId: "G-317L3VFKQV"
  };

  // ========= Firebase Initialization =========
  let firebaseApp = null;
  let firebaseAuth = null;
  let firebaseDb = null;
  let currentAuthUid = null;
  let isFirebaseReady = false;

  async function initializeFirebase() {
    try {
      if (!FIREBASE_CONFIG || !FIREBASE_CONFIG.apiKey) {
        if (isDebug()) console.warn('[Firebase] Config not set, fallback to legacy mode');
        return false;
      }

      // FirebaseåˆæœŸåŒ–
      firebaseApp = firebase.initializeApp(FIREBASE_CONFIG);
      firebaseAuth = firebase.auth();
      firebaseDb = firebase.database();

      // åŒ¿åãƒ­ã‚°ã‚¤ãƒ³
      await firebaseAuth.signInAnonymously();
      currentAuthUid = firebaseAuth.currentUser?.uid;

      if (!currentAuthUid) {
        throw new Error('Anonymous sign-in failed: no uid');
      }

      isFirebaseReady = true;
      if (isDebug()) {
        console.log('[Firebase] Initialized successfully');
        console.log('[Firebase] Auth UID:', currentAuthUid);
      }
      return true;

    } catch(e) {
      if (isDebug()) console.warn('[Firebase] Initialization failed:', e);
      isFirebaseReady = false;
      return false;
    }
  }

  // AuthçŠ¶æ…‹å¤‰åŒ–ã®ç›£è¦–
  function setupAuthListener() {
    if (!firebaseAuth) return;
    firebaseAuth.onAuthStateChanged((user) => {
      if (user) {
        currentAuthUid = user.uid;
        if (isDebug()) console.log('[Firebase] Auth state changed, UID:', currentAuthUid);
      } else {
        currentAuthUid = null;
        isFirebaseReady = false;
        if (isDebug()) console.warn('[Firebase] User signed out');
      }
    });
  }

  // ========= Debug =========
  function isDebug() {
    try { return new URL(location.href).searchParams.get('debug') === '1'; } catch(e){ return false; }
  }
  
  // âœ… ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°é–¢æ•°ï¼ˆãƒˆãƒ¼ã‚¹ãƒˆã§è¡¨ç¤ºï¼‰
  function debugLog(message, type = 'info') {
    if (!isDebug()) return;
    
    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ­ã‚°å‡ºåŠ›
    console.log('[DEBUG]', message);
    
    // ãƒˆãƒ¼ã‚¹ãƒˆã§è¡¨ç¤ºï¼ˆ10ç§’ï¼‰
    if (typeof showToast === 'function') {
      showToast(String(message), 10000);
    }
  }
  
  // ========= Debug Error Handling =========
  // âœ… P0: debug=1ã®ã¨ãã ã‘ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¼·åŒ–
  if (isDebug()) {
    const errorDisplay = document.getElementById('debug-error-display');

    // æœ€çµ‚ã‚¨ãƒ©ãƒ¼ã‚’ç”»é¢ã«å›ºå®šè¡¨ç¤ºã™ã‚‹é–¢æ•°
    // âœ… P0ä¿®æ­£: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ä¿å­˜ã™ã‚‹é…åˆ—ï¼ˆè¨ºæ–­ãƒ„ãƒ¼ãƒ«ç”¨ï¼‰
    const errorLogs = [];
    const MAX_ERROR_LOGS = 50; // æœ€å¤§50ä»¶ã¾ã§ä¿å­˜
    
    // âœ… P0ä¿®æ­£: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
    function addErrorLog(errorInfo) {
      errorLogs.push({
        ...errorInfo,
        timestamp: errorInfo.timestamp || new Date().toISOString()
      });
      // æœ€å¤§ä»¶æ•°ã‚’è¶…ãˆãŸã‚‰å¤ã„ã‚‚ã®ã‚’å‰Šé™¤
      if (errorLogs.length > MAX_ERROR_LOGS) {
        errorLogs.shift();
      }
      // localStorageã«ã‚‚ä¿å­˜ï¼ˆè¨ºæ–­ãƒ„ãƒ¼ãƒ«ã§èª­ã¿è¾¼ã‚€ãŸã‚ï¼‰
      try {
        localStorage.setItem('smartPrice_errorLogs', JSON.stringify(errorLogs));
      } catch(e) {
        console.warn('[ErrorLog] Failed to save to localStorage:', e);
      }
    }
    
    function setLastError(msg) {
      const errorDisplay = document.getElementById('debug-error-display');
      if (errorDisplay) {
        errorDisplay.textContent = msg;
        errorDisplay.style.display = 'block';
      }
    }

    window.addEventListener('error', (e) => {
      // âœ… P0: ã€ŒScript error.ã€ã®è©³ç´°æƒ…å ±ã‚’å–å¾—ï¼ˆCORSã‚¨ãƒ©ãƒ¼ã®å ´åˆã§ã‚‚å¯èƒ½ãªé™ã‚Šè©³ç´°ã‚’è¡¨ç¤ºï¼‰
      let errorName = 'Error';
      let errorMsg = e.message || 'Unknown error';
      let errorStack = '';
      let errorFileName = e.filename || '';
      let errorLine = e.lineno || 0;
      let errorCol = e.colno || 0;
      
      if (e.error) {
        errorName = e.error.name || 'Error';
        errorMsg = e.error.message || e.message || 'Unknown error';
        errorStack = e.error.stack || '';
      } else if (e.message && e.message !== 'Script error.') {
        errorName = 'Error';
        errorMsg = e.message;
      }
      
      // Script error.ã®å ´åˆã€è©³ç´°æƒ…å ±ã‚’è¿½åŠ 
      if (errorMsg === 'Script error.' || errorMsg === 'Script error') {
        errorMsg = `Script error. (ãƒ•ã‚¡ã‚¤ãƒ«: ${errorFileName || 'ä¸æ˜'}, è¡Œ: ${errorLine}, åˆ—: ${errorCol})`;
        if (errorFileName) {
          errorMsg += ` - å¤–éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆCORSåˆ¶é™ï¼‰`;
        }
      }
      
      const errorDetail = `${errorName}: ${errorMsg}`;
      const fullMsg = `JSã‚¨ãƒ©ãƒ¼: ${errorDetail}`;
      showToast(fullMsg, 10000);
      setLastError(fullMsg);
      
      // âœ… P0ä¿®æ­£: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ä¿å­˜ï¼ˆè¨ºæ–­ãƒ„ãƒ¼ãƒ«ç”¨ï¼‰
      addErrorLog({
        type: 'js_error',
        name: errorName,
        message: errorMsg,
        filename: errorFileName,
        lineno: errorLine,
        colno: errorCol,
        stack: errorStack,
        timestamp: new Date().toISOString()
      });
      
      // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚è©³ç´°ã‚’å‡ºåŠ›ï¼ˆå†…éƒ¨æ¤œè¨¼ç”¨ï¼‰
      console.error('[JS Error]', {
        name: errorName,
        message: errorMsg,
        filename: errorFileName,
        lineno: errorLine,
        colno: errorCol,
        stack: errorStack,
        event: e
      });
    });
    window.addEventListener('unhandledrejection', (e) => {
      const reason = e.reason || e;
      const errorName = reason && reason.name ? reason.name : 'PromiseRejection';
      const errorMsg = (reason && reason.message) ? reason.message : String(reason);
      const errorDetail = `${errorName}: ${errorMsg}`;
      const fullMsg = `Promiseã‚¨ãƒ©ãƒ¼: ${errorDetail}`;
      showToast(fullMsg, 10000);
      setLastError(fullMsg);
      
      // âœ… P0ä¿®æ­£: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ä¿å­˜ï¼ˆè¨ºæ–­ãƒ„ãƒ¼ãƒ«ç”¨ï¼‰
      addErrorLog({
        type: 'unhandled_rejection',
        name: errorName,
        message: errorMsg,
        stack: reason && reason.stack ? reason.stack : '',
        reason: String(reason),
        timestamp: new Date().toISOString()
      });
    });
  }

  // ========= Category Treeï¼ˆAmazon/Rakutenã‚’å®Ÿç”¨ãƒ¬ãƒ™ãƒ«ã«æ•´ç†ï¼‹è¿½è¨˜å¯ï¼‰ =========
  const DEFAULT_CATEGORY_TREE = {
    "ãƒ‰ãƒªãƒ³ã‚¯": ["æ°´ãƒ»ãƒŸãƒãƒ©ãƒ«ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼","ç‚­é…¸é£²æ–™","ä¹³é£²æ–™","ã‚³ãƒ¼ãƒ’ãƒ¼","ç´…èŒ¶","ãŠèŒ¶","ã‚¹ãƒãƒ¼ãƒ„ãƒ‰ãƒªãƒ³ã‚¯","ã‚¸ãƒ¥ãƒ¼ã‚¹","ç²‰æœ«ãƒ‰ãƒªãƒ³ã‚¯","ãã®ä»–"],
    "ãŠé…’": ["ãƒ“ãƒ¼ãƒ«","ç™ºæ³¡é…’","ãƒãƒ¥ãƒ¼ãƒã‚¤","æ—¥æœ¬é…’","ç„¼é…","ãƒ¯ã‚¤ãƒ³","ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼","æ¢…é…’","ãã®ä»–"],
    "è“å­ãƒ»ã‚¹ãƒŠãƒƒã‚¯": ["ã‚¹ãƒŠãƒƒã‚¯","ãƒãƒ§ã‚³","ãƒ“ã‚¹ã‚±ãƒƒãƒˆ","ã‚­ãƒ£ãƒ³ãƒ‡ã‚£ãƒ»ã‚¬ãƒ ","å’Œè“å­","ãƒŠãƒƒãƒ„","ãã®ä»–"],
    "ç±³ãƒ»é›‘ç©€": ["ç™½ç±³","ç„ç±³","é›‘ç©€ç±³","ã‚‚ã¡ç±³","ã”é£¯ãƒ‘ãƒƒã‚¯","é¤…","ãã®ä»–"],
    "éººé¡ãƒ»ãƒ‘ã‚¹ã‚¿": ["ãƒ©ãƒ¼ãƒ¡ãƒ³","ã†ã©ã‚“","ãã°","ãã†ã‚ã‚“","ç„¼ããã°","ãƒ‘ã‚¹ã‚¿","ãã®ä»–"],
    "ãƒ‘ãƒ³ãƒ»ã‚¸ãƒ£ãƒ ãƒ»ã‚·ãƒªã‚¢ãƒ«": ["ãƒ‘ãƒ³","ã‚¸ãƒ£ãƒ ãƒ»ã¯ã¡ã¿ã¤","ã‚·ãƒªã‚¢ãƒ«","ãã®ä»–"],
    "ç²¾è‚‰ãƒ»è‚‰åŠ å·¥å“": ["ç‰›è‚‰","è±šè‚‰","é¶è‚‰","æŒ½è‚‰","åŠ å·¥å“","ã‚»ãƒƒãƒˆ","ãã®ä»–"],
    "é­šä»‹é¡ãƒ»æ°´ç”£åŠ å·¥å“": ["ãƒã‚°ãƒ­","ã‚µã‚±","ã‚µãƒ","ã‚¨ãƒ“","ã‚«ãƒ‹","è²é¡","æµ·è—»é¡","é­šåµ","åŠ å·¥å“","ãã®ä»–"],
    "é‡èœãƒ»ãã®ã“": ["è‘‰ç‰©","æ ¹èœ","æœèœ","ãã®ã“","è±†é¡","ã‚«ãƒƒãƒˆé‡èœ","ãã®ä»–"],
    "ãƒ•ãƒ«ãƒ¼ãƒ„ãƒ»æœç‰©": ["æŸ‘æ©˜","ã‚Šã‚“ã”ç³»","ãƒ™ãƒªãƒ¼","ãƒãƒŠãƒŠ","ã¶ã©ã†","ãã®ä»–"],
    "ä¹³è£½å“ãƒ»åµ": ["ç‰›ä¹³","ãƒ¨ãƒ¼ã‚°ãƒ«ãƒˆ","ãƒãƒ¼ã‚º","ãƒã‚¿ãƒ¼ãƒ»ãƒãƒ¼ã‚¬ãƒªãƒ³","åµ","ä»£æ›¿å“","ãã®ä»–"],
    "è±†è…ãƒ»ç´è±†ãƒ»ã“ã‚“ã«ã‚ƒããƒ»ç·´ã‚Šç‰©": ["è±†è…","ç´è±†","ã“ã‚“ã«ã‚ƒã","ç·´ã‚Šç‰©","ãã®ä»–"],
    "æ¼¬ç‰©ãƒ»ä½ƒç…®": ["æ¼¬ç‰©","æ¢…å¹²ã—","ã‚­ãƒ ãƒ","ä½ƒç…®","ãã®ä»–"],
    "å†·å‡é£Ÿå“": ["å†·å‡æƒ£èœ","å†·å‡éºº","å†·å‡é‡èœ","ã‚¢ã‚¤ã‚¹","ãã®ä»–"],
    "æƒ£èœãƒ»ãƒãƒ«ãƒ‰": ["å’Œé¢¨æƒ£èœ","æ´‹é¢¨æƒ£èœ","ä¸­è¯æƒ£èœ","éŸ“å›½æƒ£èœ","ãã®ä»–"],
    "ãƒ¬ãƒˆãƒ«ãƒˆãƒ»æ–™ç†ã®ç´ ": ["ã‚«ãƒ¬ãƒ¼","ã‚¹ãƒ¼ãƒ—","ä¸¼","ãƒ‘ã‚¹ã‚¿ã‚½ãƒ¼ã‚¹","æ–™ç†ã®ç´ ","ãã®ä»–"],
    "ç¼¶è©°ãƒ»ç“¶è©°": ["æ°´ç”£","è‚‰","é‡èœ","ãƒ•ãƒ«ãƒ¼ãƒ„","æƒ£èœ","ãã®ä»–"],
    "ä¹¾ç‰©": ["æµ·è‹”","é°¹ç¯€","æ˜†å¸ƒ","ã‚ã‹ã‚","æ˜¥é›¨","ãã®ä»–"],
    "ç²‰é¡": ["å°éº¦ç²‰","ç‰‡æ —ç²‰","ãƒ‘ãƒ³ç²‰","ç±³ç²‰","ãã®ä»–"],
    "èª¿å‘³æ–™ãƒ»é£Ÿç”¨æ²¹ãƒ»ãƒ‰ãƒ¬ãƒƒã‚·ãƒ³ã‚°": ["ç ‚ç³–","å¡©","é…¢","ã—ã‚‡ã†ã‚†","ã¿ã","ã ã—","ã‚ã‚“ã¤ã‚†","ã‚½ãƒ¼ã‚¹ãƒ»ãŸã‚Œ","ã‚±ãƒãƒ£ãƒƒãƒ—","ãƒãƒ¨ãƒãƒ¼ã‚º","ã‚¹ãƒ‘ã‚¤ã‚¹","æ²¹","ãƒ‰ãƒ¬ãƒƒã‚·ãƒ³ã‚°","ãã®ä»–"],
    "ãƒ™ãƒ“ãƒ¼ãƒ•ãƒ¼ãƒ‰": ["é›¢ä¹³é£Ÿ","ãŠã‚„ã¤","ãã®ä»–"],
    "å¥åº·é£Ÿå“": ["ã‚µãƒ—ãƒª","ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³","ãã®ä»–"],
    "ä»‹è­·ç”¨é£Ÿå“": ["ã‚„ã‚ã‚‰ã‹é£Ÿ","ã¨ã‚ã¿","ãã®ä»–"],
    "ãƒŸãƒ¼ãƒ«ã‚­ãƒƒãƒˆ": ["ãƒŸãƒ¼ãƒ«ã‚­ãƒƒãƒˆ","ãã®ä»–"],
    "æ—¥ç”¨å“": ["æ´—å‰¤","ã‚­ãƒƒãƒãƒ³ç”¨å“","ç´™è£½å“","è¡›ç”Ÿç”¨å“","ãã®ä»–"],
    "è–¬": ["é¢¨é‚ª","èƒƒè…¸","ç—›ã¿","å¤–ç”¨","ãã®ä»–"],
    "ãã®ä»–": ["ãã®ä»–"]
  };

  const DEFAULT_CONFIG = {
    // äº’æ›ã®ãŸã‚æ®‹ã™ï¼ˆå®Ÿä½“ã¯ categoryTreeï¼‰
    categories: [],
    categoryTree: JSON.parse(JSON.stringify(DEFAULT_CATEGORY_TREE)),
    lastTax: "ex",
    homeCity: "",
    homeCities: [],
    customStores: [],
    storeTaxModes: {} // ã‚¹ãƒˆã‚¢ã”ã¨ã®ç¨åˆ¥/ç¨è¾¼æ—¢å®šå€¤ { "ã‚¹ãƒˆã‚¢å": "ex" or "in" }
  };

  const CITY_STORE_PRESET = {
    "åœŸæµ¦å¸‚": ["ã‚«ã‚¹ãƒŸåœŸæµ¦é§…å‰åº—", "ã‚«ã‚¹ãƒŸ ãƒ”ã‚¢ã‚·ãƒ†ã‚£è’å·æœ¬éƒ·åº—", "ãƒ¨ãƒ¼ã‚¯ãƒ™ãƒ‹ãƒãƒ«", "ã‚¿ã‚¤ãƒ¨ãƒ¼", "ã¾ã‚‹ã‚‚", "ã‚¦ã‚¨ãƒ«ã‚·ã‚¢"],
    "ã¤ãã°å¸‚": ["ã‚«ã‚¹ãƒŸ ã¤ãã°ç«¹åœ’åº—", "ãƒ¨ãƒ¼ã‚¯ãƒ™ãƒ‹ãƒãƒ« ã¤ãã°ç«¹åœ’åº—", "ãƒ­ãƒ”ã‚¢ ã¤ãã°åº—", "ã‚¿ã‚¤ãƒ¨ãƒ¼", "ã‚¦ã‚¨ãƒ«ã‚·ã‚¢"],
    "æ±æµ·æ‘": ["ã‚«ã‚¹ãƒŸæ±æµ·åº—", "ãƒ¨ãƒ¼ã‚¯ãƒ™ãƒ‹ãƒãƒ«æ±æµ·åº—", "ã‚¤ã‚ªãƒ³æ±æµ·åº—"]
  };

  // ========= Image Store (IndexedDB) =========
  const IMG_DB_NAME = "smart_price_img_db_v1";
  const IMG_STORE = "images";
  let imgDbPromise = null;

  function openImgDb() {
    if (!('indexedDB' in window)) return Promise.resolve(null);
    if (imgDbPromise) return imgDbPromise;
    imgDbPromise = new Promise((resolve) => {
      const req = indexedDB.open(IMG_DB_NAME, 1);
      req.onupgradeneeded = (e) => {
        const db = e.target.result;
        // âœ… ä¿å­˜ç®±ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å¿…ãšä½œæˆï¼ˆæ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã‚‚å®‰å…¨ï¼‰
        if (!db.objectStoreNames.contains(IMG_STORE)) {
          try {
            db.createObjectStore(IMG_STORE);
          } catch (err) {
            console.warn('[IDB] createObjectStore failed:', err);
          }
        }
      };
      req.onsuccess = () => {
        const db = req.result;
        // âœ… ä¿å­˜ç®±ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆå¿µã®ãŸã‚ï¼‰
        if (db && !db.objectStoreNames.contains(IMG_STORE)) {
          // ä¿å­˜ç®±ãŒç„¡ã„å ´åˆã¯å†ä½œæˆã‚’è©¦ã¿ã‚‹
          try {
            db.close();
            indexedDB.deleteDatabase(IMG_DB_NAME);
            imgDbPromise = null; // ãƒªã‚»ãƒƒãƒˆ
            resolve(openImgDb()); // å†å¸°å‘¼ã³å‡ºã—
            return;
          } catch (err) {
            console.warn('[IDB] recreate failed:', err);
            resolve(null);
            return;
          }
        }
        resolve(db);
      };
      req.onerror = (e) => {
        console.warn('[IDB] open failed:', e);
        resolve(null);
      };
    });
    return imgDbPromise;
  }

  async function idbPut(key, blob) {
    const dbi = await openImgDb();
    if (!dbi) return false;
    // âœ… ä¿å­˜ç®±ã®å­˜åœ¨ç¢ºèª
    if (!dbi.objectStoreNames.contains(IMG_STORE)) {
      console.warn('[IDB] objectStore not found:', IMG_STORE);
      return false;
    }
    return new Promise((res) => {
      try {
        const tx = dbi.transaction(IMG_STORE, "readwrite");
        const store = tx.objectStore(IMG_STORE);
        store.put(blob, key);
        tx.oncomplete = () => res(true);
        tx.onerror = (e) => {
          console.warn('[IDB] put failed:', e);
          res(false);
        };
      } catch (err) {
        console.warn('[IDB] transaction failed:', err);
        res(false);
      }
    });
  }

  async function idbGet(key) {
    const dbi = await openImgDb();
    if (!dbi) return null;
    // âœ… ä¿å­˜ç®±ã®å­˜åœ¨ç¢ºèª
    if (!dbi.objectStoreNames.contains(IMG_STORE)) {
      console.warn('[IDB] objectStore not found:', IMG_STORE);
      return null;
    }
    return new Promise((res) => {
      try {
        const tx = dbi.transaction(IMG_STORE, "readonly");
        const store = tx.objectStore(IMG_STORE);
        const req = store.get(key);
        req.onsuccess = () => res(req.result || null);
        req.onerror = (e) => {
          console.warn('[IDB] get failed:', e);
          res(null);
        };
      } catch (err) {
        console.warn('[IDB] transaction failed:', err);
        res(null);
      }
    });
  }

  function dataUrlToBlob(dataUrl) {
    try {
      const arr = dataUrl.split(',');
      const mime = arr[0].match(/:(.*?);/)[1];
      const bstr = atob(arr[1]);
      let n = bstr.length;
      const u8 = new Uint8Array(n);
      while (n--) u8[n] = bstr.charCodeAt(n);
      return new Blob([u8], { type: mime });
    } catch(e){ return null; }
  }

  // âœ… dataURLtoBlobï¼ˆä¿å­˜ç”¨ã€ã‚ˆã‚Šå®‰å…¨ãªå®Ÿè£…ï¼‰
  function dataURLtoBlob(dataurl){
    try{
      const parts = String(dataurl).split(',');
      const head = parts[0] || '';
      const b64 = parts[1] || '';
      const m = head.match(/data:(.*?);base64/);
      const mime = (m && m[1]) ? m[1] : 'image/png';
      const bin = atob(b64);
      const u8 = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i);
      return new Blob([u8], { type: mime });
    }catch(e){
      return null;
    }
  }

  async function fileToThumbBlob(file, maxSide=256, quality=0.78) {
    return new Promise((resolve) => {
      const fr = new FileReader();
      fr.onload = () => {
        const img = new Image();
        img.onload = () => {
          const w = img.width, h = img.height;
          const scale = Math.min(1, maxSide / Math.max(w, h));
          const cw = Math.max(1, Math.round(w * scale));
          const ch = Math.max(1, Math.round(h * scale));
          const canvas = document.createElement('canvas');
          canvas.width = cw; canvas.height = ch;
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = "#fff";
          ctx.fillRect(0,0,cw,ch);
          // âœ… EXIFæƒ…å ±ã¯è‡ªå‹•ã§å‰Šé™¤ã•ã‚Œã‚‹ï¼ˆcanvas.drawImageã§å†æç”»ã™ã‚‹ãŸã‚ï¼‰
          ctx.drawImage(img, 0,0,cw,ch);
          canvas.toBlob((blob) => {
            resolve(blob || null);
          }, 'image/jpeg', quality);
        };
        img.onerror = () => resolve(null);
        img.src = fr.result;
      };
      fr.onerror = () => resolve(null);
      fr.readAsDataURL(file);
    });
  }

  // ========= ç”»åƒã‚’Firebaseã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆSDKç‰ˆï¼šAuth + DB Ruleså¯¾å¿œï¼‰ =========
  async function uploadImageToFirebase(code, blob) {
    // Firebase SDK ãŒæœ‰åŠ¹ãªå ´åˆã¯SDKç‰ˆã‚’ä½¿ç”¨
    if (isFirebaseReady && firebaseDb && currentAuthUid) {
      try {
        // Blobã‚’base64ã«å¤‰æ›
        const dataUrl = await new Promise((resolve, reject) => {
          const fr = new FileReader();
          fr.onload = () => resolve(fr.result);
          fr.onerror = () => reject(new Error('ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—'));
          fr.readAsDataURL(blob);
        });

        const imageId = 'img_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9);
        const imageRecord = {
          owner: currentAuthUid,  // âœ… auth.uid ã‚’ä½¿ç”¨
          imageUrl: dataUrl,
          createdAt: Date.now()
        };

        // Firebase SDKï¼ˆdatabaseï¼‰ã§ä¿å­˜
        const ref = firebaseDb.ref(`smart_price_images/${code}/${imageId}`);
        await ref.set(imageRecord);

        if (isDebug()) console.log('[Firebase SDK] Image uploaded:', imageId);
        return { imageId, owner: currentAuthUid };

      } catch(e) {
        if (isDebug()) console.warn('[Firebase SDK] Upload failed, fallback to REST:', e);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: RESTç‰ˆã‚’å®Ÿè¡Œ
      }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: RESTç‰ˆï¼ˆå¾“æ¥æ–¹å¼ï¼‰
    if (!fbUrl) {
      throw new Error('Firebase URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    }

    const dataUrl = await new Promise((resolve, reject) => {
      const fr = new FileReader();
      fr.onload = () => resolve(fr.result);
      fr.onerror = () => reject(new Error('ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—'));
      fr.readAsDataURL(blob);
    });

    const deviceId = getDeviceId();
    const imageId = 'img_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9);
    const imageRecord = {
      owner: deviceId,  // ãƒ¬ã‚¬ã‚·ãƒ¼: deviceId
      imageUrl: dataUrl,
      createdAt: Date.now()
    };

    const imageUrl = getImageUrl(fbUrl, code, imageId);
    await fetchWithTimeout(imageUrl, {
      method: 'PUT',
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(imageRecord)
    }, 15000);

    return { imageId, owner: deviceId };
  }

  // ========= å…±æœ‰ç”»åƒã‚’å–å¾—ï¼ˆSDKç‰ˆï¼šãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤ºç”¨ï¼‰ =========
  async function getSharedImages(code) {
    // Firebase SDK ãŒæœ‰åŠ¹ãªå ´åˆã¯SDKç‰ˆã‚’ä½¿ç”¨
    if (isFirebaseReady && firebaseDb) {
      try {
        const ref = firebaseDb.ref(`smart_price_images/${code}`);
        const snapshot = await ref.once('value');
        const data = snapshot.val();
        
        if (!data || typeof data !== 'object') return [];
        
        const images = [];
        for (const [imageId, record] of Object.entries(data)) {
          if (record && typeof record === 'object' && record.imageUrl) {
            images.push({ imageId, ...record });
          }
        }
        
        if (isDebug()) console.log('[Firebase SDK] Loaded images:', images.length);
        return images;

      } catch(e) {
        if (isDebug()) console.warn('[Firebase SDK] Get images failed, fallback to REST:', e);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: RESTç‰ˆã‚’å®Ÿè¡Œ
      }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: RESTç‰ˆï¼ˆå¾“æ¥æ–¹å¼ï¼‰
    if (!fbUrl) return [];
    try {
      const listUrl = getImageListUrl(fbUrl, code);
      const res = await fetchWithTimeout(listUrl, {}, 10000);
      const data = await res.json();
      if (!data || typeof data !== 'object') return [];
      
      const images = [];
      for (const [imageId, record] of Object.entries(data)) {
        if (record && typeof record === 'object' && record.imageUrl) {
          images.push({ imageId, ...record });
        }
      }
      return images;
    } catch(e) {
      if (isDebug()) console.warn('[getSharedImages]', e);
      return [];
    }
  }

  // ========= è‡ªåˆ†ã®ç”»åƒã‚’å–å¾—ï¼ˆSDKç‰ˆï¼šownerç¢ºèªï¼‰ =========
  async function getMyImages(code) {
    const allImages = await getSharedImages(code);
    
    // Firebase SDK ãŒæœ‰åŠ¹ãªå ´åˆã¯ auth.uid ã§åˆ¤å®š
    if (isFirebaseReady && currentAuthUid) {
      return allImages.filter(img => img.owner === currentAuthUid);
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: deviceId ã§åˆ¤å®š
    const deviceId = getDeviceId();
    return allImages.filter(img => img.owner === deviceId);
  }

  // ========= ç”»åƒã‚’å‰Šé™¤ï¼ˆSDKç‰ˆï¼šDB Rulesã§å¼·åˆ¶ï¼‰ =========
  async function deleteImageFromFirebase(code, imageId) {
    // Firebase SDK ãŒæœ‰åŠ¹ãªå ´åˆã¯SDKç‰ˆã‚’ä½¿ç”¨ï¼ˆDB Rules ã§æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼‰
    if (isFirebaseReady && firebaseDb && currentAuthUid) {
      try {
        const ref = firebaseDb.ref(`smart_price_images/${code}/${imageId}`);
        
        // ownerç¢ºèª
        const snapshot = await ref.once('value');
        const record = snapshot.val();
        
        if (!record) {
          throw new Error('ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
        
        if (record.owner !== currentAuthUid) {
          throw new Error('å‰Šé™¤æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆæŠ•ç¨¿è€…ã®ã¿å‰Šé™¤å¯èƒ½ï¼‰');
        }
        
        // å‰Šé™¤ï¼ˆDB Rulesã§ã‚‚æ¨©é™ãƒã‚§ãƒƒã‚¯ã•ã‚Œã‚‹ï¼‰
        await ref.remove();
        
        if (isDebug()) console.log('[Firebase SDK] Image deleted:', imageId);
        return;

      } catch(e) {
        if (isDebug()) console.warn('[Firebase SDK] Delete failed:', e);
        throw e;  // ã‚¨ãƒ©ãƒ¼ã‚’å†ã‚¹ãƒ­ãƒ¼
      }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: RESTç‰ˆï¼ˆå¾“æ¥æ–¹å¼ï¼‰
    if (!fbUrl) {
      throw new Error('Firebase URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
    }

    // ownerç¢ºèª
    const imageUrl = getImageUrl(fbUrl, code, imageId);
    const res = await fetchWithTimeout(imageUrl, {}, 8000);
    const record = await res.json();
    
    if (!record || record.owner !== getDeviceId()) {
      throw new Error('å‰Šé™¤æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆæŠ•ç¨¿è€…ã®ã¿å‰Šé™¤å¯èƒ½ï¼‰');
    }

    // å‰Šé™¤
    await fetchWithTimeout(imageUrl, {
      method: 'DELETE'
    }, 8000);
  }

  // âœ… ç”»åƒã‚­ãƒ¼ã®å¾©å…ƒãƒ­ã‚¸ãƒƒã‚¯å¼·åŒ–ï¼ˆå¤ã„ç´ã¥ã‘ã‚‚æ¢ç´¢ï¼‰
  async function applyImageKeyToImg(imgEl, key) {
    if (!imgEl || !key) {
      return Promise.reject(new Error('Invalid parameters'));
    }
    try {
      // 1. ã¾ãšæŒ‡å®šã•ã‚ŒãŸã‚­ãƒ¼ã§å–å¾—
      let blob = await idbGet(key);
      if (blob) {
        const url = URL.createObjectURL(blob);
        imgEl.src = url;
        imgEl.referrerPolicy = "no-referrer";
        // ãƒ¡ãƒ¢ãƒªè§£æ”¾ï¼ˆç½®æ›æ™‚ï¼‰
        if (imgEl.dataset && imgEl.dataset.objurl) {
          try { URL.revokeObjectURL(imgEl.dataset.objurl); } catch(e) {}
        }
        imgEl.dataset.objurl = url;
        return Promise.resolve();
      }
      
      // 2. æŒ‡å®šã•ã‚ŒãŸã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€å¤ã„ã‚­ãƒ¼ã‚’æ¢ç´¢
      const dbi = await openImgDb();
      if (!dbi || !dbi.objectStoreNames.contains(IMG_STORE)) {
        return Promise.reject(new Error('Image not found in IndexedDB'));
      }
      
      // IndexedDBã‹ã‚‰å…¨ã‚­ãƒ¼ã‚’å–å¾—
      const allKeys = await new Promise((resolve) => {
        try {
          const tx = dbi.transaction(IMG_STORE, "readonly");
          const store = tx.objectStore(IMG_STORE);
          const req = store.getAllKeys();
          req.onsuccess = () => resolve(req.result || []);
          req.onerror = () => resolve([]);
        } catch(e) {
          resolve([]);
        }
      });
      
      // 3. å¤ã„ã‚­ãƒ¼ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è©¦ã™ï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰
      // ã‚­ãƒ¼ã‹ã‚‰ãƒãƒ¼ã‚³ãƒ¼ãƒ‰éƒ¨åˆ†ã‚’æŠ½å‡ºï¼ˆä¾‹ï¼šimg_1234567890123 â†’ 1234567890123ï¼‰
      const codeMatch = key.match(/img_([0-9]+)/);
      if (codeMatch && codeMatch[1]) {
        const code = codeMatch[1];
        // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã®ã‚­ãƒ¼ã‚’æ¢ã™ï¼ˆimg_${code} ã¾ãŸã¯ img_${code}_*ï¼‰
        const candidateKeys = allKeys.filter(k => {
          const kStr = String(k);
          return kStr.includes(code) && (kStr.startsWith('img_') || kStr.includes('_img_'));
        });
        
        // å€™è£œã‚­ãƒ¼ã‚’è©¦ã™ï¼ˆæœ€ã‚‚é•·ã„ã‚­ãƒ¼ã‹ã‚‰è©¦ã™ï¼‰
        candidateKeys.sort((a, b) => String(b).length - String(a).length);
        for (const candidateKey of candidateKeys) {
          blob = await idbGet(candidateKey);
          if (blob) {
            const url = URL.createObjectURL(blob);
            imgEl.src = url;
            imgEl.referrerPolicy = "no-referrer";
            if (imgEl.dataset && imgEl.dataset.objurl) {
              try { URL.revokeObjectURL(imgEl.dataset.objurl); } catch(e) {}
            }
            imgEl.dataset.objurl = url;
            if (isDebug()) console.log('[applyImageKeyToImg] Found old key:', candidateKey, 'for', key);
            return Promise.resolve();
          }
        }
      }
      
      // 4. ãã‚Œã§ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
      return Promise.reject(new Error('Image not found in IndexedDB (tried fallback)'));
    } catch(e) {
      if (isDebug()) console.warn('[applyImageKeyToImg]', e);
      return Promise.reject(e);
    }
  }

  // ========= Home Image Fix (base64 + IndexedDBå¯¾å¿œ) =========
  async function spBindItemImage(imgEl, item, last) {
    if (!imgEl || !item) return;
    
    // å„ªå…ˆé †ä½ï¼šlast.imageData â†’ item.imageData â†’ last.imageKey â†’ item.imageKey â†’ last.imageUrl â†’ item.imageUrl â†’ placeholder
    
    // 1. base64ãƒ‡ãƒ¼ã‚¿ï¼ˆimageDataï¼‰ãŒã‚ã‚Œã°å„ªå…ˆ
    if (last && last.imageData && typeof last.imageData === 'string' && last.imageData.startsWith('data:')) {
      imgEl.src = last.imageData;
      return;
    }
    if (item.imageData && typeof item.imageData === 'string' && item.imageData.startsWith('data:')) {
      imgEl.src = item.imageData;
      return;
    }
    
    // 2. IndexedDBï¼ˆimageKeyï¼‰ãŒã‚ã‚Œã°å–å¾—
    if (last && last.imageKey && typeof last.imageKey === 'string') {
      await applyImageKeyToImg(imgEl, last.imageKey);
      return;
    }
    if (item.imageKey && typeof item.imageKey === 'string') {
      await applyImageKeyToImg(imgEl, item.imageKey);
      return;
    }
    
    // 3. HTTP/HTTPS URLï¼ˆimageUrlï¼‰ãŒã‚ã‚Œã°ä½¿ç”¨
    if (last && last.imageUrl && typeof last.imageUrl === 'string' && 
        (last.imageUrl.startsWith('http://') || last.imageUrl.startsWith('https://'))) {
      imgEl.src = last.imageUrl;
      return;
    }
    if (item.imageUrl && typeof item.imageUrl === 'string' && 
        (item.imageUrl.startsWith('http://') || item.imageUrl.startsWith('https://'))) {
      imgEl.src = item.imageUrl;
      return;
    }
    
    // 4. ã©ã‚Œã‚‚ãªã‘ã‚Œã°placeholder
    imgEl.src = placeholderImg();
  }

  // ========= P0/P1: LocalStorage Cache & User Profile =========
  
  /**
   * P1: ãƒ©ãƒ³ãƒ€ãƒ ãªUIDã‚’ç”Ÿæˆï¼ˆu_ã‹ã‚‰å§‹ã¾ã‚‹12æ–‡å­—ï¼‰
   */
  function generateUid() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let uid = 'u_';
    for (let i = 0; i < 10; i++) {
      uid += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return uid;
  }

  /**
   * P1: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ï¼ˆLocalStorageï¼‰
   * @returns {object} { uid, areaId, invitedBy, createdAt }
   */
  function getUserProfile() {
    try {
      const json = localStorage.getItem('smartPrice_userProfile');
      if (json) {
        const profile = JSON.parse(json);
        // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œè¨¼
        if (profile.uid) {
          return profile;
        }
      }
    } catch(e) {
      if (isDebug()) console.warn('[UserProfile] Failed to load:', e);
    }
    return null;
  }

  /**
   * P1: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ï¼ˆLocalStorageï¼‰
   * @param {object} profile { uid, areaId, invitedBy, createdAt }
   */
  function setUserProfile(profile) {
    try {
      localStorage.setItem('smartPrice_userProfile', JSON.stringify(profile));
      if (isDebug()) console.log('[UserProfile] Saved:', profile);
    } catch(e) {
      if (isDebug()) console.error('[UserProfile] Failed to save:', e);
    }
  }

  /**
   * P1: URLã‹ã‚‰æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Š
   * @returns {string|null} invite code (ä¾‹: "XXXX") ã¾ãŸã¯ null
   */
  function parseInviteCode() {
    try {
      const params = new URL(location.href).searchParams;
      const invite = params.get('invite');
      if (invite && invite.trim().length > 0) {
        return invite.trim();
      }
    } catch(e) {
      if (isDebug()) console.warn('[InviteCode] Failed to parse:', e);
    }
    return null;
  }

  /**
   * P0: JANã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å–å¾—ï¼ˆLocalStorageï¼‰
   * @param {string} jan 
   * @returns {object|null} { name, maker, imageUrl, imageRefType, areaId, cachedAt }
   */
  function getJanCache(jan) {
    try {
      const key = `smartPrice_jan_${jan}`;
      const json = localStorage.getItem(key);
      if (json) {
        const data = JSON.parse(json);
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯ï¼ˆ7æ—¥é–“ï¼‰
        if (data.cachedAt) {
          const now = Date.now();
          const age = now - data.cachedAt;
          if (age > 7 * 24 * 60 * 60 * 1000) {
            // æœŸé™åˆ‡ã‚Œ
            localStorage.removeItem(key);
            return null;
          }
        }
        return data;
      }
    } catch(e) {
      if (isDebug()) console.warn('[JanCache] Failed to load:', jan, e);
    }
    return null;
  }

  /**
   * P0: JANã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜ï¼ˆLocalStorageï¼‰
   * @param {string} jan 
   * @param {object} data { name, maker, imageUrl, imageRefType, areaId, source }
   */
  function setJanCache(jan, data) {
    try {
      const userProfile = getUserProfile();
      const cacheData = {
        ...data,
        cachedAt: Date.now(),
        areaId: data.areaId || (userProfile ? userProfile.areaId : null)
      };
      const key = `smartPrice_jan_${jan}`;
      localStorage.setItem(key, JSON.stringify(cacheData));
      if (isDebug()) console.log('[JanCache] Saved:', jan, cacheData);
    } catch(e) {
      if (isDebug()) console.error('[JanCache] Failed to save:', jan, e);
    }
  }

  // ========= App State =========
  let db = { products: {}, config: JSON.parse(JSON.stringify(DEFAULT_CONFIG)) };
  let curBarcode = null, curStore = "æœªè¨­å®š";
  let processBarcodeInFlight = new Set(); // âœ… P0: åŒä¸€JANã®äºŒé‡ç™ºç«é˜²æ­¢
  let janCoolDown = new Map(); // âœ… P0: åŒã˜JANã‚’0.8ã€œ1.2ç§’ä»¥å†…ã«å†æ¤œå‡ºã—ãŸã‚‰ç„¡è¦–ï¼ˆã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰
  let tempImgData = null; // {type:'key', key} or {type:'url', url}
  let scanner = null, editingHistIdx = null, isScanning = false;
  let deferredPrompt = null; // âœ… PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ

  // âœ… ã“ã“ã¯å¿…ãš letï¼ˆconst ã«ã™ã‚‹ã¨ "Assignment to constant variable" ã®åŸå› ã«ãªã‚‹ï¼‰
  let fbUrl = localStorage.getItem('smartPriceFirebaseUrl') || '';

  // ========= Config.json (Yahoo Proxy URL) =========
  window.SP_CONFIG = {};

  let isGpsOn = false, curPos = null, lastGpsTime = "";
  let activeSyncController = null;
  // âœ… åŒæœŸãƒ­ãƒƒã‚¯ï¼ˆäºŒé‡èµ·å‹•é˜²æ­¢ï¼‰
  let syncInFlight = false;
  let syncQueued = false;
  
  // âœ… è¿‘éš£åº—èˆ—å€™è£œï¼ˆGPS/ç”Ÿæ´»åœã‹ã‚‰å–å¾—ï¼‰
  window.nearbyStoreNames = [];

  // ========= Config.jsonèª­ã¿è¾¼ã¿ =========
  // --- P0 FIX: loadConfig with root fallback (UI_FREEZE / internal only) ---
  async function loadConfig() {
    try {
      const path = location.pathname || '';
      const isDev = path.includes('/dev/');
      const isEmergency = path.includes('/emergency/');
      const isRoot = path.includes('/Smart-Price-Book/') && !isDev && !isEmergency;
      
      const b = new URLSearchParams(location.search).get("b") || "";
      
      const tryFetch = async (url) => {
        const fullUrl = url + (b ? ("?b=" + encodeURIComponent(b)) : "");
        if (isDebug()) {
          const absUrl = new URL(fullUrl, location.href).href;
          showToast(`[Config] Loading from: ${absUrl}`, 5000);
          console.log('[Config] Loading from:', absUrl);
        }
        const res = await fetch(fullUrl, { cache: "no-store" });
        if (isDebug()) {
          showToast(`[Config] HTTP Status: ${res.status} ${res.statusText}`, 5000);
          console.log('[Config] HTTP Status:', res.status, res.statusText);
        }
        if (!res.ok) throw new Error(`fetch failed ${res.status} ${url}`);
        return await res.json();
      };

      let cfg = null;

      if (isRoot) {
        // root: äºŒæ®µãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        try {
          cfg = await tryFetch('./config.json');
        } catch (e1) {
          if (isDebug()) {
            console.warn('[Config] 1st try failed (./config.json), fallback to ./dev/config.json');
            showToast('[Config] Fallback to ./dev/config.json', 5000);
          }
          cfg = await tryFetch('./dev/config.json');
        }
      } else {
        // dev/emergency: å¾“æ¥é€šã‚Š
        cfg = await tryFetch('./config.json');
      }

      window.SP_CONFIG = cfg || {};
      if (isDebug()) {
        showToast(`[Config] Loaded OK: ${JSON.stringify(cfg).substring(0, 100)}...`, 5000);
        console.log('[Config] Loaded:', window.SP_CONFIG);
      }
    } catch(e) {
      // P0: å…¨åœæ­¢ã•ã›ãªã„
      window.SP_CONFIG = {};
      if (isDebug()) {
        console.warn('[Config] Error:', e);
        showToast('Configèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + (e.message || 'ä¸æ˜'), 10000);
      }
    }
  }

  // ========= ç«¯æœ«IDï¼ˆæŠ•ç¨¿è€…IDï¼‰ç”Ÿæˆãƒ»ä¿æŒ =========
  function getDeviceId() {
    let deviceId = localStorage.getItem('smartPriceDeviceId');
    if (!deviceId) {
      // ç«¯æœ«IDã‚’ç”Ÿæˆï¼ˆãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ—ï¼‰
      deviceId = 'dev_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 11);
      localStorage.setItem('smartPriceDeviceId', deviceId);
    }
    return deviceId;
  }

  // âœ… P0: VERSIONè¡¨ç¤ºã‚’æœ€å„ªå…ˆã§å®Ÿè¡Œï¼ˆloadConfigã‚ˆã‚Šå…ˆï¼‰
  document.addEventListener('DOMContentLoaded', () => {
    try {
      const versionBadge = document.getElementById('version-badge');
      if (versionBadge) {
        versionBadge.textContent = FULL_VERSION;
      }
      
      // document.titleã‚’æ›´æ–°ï¼ˆdebug=1ã®æ™‚ã ã‘BUILD_IDã‚‚ä½µè¨˜ï¼‰
      if (isDebug()) {
        document.title = `Smart Price ${FULL_VERSION} / ${BUILD_ID}`;
      } else {
        document.title = `Smart Price ${FULL_VERSION}`;
      }
    } catch(e) {
      if (isDebug()) console.warn('[DOMContentLoaded] version update error:', e);
    }
  });

  window.onload = async () => {
    // âœ… èµ·å‹•æ™‚ã®é»’ç”»é¢å¯¾ç­–ï¼šå³åº§ã«è¡¨ç¤ºã‚’ç¢ºå®Ÿã«ã™ã‚‹
    try {
      document.body.style.display = 'block';
      const mainView = document.getElementById('mainView');
      if (mainView) mainView.style.display = 'block';
    } catch(e) {
      if (isDebug()) console.warn('[onload] display error:', e);
    }

    try {
      // âœ… Config.jsonèª­ã¿è¾¼ã¿ï¼ˆYahoo Proxy URLï¼‰
      await loadConfig();

      // âœ… ä¿ç®¡ç®±ã®ä¿è­·ï¼ˆè‡ªå‹•æ•´ç†ã•ã‚Œã«ããã™ã‚‹ï¼‰
      if ('storage' in navigator && 'persist' in navigator.storage) {
        try {
          const persisted = await navigator.storage.persist();
          if (isDebug()) console.log('[Storage] Persist granted:', persisted);
        } catch(e) {
          if (isDebug()) console.warn('[Storage] Persist failed:', e);
        }
      }

      // âœ… FirebaseåˆæœŸåŒ–ï¼ˆåŒ¿åãƒ­ã‚°ã‚¤ãƒ³ï¼‰
      await initializeFirebase();
      setupAuthListener();

      loadLocal();
      db = normalizeDb(db);

      // æ—§data:imageãŒæ®‹ã£ã¦ã„ã‚‹ç«¯æœ«ã¯ã€IndexedDBã¸ç§»è¡Œã—ã¦ç”»åƒå¾©æ´»
      await migrateLegacyImagesToIdb();

      // âœ… M_å•†å“ã¨JANã®è‡ªå‹•çµ±åˆï¼ˆèµ·å‹•æ™‚ãƒ»YahooæˆåŠŸã«ä¾å­˜ã—ãªã„ï¼‰
      migrateMergeManualToJan();

      initCategorySelect();
      renderStoreList();
      renderHistory();

      if (fbUrl) {
        await syncFirebase(); // âœ… ãƒãƒ¼ã‚¸æ–¹å¼ã§ç”»åƒãŒæ¶ˆãˆãªã„
        renderHistory();
        renderStoreList();
      }

      setupFocusGuides();

      // âœ… èµ·å‹•æ™‚ã«è¿‘éš£åº—èˆ—ã‚’å–å¾—ï¼ˆGPS OFF ã§ã‚‚ç”Ÿæ´»åœãŒã‚ã‚Œã°å–å¾—ï¼‰
      try {
        const nearbyStores = await fetchNearbyStores();
        if (nearbyStores && nearbyStores.length > 0) {
          window.nearbyStoreNames = nearbyStores;
          renderStoreList(); // è¿‘éš£åº—èˆ—ã‚’åæ˜ ã—ã¦å†æç”»
          if (isDebug()) console.log('[onload] Nearby stores loaded:', nearbyStores.length);
        }
      } catch(e) {
        if (isDebug()) console.warn('[onload] fetchNearbyStores failed:', e);
      }

      if (isDebug()) {
        // âœ… P0: debug=1ã®ã¨ãã ã‘ã‚¹ã‚­ãƒ£ãƒ³ã‚¬ã‚¤ãƒ‰æ ã‚’è¡¨ç¤º
        document.body.setAttribute('data-debug', '1');
        setTimeout(() => {
          showToast(`DEBUG:${FULL_VERSION} / ${BUILD_ID} / Firebase:${isFirebaseReady?'ON':'OFF'}`, 4000);
        }, 300);
      } else {
        document.body.removeAttribute('data-debug');
      }
    } catch(e) {
      showToast(`èµ·å‹•ã‚¨ãƒ©ãƒ¼: ${e.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`, 10000);
      if (isDebug()) console.error('[onload]', e);
    }
  };

  // âœ… pageshowã‚¤ãƒ™ãƒ³ãƒˆã§ã‚‚åˆæœŸåŒ–ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ãƒãƒƒã‚¯å¯¾ç­–ï¼‰
  window.addEventListener("pageshow", async (e) => {
    if (e.persisted) {
      // ãƒãƒƒã‚¯ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å¾©å¸°ã—ãŸå ´åˆ
      renderHistory();
      renderStoreList();
    }
  });

  // âœ… PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆAndroid/PC Chrome/Edgeï¼‰
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    if (isDebug()) console.log('[PWA] Install prompt captured');
    
    // âœ… webModalãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯å³åº§ã«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    const webModal = document.getElementById('webModal');
    const installBtn = document.getElementById('pwaInstallBtn');
    if (webModal && webModal.style.display === 'flex' && installBtn) {
      installBtn.style.display = 'block';
      if (isDebug()) console.log('[PWA] Install button shown (modal is open)');
    }
  });

  window.addEventListener("pageshow", resetSyncBtn);
  window.addEventListener("beforeunload", resetSyncBtn);
  document.addEventListener("visibilitychange", () => {
    if (document.hidden) {
      resetSyncBtn();
      if (activeSyncController) activeSyncController.abort();
    }
  });

  function resetSyncBtn() {
    const btn = document.getElementById('syncBtn');
    if (btn) {
      btn.disabled = false;
      btn.innerText = "è¨­å®šä¿å­˜ã¨åŒæœŸ";
    }
  }

  // âœ… P0ä¿®æ­£: ã‚¹ã‚­ãƒ£ãƒ³èµ·å‹•ã‚¨ãƒ©ãƒ¼ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºæ™‚é–“ã‚’å»¶é•·ï¼ˆæœ€ä½12ç§’ã€æ¨å¥¨15ç§’ï¼‰
  let lastToastTimeout = null;
  let lastToastElement = null;
  
  /* Toast (stack) - debug: 10s, normal: 3s (unless ms specified) */

  // ===== Toast (single source of truth) =====
  // - é€šå¸¸: 3ç§’ / ãƒ‡ãƒãƒƒã‚°: 10ç§’
  // - ç”»é¢åˆ‡æ›¿ï¼ˆè¨­å®šãªã©ï¼‰ã§ã¯ clearToasts() ã§ç¢ºå®Ÿã«æ¶ˆã™
  // - UIã¯å¤‰ãˆãªã„ï¼ˆè¦‹ãŸç›®ã¯æ—¢å­˜CSSã‚’æµç”¨ï¼‰

  let __toastHost = null;
  let __toastTimers = [];
  const __TOAST_MAX = 6;

  function __toastIsDebug() {
    try {
      const usp = new URLSearchParams(location.search || "");
      return usp.get("debug") === "1";
    } catch (e) {
      return false;
    }
  }

  function __toastEnsureContainer() {
    if (__toastHost && document.body.contains(__toastHost)) return __toastHost;

    const host = document.createElement("div");
    host.id = "toastHost";
    host.style.position = "fixed";
    host.style.left = "50%";
    host.style.top = "72px";
    host.style.transform = "translateX(-50%)";
    host.style.zIndex = "9999";
    host.style.width = "min(560px, calc(100vw - 24px))";
    host.style.pointerEvents = "none";
    document.body.appendChild(host);

    __toastHost = host;
    return host;
  }

  function clearToasts() {
    try {
      __toastTimers.forEach((t) => clearTimeout(t));
      __toastTimers = [];
      if (__toastHost) __toastHost.innerHTML = "";
    } catch (e) {}
  }

  function showToast(message, ms, opts) {
    try {
      const host = __toastEnsureContainer();
      const isDebug = __toastIsDebug();

      const ttl = (typeof ms === "number" && ms > 0)
        ? ms
        : (isDebug ? 10000 : 3000);

      const options = opts || {};
      const sticky = !!options.sticky;

      // æ—¢å­˜ãŒå¤šã™ãã‚‹ã¨ãã¯å¤ã„ã‚‚ã®ã‹ã‚‰å‰Šé™¤
      while (host.children.length >= __TOAST_MAX) {
        host.removeChild(host.firstChild);
      }

      const toast = document.createElement("div");
      toast.className = "toast toast-compact";
      toast.style.pointerEvents = "auto";
      toast.style.margin = "6px 0";
      toast.style.borderRadius = "10px";
      toast.style.padding = "10px 12px";
      toast.style.background = "rgba(30,30,30,0.94)";
      toast.style.border = "1px solid rgba(255,255,255,0.10)";
      toast.style.boxShadow = "0 10px 26px rgba(0,0,0,0.35)";
      toast.style.backdropFilter = "blur(6px)";
      toast.style.webkitBackdropFilter = "blur(6px)";
      toast.style.color = "#fff";
      toast.style.fontSize = "14px";
      toast.style.lineHeight = "1.35";
      toast.style.wordBreak = "break-word";
      toast.style.overflowWrap = "anywhere";
      toast.style.maxHeight = "160px";
      toast.style.overflow = "hidden";

      // ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹ï¼ˆãƒ‡ãƒãƒƒã‚°æ™‚ã¯ä¾¿åˆ©ï¼‰
      toast.addEventListener("click", () => {
        try { toast.remove(); } catch (e) {}
      });

      toast.textContent = (message == null) ? "" : String(message);
      host.appendChild(toast);

      if (!sticky) {
        const timer = setTimeout(() => {
          try { toast.remove(); } catch (e) {}
        }, ttl);
        __toastTimers.push(timer);
      }

      return toast;
    } catch (e) {
      // æœ€æ‚ªã§ã‚‚è½ã¨ã•ãªã„
      return null;
    }
  }

  // ç”»é¢ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã«hostã‚’å†ç”Ÿæˆã—ã¦ã‚‚è½ã¡ãªã„ã‚ˆã†ã«ã™ã‚‹
  window.addEventListener("resize", () => {
    __toastEnsureContainer();
  });
function isQuotaError(e) {
    if (!e) return false;
    return (
      e.name === 'QuotaExceededError' ||
      e.name === 'NS_ERROR_DOM_QUOTA_REACHED' ||
      e.code === 22 ||
      e.code === 1014
    );
  }

  function normalizeDb(input) {
    let o = (input && typeof input === "object") ? input : {};
    if (!o.products || typeof o.products !== "object") o.products = {};
    if (!o.config || typeof o.config !== "object") o.config = {};

    // categoryTree ã‚’æ­£ã¨ã—ã¦æ•´å½¢ï¼ˆDEFAULT_CATEGORY_TREEã‹ã‚‰è£œå®Œï¼‰
    if (!o.config.categoryTree || typeof o.config.categoryTree !== "object") {
      // æ—§ categories ã—ã‹ãªã„å ´åˆ
      if (Array.isArray(o.config.categories) && o.config.categories.length) {
        const tree = {};
        o.config.categories.forEach(c => { tree[c] = ["ãã®ä»–"]; });
        o.config.categoryTree = tree;
      } else {
        o.config.categoryTree = JSON.parse(JSON.stringify(DEFAULT_CATEGORY_TREE));
      }
    } else {
      // âœ… æ—¢å­˜ã®categoryTreeãŒã‚ã‚‹å ´åˆã€DEFAULT_CATEGORY_TREEã®ãƒ‡ãƒ¼ã‚¿ã§è£œå®Œ
      const merged = JSON.parse(JSON.stringify(DEFAULT_CATEGORY_TREE));
      Object.keys(merged).forEach(key => {
        if (!o.config.categoryTree[key] || !Array.isArray(o.config.categoryTree[key]) || o.config.categoryTree[key].length === 0) {
          o.config.categoryTree[key] = merged[key];
        }
      });
    }
    // categories ã¯è¡¨ç¤ºç”¨ã®ã‚­ãƒ¼é…åˆ—ï¼ˆäº’æ›ï¼‰
    o.config.categories = Object.keys(o.config.categoryTree);

    if (typeof o.config.lastTax !== "string") o.config.lastTax = DEFAULT_CONFIG.lastTax;
    if (typeof o.config.homeCity !== "string") o.config.homeCity = DEFAULT_CONFIG.homeCity;
    if (!Array.isArray(o.config.homeCities)) o.config.homeCities = o.config.homeCity ? [o.config.homeCity] : [];
    if (!Array.isArray(o.config.customStores)) o.config.customStores = [];

    Object.keys(o.products).forEach(code => {
      const p = o.products[code];
      if (!p || typeof p !== 'object') return;
      if (!Array.isArray(p.history)) p.history = [];
      // æ—§ image â†’ imageUrl ã¸å¯„ã›ã‚‹ï¼ˆhttpã ã‘ï¼‰
      if (typeof p.image === 'string' && (p.image.startsWith('http://') || p.image.startsWith('https://'))) {
        p.imageUrl = p.image;
        delete p.image;
      }
      // âœ… ç”»åƒå‚ç…§ã®ç§»æ¤ï¼šlast.imageKeyãŒã‚ã‚Œã°productã¸ã‚³ãƒ”ãƒ¼ï¼ˆæ°¸ç¶šåŒ–ï¼‰
      if (Array.isArray(p.history) && p.history.length > 0 && !p.imageKey) {
        const last = p.history[p.history.length - 1];
        if (last && typeof last === 'object') {
          if (last.imageKey && typeof last.imageKey === 'string') {
            p.imageKey = last.imageKey;
          } else if (last.imageUrl && typeof last.imageUrl === 'string' && 
                     (last.imageUrl.startsWith('http://') || last.imageUrl.startsWith('https://'))) {
            p.imageUrl = last.imageUrl;
          }
        }
      }
    });

    if (o.config.homeCity) {
      o.config.homeCities = [o.config.homeCity, ...o.config.homeCities.filter(c => c !== o.config.homeCity)].slice(0, 5);
    }

    o.config.customStores = (o.config.customStores || [])
      .filter(s => typeof s === "string" && s.trim())
      .map(s => s.trim());
    o.config.customStores = [...new Set(o.config.customStores)].slice(0, 20);

    return o;
  }

  function histTs(h) {
    if (!h || typeof h !== "object") return 0;
    const v = (h.ts ?? h.timestamp ?? h.time ?? 0);
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  function makeSlimDb(d) {
    const out = JSON.parse(JSON.stringify(d));
    Object.keys(out.products || {}).forEach(k => {
      const p = out.products[k];
      if (!p) return;
      // Firebaseã«ã¯çµ¶å¯¾é€ã‚‰ãªã„ã‚‚ã®
      if (typeof p.image === "string" && p.image.startsWith("data:")) delete p.image;
      // äº’æ›ã®ãŸã‚æ®‹ã£ã¦ãŸã‚‰æ•´ç†
      if (typeof p.imageUrl === "string" && p.imageUrl.startsWith("data:")) delete p.imageUrl;
      // historyä¸Šé™ä¿é™º
      if (Array.isArray(p.history) && p.history.length > 500) p.history = p.history.slice(-500);
    });
    return normalizeDb(out);
  }

  function stripForCloud(d) {
    // âœ… ã‚¯ãƒ©ã‚¦ãƒ‰ã¸é€ã‚‹ã®ã¯ã€Œæ–‡å­—æƒ…å ±ï¼‹å±¥æ­´ï¼‹ç”»åƒURLã®ã¿ã€
    // æ³¨æ„ï¼šhistoryå†…ã®imageKey/imageUrlã¯å‰Šé™¤ã—ãªã„ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å°‚ç”¨ã ãŒã€ã‚¯ãƒ©ã‚¦ãƒ‰å´ã§ã‚‚å‚ç…§å¯èƒ½ã«ã™ã‚‹ï¼‰
    const out = JSON.parse(JSON.stringify(d));
    Object.keys(out.products || {}).forEach(k => {
      const p = out.products[k];
      if (!p) return;
      delete p.image;     // æ—§
      delete p.imageKey;  // ç«¯æœ«å†…ã®ã¿ï¼ˆé€ã£ã¦ã‚‚ç„¡æ„å‘³ãªã®ã§è½ã¨ã™ï¼‰
      // imageUrl ã¯æ®‹ã™ï¼ˆhttp/httpsã®ã¿ï¼‰
      if (typeof p.imageUrl === "string" && p.imageUrl.startsWith("data:")) delete p.imageUrl;
      // âœ… historyå†…ã®imageKey/imageUrlã¯å‰Šé™¤ã—ãªã„ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å°‚ç”¨ã ãŒã€ã‚¯ãƒ©ã‚¦ãƒ‰å´ã§ã‚‚å‚ç…§å¯èƒ½ã«ã™ã‚‹ï¼‰
      // historyã¯ãã®ã¾ã¾é€ã‚‹ï¼ˆhistoryå†…ã®imageKeyã¯ç«¯æœ«å†…å‚ç…§ãªã®ã§ã€ã‚¯ãƒ©ã‚¦ãƒ‰å´ã§ã¯ç„¡è¦–ã•ã‚Œã‚‹ãŒå‰Šé™¤ã¯ã—ãªã„ï¼‰
    });
    return out;
  }

  function saveLocalOnly() {
    try {
      localStorage.setItem('smart_price_db', JSON.stringify(db));
      return true;
    } catch (e) {
      if (!isQuotaError(e)) {
        showToast("ç«¯æœ«ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ", 10000);
        return false;
      }
      const slim = makeSlimDb(db);
      try {
        localStorage.setItem('smart_price_db', JSON.stringify(slim));
        db = slim;
        showToast("ç«¯æœ«å®¹é‡ãŒå³ã—ã„ã®ã§è»½é‡ä¿å­˜ã«åˆ‡æ›¿ãˆã¾ã—ãŸ", 8000);
        return true;
      } catch (e2) {
        try {
          localStorage.removeItem('smart_price_db');
          localStorage.setItem('smart_price_db', JSON.stringify(slim));
          db = slim;
          showToast("ç«¯æœ«å®¹é‡ã‚’æ•´ç†ã—ã¦å¾©æ—§ã—ã¾ã—ãŸ", 8000);
          return true;
        } catch (e3) {
          showToast("ç«¯æœ«ä¿å­˜ãŒå®Œå…¨ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆå®¹é‡ä¸è¶³ï¼‰", 10000);
          return false;
        }
      }
    }
  }

  function loadLocal() {
    try {
      const saved = localStorage.getItem('smart_price_db');
      if (saved) db = JSON.parse(saved);
      db = normalizeDb(db);
      const taxModeId = db.config.lastTax === "in" ? 'taxIn' : 'taxEx';
      const el = document.getElementById(taxModeId);
      if (el) el.checked = true;
    } catch(e) {
      db = normalizeDb({});
      showToast("ãƒ­ãƒ¼ã‚«ãƒ«èª­è¾¼ã«å¤±æ•—ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã§å¾©æ—§ã—ã¾ã™ï¼‰", 8000);
    }
  }

  async function fetchWithTimeout(resource, options = {}, timeout = 12000) {
    const internalController = new AbortController();
    const signal = options.signal || internalController.signal;
    const id = setTimeout(() => internalController.abort(), timeout);
    try {
      const response = await fetch(resource, { cache: 'no-store', ...options, signal });
      clearTimeout(id);
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return response;
    } catch (e) {
      clearTimeout(id);
      throw e;
    }
  }

  function getBaseUrl(url) {
    if(!url) return "";
    let base = url.trim().replace(/\/rules$/, "").replace(/\/+$/, "");
    if(base.endsWith('.json')) base = base.slice(0, -5);
    if(base.endsWith('/smart_price') || base.endsWith('smart_price')) base = base.replace(/\/?smart_price$/, '');
    return base.replace(/\/+$/, '');
  }
  function getSafeUrl(url) {
    const base = getBaseUrl(url);
    return base ? `${base}/smart_price.json` : "";
  }

  function getImageUrl(url, code, imageId) {
    const base = getBaseUrl(url);
    if (!base) return "";
    return `${base}/smart_price_images/${encodeURIComponent(code)}/${encodeURIComponent(imageId)}.json`;
  }

  function getImageListUrl(url, code) {
    const base = getBaseUrl(url);
    if (!base) return "";
    return `${base}/smart_price_images/${encodeURIComponent(code)}.json`;
  }

  async function syncFirebasePut() {
    if(!fbUrl) return;
    try {
      const targetUrl = getSafeUrl(fbUrl);
      const payload = stripForCloud(db);
      await fetchWithTimeout(targetUrl, {
        method: 'PUT',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }, 12000);
    } catch(e){
      if (isDebug()) showToast(`PUTå¤±æ•—: ${e.message}`, 8000);
    }
  }

  // ========= DB mergeï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šæ›¸ãç¦æ­¢ï¼‰ =========
  function mergeHistory(localH, cloudH) {
    const a = Array.isArray(localH) ? localH : [];
    const b = Array.isArray(cloudH) ? cloudH : [];
    const map = new Map();

    function put(h){
      if (!h || typeof h !== 'object') return;
      const ts = histTs(h);
      const price = Number(h.price);
      const store = String(h.store || '');
      const key = `${ts}|${price}|${store}`;
      if (!map.has(key)) map.set(key, h);
    }
    a.forEach(put);
    b.forEach(put);

    const out = Array.from(map.values()).sort((x,y) => histTs(x) - histTs(y));
    return out.length > 500 ? out.slice(-500) : out;
  }

  function mergeProduct(localP, cloudP) {
    const lp = (localP && typeof localP === 'object') ? localP : { history: [] };
    const cp = (cloudP && typeof cloudP === 'object') ? cloudP : { history: [] };

    const lts = lastHistoryTs(lp);
    const cts = lastHistoryTs(cp);

    // æ–°ã—ã„å±¥æ­´ã‚’æŒã¤å´ã‚’"æœ¬ä½“"ã«
    const base = deepClone((lts >= cts) ? lp : cp);
    const other = deepClone((lts >= cts) ? cp : lp);

    // historyã¯å¿…ãšãƒãƒ¼ã‚¸
    base.history = mergeHistory(lp.history, cp.history);
    
    // âœ… historyå†…ã®imageKey/imageUrlã‚‚ä¿è­·ï¼ˆæ·±ã„ãƒãƒ¼ã‚¸ï¼‰
    // ãƒãƒ¼ã‚¸å¾Œã®historyã§ã€ãƒ­ãƒ¼ã‚«ãƒ«ã®imageKey/imageUrlã‚’å„ªå…ˆä¿æŒ
    if (Array.isArray(base.history) && base.history.length > 0) {
      const localLast = Array.isArray(lp.history) && lp.history.length > 0 ? lp.history[lp.history.length - 1] : null;
      const cloudLast = Array.isArray(cp.history) && cp.history.length > 0 ? cp.history[cp.history.length - 1] : null;
      const mergedLast = base.history[base.history.length - 1];
      
      if (mergedLast && typeof mergedLast === 'object') {
        // æœ€å¾Œã®å±¥æ­´ã‚¨ãƒ³ãƒˆãƒªã®imageKey/imageUrlã‚’ä¿è­·
        if (localLast && localLast.imageKey && typeof localLast.imageKey === 'string') {
          mergedLast.imageKey = localLast.imageKey;
        } else if (cloudLast && cloudLast.imageKey && typeof cloudLast.imageKey === 'string') {
          mergedLast.imageKey = cloudLast.imageKey;
        }
        
        if (localLast && localLast.imageUrl && typeof localLast.imageUrl === 'string' && 
            (localLast.imageUrl.startsWith('http://') || localLast.imageUrl.startsWith('https://') || localLast.imageUrl.startsWith('data:'))) {
          mergedLast.imageUrl = localLast.imageUrl;
        } else if (cloudLast && cloudLast.imageUrl && typeof cloudLast.imageUrl === 'string' && 
                   (cloudLast.imageUrl.startsWith('http://') || cloudLast.imageUrl.startsWith('https://') || cloudLast.imageUrl.startsWith('data:'))) {
          mergedLast.imageUrl = cloudLast.imageUrl;
        }
      }
    }

    // æ–‡å­—ç³»ï¼šç©ºãªã‚‰è£œå®Œ
    const fields = ['name','maker','category','subCategory','imageUrl'];
    fields.forEach(k => {
      if ((!base[k] || String(base[k]).trim() === '') && other[k]) base[k] = other[k];
    });

    // âœ… ç”»åƒæƒ…å ±ï¼šç«¯æœ«å†…imageKeyã‚’æœ€å„ªå…ˆã§ä¿æŒã€imageUrlã¯ãƒãƒ¼ã‚¸
    if (lp.imageKey && typeof lp.imageKey === 'string') {
      base.imageKey = lp.imageKey; // ãƒ­ãƒ¼ã‚«ãƒ«ã®imageKeyã‚’æœ€å„ªå…ˆ
    } else if (cp.imageKey && typeof cp.imageKey === 'string') {
      base.imageKey = cp.imageKey; // ã‚¯ãƒ©ã‚¦ãƒ‰ã®imageKeyã¯å‚è€ƒç¨‹åº¦
    }
    // imageUrlã¯ä¸¡æ–¹ã‹ã‚‰å–å¾—ï¼ˆç©ºãªã‚‰è£œå®Œï¼‰
    if ((!base.imageUrl || !base.imageUrl.startsWith('http')) && other.imageUrl && 
        typeof other.imageUrl === 'string' && other.imageUrl.startsWith('http')) {
      base.imageUrl = other.imageUrl;
    }

    // æ—§imageã¯æ•´ç†
    if (typeof base.image === 'string' && base.image.startsWith('data:')) delete base.image;
    if (typeof base.imageUrl === 'string' && base.imageUrl.startsWith('data:')) delete base.imageUrl;

    if (!Array.isArray(base.history)) base.history = [];
    return base;
  }

  function mergeConfig(localC, cloudC) {
    const lc = (localC && typeof localC === 'object') ? deepClone(localC) : {};
    const cc = (cloudC && typeof cloudC === 'object') ? deepClone(cloudC) : {};

    // åŸºæœ¬ã¯ã‚¯ãƒ©ã‚¦ãƒ‰å„ªå…ˆï¼ˆç«¯æœ«é–“ã§æƒã„ã‚„ã™ã„ï¼‰
    const out = deepClone(cc);

    // ãŸã ã—ç©ºã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§è£œå®Œ
    if (!out.homeCity && lc.homeCity) out.homeCity = lc.homeCity;
    if (!out.lastTax && lc.lastTax) out.lastTax = lc.lastTax;

    // homeCities/customStoresã¯ãƒ¦ãƒ‹ã‚ªãƒ³
    const hc = [...new Set([...(Array.isArray(out.homeCities)?out.homeCities:[]), ...(Array.isArray(lc.homeCities)?lc.homeCities:[])])].filter(Boolean).slice(0,5);
    out.homeCities = hc;
    const cs = [...new Set([...(Array.isArray(out.customStores)?out.customStores:[]), ...(Array.isArray(lc.customStores)?lc.customStores:[])])].filter(Boolean).slice(0,20);
    out.customStores = cs;

    // categoryTreeã¯"æ¬ ã‘ã‚’è£œã†"
    if (!out.categoryTree || typeof out.categoryTree !== 'object') out.categoryTree = {};
    const ltree = (lc.categoryTree && typeof lc.categoryTree === 'object') ? lc.categoryTree : {};
    Object.keys(ltree).forEach(cat => {
      if (!out.categoryTree[cat]) out.categoryTree[cat] = deepClone(ltree[cat]);
      else {
        // ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã‚’è£œå®Œ
        const a = Array.isArray(out.categoryTree[cat]) ? out.categoryTree[cat] : [];
        const b = Array.isArray(ltree[cat]) ? ltree[cat] : [];
        out.categoryTree[cat] = [...new Set([...a,...b])];
      }
    });

    return out;
  }

  function mergeDb(localDb, cloudDb) {
    const ld = normalizeDb(deepClone(localDb || {}));
    const cd = normalizeDb(deepClone(cloudDb || {}));

    const merged = { products:{}, config:{} };
    const keys = new Set([...Object.keys(ld.products||{}), ...Object.keys(cd.products||{})]);

    keys.forEach(code => {
      merged.products[code] = mergeProduct(ld.products[code], cd.products[code]);
    });
    merged.config = mergeConfig(ld.config, cd.config);
    return normalizeDb(merged);
  }

  function lastHistoryTs(p) {
    try {
      const h = (p && Array.isArray(p.history) && p.history.length) ? p.history[p.history.length-1] : null;
      return histTs(h);
    } catch(e){ return 0; }
  }

  function deepClone(x) {
    try { return JSON.parse(JSON.stringify(x)); } catch(e){ return x; }
  }

  // âœ… åŒæœŸå‡¦ç†ã‚’åŸå­çš„ã«å®Ÿè¡Œï¼ˆãƒ­ãƒƒã‚¯ + æ¤œè¨¼ + ä¸€æ‹¬ä¿å­˜ï¼‰
  async function syncFirebase() {
    if(!fbUrl) return;
    
    // ãƒ­ãƒƒã‚¯ãƒã‚§ãƒƒã‚¯ï¼šæ—¢ã«å®Ÿè¡Œä¸­ãªã‚‰ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ ã—ã¦çµ‚äº†
    if (syncInFlight) {
      syncQueued = true;
      if (isDebug()) console.log('[Sync] Already in flight, queued');
      return;
    }
    
    // ãƒ­ãƒƒã‚¯å–å¾—
    syncInFlight = true;
    syncQueued = false;
    
    const startTime = Date.now();
    let syncResult = { success: false, itemsCount: 0, historyCount: 0, imageKeyCount: 0, error: null };
    
    try {
      // 1. ãƒ­ãƒ¼ã‚«ãƒ«DBã‚’èª­ã¿è¾¼ã¿
      const localDb = deepClone(db);
      
      // 2. ã‚¯ãƒ©ã‚¦ãƒ‰DBã‚’å–å¾—
      const targetUrl = getSafeUrl(fbUrl);
      const res = await fetchWithTimeout(targetUrl, {}, 12000);
      const cloudDb = await res.json();
      
      if (!cloudDb || typeof cloudDb !== 'object' || !cloudDb.products) {
        throw new Error('ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒç„¡åŠ¹ã§ã™');
      }
      
      // 3. ãƒãƒ¼ã‚¸ï¼ˆæ–°è¦ç”Ÿæˆï¼‰
      const mergedDb = mergeDb(localDb, cloudDb);
      
      // 4. æ¤œè¨¼
      const validation = validateMergedDb(mergedDb);
      if (!validation.valid) {
        throw new Error(`ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼å¤±æ•—: ${validation.error}`);
      }
      
      // 5. çµ±è¨ˆå–å¾—ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
      syncResult.itemsCount = Object.keys(mergedDb.products || {}).length;
      syncResult.historyCount = Object.values(mergedDb.products || {}).reduce((sum, p) => {
        return sum + (Array.isArray(p.history) ? p.history.length : 0);
      }, 0);
      syncResult.imageKeyCount = Object.values(mergedDb.products || {}).filter(p => 
        p && typeof p.imageKey === 'string' && p.imageKey.trim()
      ).length;
      
      // 6. ä¸€æ‹¬ä¿å­˜ï¼ˆåŸå­çš„ï¼‰
      db = mergedDb;
      const saveOk = saveLocalOnly();
      if (!saveOk) {
        throw new Error('ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
      
      // 7. UIæ›´æ–°
      initCategorySelect();
      await renderHistory();
      renderStoreList();
      
      syncResult.success = true;
      const elapsed = Date.now() - startTime;
      
      if (isDebug()) {
        const msg = `åŒæœŸæˆåŠŸ: ${syncResult.itemsCount}å•†å“ / ${syncResult.historyCount}å±¥æ­´ / ${syncResult.imageKeyCount}ç”»åƒ / ${elapsed}ms`;
        showToast(msg, 5000);
        console.log('[Sync]', msg);
      } else {
        showToast("åŒæœŸå®Œäº†", 2000);
      }
      
    } catch(e) {
      syncResult.error = e.message || String(e);
      if (isDebug()) {
        showToast(`åŒæœŸå¤±æ•—: ${syncResult.error}`, 8000);
        console.error('[Sync]', syncResult.error, e);
      } else {
        showToast("åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ", 5000);
      }
    } finally {
      // ãƒ­ãƒƒã‚¯è§£é™¤
      syncInFlight = false;
      
      // ã‚­ãƒ¥ãƒ¼ãŒã‚ã‚Œã°1å›ã ã‘å†å®Ÿè¡Œ
      if (syncQueued) {
        syncQueued = false;
        setTimeout(() => syncFirebase(), 100);
      }
    }
  }
  
  // âœ… ãƒãƒ¼ã‚¸æ¸ˆã¿DBã®æ¤œè¨¼
  function validateMergedDb(mergedDb) {
    try {
      if (!mergedDb || typeof mergedDb !== 'object') {
        return { valid: false, error: 'DBãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã‚ã‚Šã¾ã›ã‚“' };
      }
      
      if (!mergedDb.products || typeof mergedDb.products !== 'object') {
        return { valid: false, error: 'productsãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã‚ã‚Šã¾ã›ã‚“' };
      }
      
      if (!mergedDb.config || typeof mergedDb.config !== 'object') {
        return { valid: false, error: 'configãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã‚ã‚Šã¾ã›ã‚“' };
      }
      
      // productsã®å„è¦ç´ ã‚’æ¤œè¨¼
      for (const [code, p] of Object.entries(mergedDb.products)) {
        if (!p || typeof p !== 'object') {
          return { valid: false, error: `å•†å“${code}ãŒç„¡åŠ¹ã§ã™` };
        }
        if (!Array.isArray(p.history)) {
          return { valid: false, error: `å•†å“${code}ã®historyãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“` };
        }
        // historyã®å„è¦ç´ ã‚’æ¤œè¨¼
        for (let i = 0; i < p.history.length; i++) {
          const h = p.history[i];
          if (!h || typeof h !== 'object') {
            return { valid: false, error: `å•†å“${code}ã®å±¥æ­´${i}ãŒç„¡åŠ¹ã§ã™` };
          }
        }
      }
      
      return { valid: true };
    } catch(e) {
      return { valid: false, error: `æ¤œè¨¼ä¸­ã«ä¾‹å¤–: ${e.message || String(e)}` };
    }
  }

  // âœ… æ—§ data:image ãŒç«¯æœ«ã«æ®‹ã£ã¦ã„ã‚‹å ´åˆã®ã¿å¾©æ´»ã§ãã‚‹ï¼ˆæ®‹ã£ã¦ã„ãªã„ç«¯æœ«ã¯ç„¡ç†ï¼‰
  async function migrateLegacyImagesToIdb() {
    const dbi = await openImgDb();
    if (!dbi) return;

    let changed = false;
    const keys = Object.keys(db.products || {});
    for (const code of keys) {
      const p = db.products[code];
      if (!p) continue;

      // æ—§ image ãŒ data ã®å ´åˆ â†’ idbã¸ç§»è¡Œ
      if (typeof p.image === 'string' && p.image.startsWith('data:') && !p.imageKey) {
        const blob = dataUrlToBlob(p.image);
        if (blob) {
          const key = `img_${Date.now()}_${Math.random().toString(16).slice(2)}`;
          const ok = await idbPut(key, blob);
          if (ok) {
            p.imageKey = key;
            delete p.image;
            changed = true;
          }
        }
      }

      // æ—§ image ãŒ http ã®å ´åˆ â†’ imageUrlã¸
      if (typeof p.image === 'string' && (p.image.startsWith('http://') || p.image.startsWith('https://'))) {
        p.imageUrl = p.image;
        delete p.image;
        changed = true;
      }
    }

    if (changed) {
      saveLocalOnly();
      // ç”»åƒæœ¬ä½“ã¯é€ã‚‰ãªã„ãŒã€æ–‡å­—æƒ…å ±æ›´æ–°ã¯OK
      syncFirebasePut();
      if (isDebug()) showToast("æ—§ç”»åƒã‚’ç«¯æœ«å†…ã¸ç§»è¡Œã—ã¾ã—ãŸ", 5000);
    }
  }

  // ========= Category UI =========
  function initCategorySelect() {
    db = normalizeDb(db);
    const sel = document.getElementById('inputCategory');
    const sub = document.getElementById('inputSubCategory');
    if(!sel) return;

    const cats = Object.keys(db.config.categoryTree || {});
    sel.innerHTML = `<option value="__NONE__">ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã¶</option>` +
      cats.map(c => `<option value="${c}">${c}</option>`).join('') +
      `<option value="ADD">+ è¿½è¨˜</option>`;

    sel.onchange = async () => {
      if(sel.value === "ADD") {
        const n = await customPrompt("æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªå");
        if(n && n.trim()) {
          const name = n.trim();
          if (!db.config.categoryTree[name]) db.config.categoryTree[name] = ["ãã®ä»–"];
          db.config.categories = Object.keys(db.config.categoryTree);
          initCategorySelect();
          sel.value = name;
          initSubCategorySelect(name);
          saveLocalOnly(); syncFirebasePut();
        } else {
          sel.selectedIndex = 0;
          if (sub) sub.style.display = 'none';
        }
        return;
      }
      initSubCategorySelect(sel.value);
    };

    // åˆæœŸã¯éš ã™
    if (sub) sub.style.display = 'none';
  }

  function initSubCategorySelect(cat) {
    const sub = document.getElementById('inputSubCategory');
    if (!sub) return;
    if (!cat || cat === "__NONE__") { sub.style.display = 'none'; return; }

    db = normalizeDb(db); // âœ… æ­£è¦åŒ–ã‚’ç¢ºå®Ÿã«å®Ÿè¡Œ
    
    // âœ… categoryTreeãŒå­˜åœ¨ã—ãªã„ã€ã¾ãŸã¯ç©ºã®å ´åˆã€DEFAULT_CATEGORY_TREEã‹ã‚‰å–å¾—
    let list = [];
    if (db.config.categoryTree && db.config.categoryTree[cat] && Array.isArray(db.config.categoryTree[cat]) && db.config.categoryTree[cat].length > 0) {
      list = db.config.categoryTree[cat];
    } else if (DEFAULT_CATEGORY_TREE[cat] && Array.isArray(DEFAULT_CATEGORY_TREE[cat])) {
      // âœ… DEFAULT_CATEGORY_TREEã‹ã‚‰å–å¾—ã—ã¦ã€db.config.categoryTreeã«ä¿å­˜
      list = DEFAULT_CATEGORY_TREE[cat];
      if (!db.config.categoryTree) db.config.categoryTree = {};
      db.config.categoryTree[cat] = [...list];
      saveLocalOnly(); // ä¿å­˜ã—ã¦æ¬¡å›ã‹ã‚‰ä½¿ãˆã‚‹ã‚ˆã†ã«
    } else {
      list = ["ãã®ä»–"];
    }
    
    if (!list.includes("ãã®ä»–")) list = [...list, "ãã®ä»–"];

    sub.style.display = 'block';
    sub.innerHTML = `<option value="__NONE__">ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã¶</option>` +
      list.map(s => `<option value="${s}">${s}</option>`).join('') +
      `<option value="ADD_SUB">+ è¿½è¨˜</option>`;

    sub.onchange = async () => {
      if (sub.value === "ADD_SUB") {
        const n = await customPrompt("æ–°ã—ã„ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªå");
        if (n && n.trim()) {
          const name = n.trim();
          if (!db.config.categoryTree) db.config.categoryTree = {};
          if (!db.config.categoryTree[cat]) db.config.categoryTree[cat] = [];
          if (!db.config.categoryTree[cat].includes(name)) db.config.categoryTree[cat].push(name);
          if (!db.config.categoryTree[cat].includes("ãã®ä»–")) db.config.categoryTree[cat].push("ãã®ä»–");
          initSubCategorySelect(cat);
          sub.value = name;
          saveLocalOnly(); syncFirebasePut();
        } else {
          sub.selectedIndex = 0;
        }
      }
    };
  }

  // ========= Stores =========
  function addCustomStore(name) {
    db = normalizeDb(db);
    const s = (name || "").trim();
    if (!s) return;
    db.config.customStores = [s, ...(db.config.customStores || []).filter(x => x !== s)].slice(0, 20);
    saveLocalOnly();
    syncFirebasePut();
  }

  async function promptAddStore() {
    const n = await customPrompt("åº—åã‚’æ‰‹å…¥åŠ›ï¼ˆä¾‹ï¼šâ—‹â—‹ã‚¹ãƒ¼ãƒ‘ãƒ¼ï¼‰");
    if(n && n.trim()) {
      const s = n.trim();
      addCustomStore(s);
      curStore = s;
      const ind = document.getElementById('curStoreIndicator');
      if(ind) ind.innerText = `ã€ ${curStore} ã€‘ã§ä¿å­˜ã—ã¾ã™`;
      renderStoreList();
      showToast("åº—åã‚’è¿½åŠ ã—ã¾ã—ãŸ", 3000);
    }
  }

  function renderStoreList(manualPriority = []) {
    db = normalizeDb(db);
    const list = document.getElementById('store-list');
    if(!list) return;

    const freq = {};
    const storePositions = {}; // åº—å â†’ {lat, lng} ã®ãƒãƒƒãƒ—ï¼ˆå±¥æ­´ã‹ã‚‰å–å¾—ï¼‰
    
    Object.values(db.products).forEach(p => p.history?.forEach(h => {
      if(!h.store || h.store === "æœªè¨­å®š") return;
      freq[h.store] = (freq[h.store] || 0) + 1;
      // GPSä½ç½®æƒ…å ±ãŒã‚ã‚Œã°ä¿å­˜
      if (h.lat && h.lng && !storePositions[h.store]) {
        storePositions[h.store] = { lat: h.lat, lng: h.lng };
      }
    }));
    
    let sortedFreq = Object.keys(freq).sort((a,b) => freq[b] - freq[a]);
    
    // âœ… GPSãŒæœ‰åŠ¹ã§ä½ç½®æƒ…å ±ãŒã‚ã‚‹å ´åˆã€è¿‘ã„é †ã«ä¸¦ã³æ›¿ãˆ
    if (isGpsOn && curPos && Object.keys(storePositions).length > 0) {
      sortedFreq = sortedFreq.sort((a, b) => {
        const distA = storePositions[a] ? calcDistance(curPos.lat, curPos.lng, storePositions[a].lat, storePositions[a].lng) : 999;
        const distB = storePositions[b] ? calcDistance(curPos.lat, curPos.lng, storePositions[b].lat, storePositions[b].lng) : 999;
        return distA - distB;
      });
    }
    
    const cityStores = CITY_STORE_PRESET[db.config.homeCity] || [];
    const customStores = db.config.customStores || [];
    
    // âœ… è¿‘éš£åº—èˆ—å€™è£œã‚’çµ±åˆï¼ˆnearbyStoreNamesï¼‰
    const nearbyStores = (Array.isArray(window.nearbyStoreNames) && window.nearbyStoreNames.length > 0) ? window.nearbyStoreNames : [];
    
    // âœ… ç©ºãªã‚‰ ãƒ—ãƒªã‚»ãƒƒãƒˆ + customStores ã‚’å¿…ãšè¡¨ç¤º
    const finalSet = ["æœªè¨­å®š", ...new Set([...manualPriority, ...customStores, ...nearbyStores, ...cityStores, ...sortedFreq])];
    
    // âœ… å€™è£œãŒå–ã‚ŒãŸã‚‰å…ˆé ­ã‚’è‡ªå‹•é¸æŠï¼ˆcurStore ãŒ "æœªè¨­å®š" ã®å ´åˆã®ã¿ï¼‰
    if (curStore === "æœªè¨­å®š" && finalSet.length > 1) {
      curStore = finalSet[1]; // ã€Œæœªè¨­å®šã€ä»¥å¤–ã®æœ€åˆã®å€™è£œ
      if (isDebug()) console.log('[renderStoreList] Auto-select:', curStore);
    }

    const gpsTxt = isGpsOn ? `GPS<span class="gps-status">â—${lastGpsTime}</span>` : `GPS<span class="gps-status">OFF</span>`;
    list.innerHTML = `<span class="store-tag gps-btn ${isGpsOn?'on':''}" onclick="toggleGps()">${gpsTxt}</span>`;

    finalSet.forEach(name => {
      const span = document.createElement('span');
      span.className = 'store-tag' + (name === curStore ? ' active' : '');
      span.innerText = name;
      span.onclick = () => {
        document.querySelectorAll('.store-tag').forEach(s => s.classList.remove('active'));
        span.classList.add('active');
        curStore = name;
        const ind = document.getElementById('curStoreIndicator');
        if(ind) ind.innerText = `ã€ ${curStore} ã€‘ã§ä¿å­˜ã—ã¾ã™`;
        
        // âœ… ã‚¹ãƒˆã‚¢ã®ç¨åˆ¥/ç¨è¾¼æ—¢å®šå€¤ã‚’è‡ªå‹•åæ˜ 
        const storeTaxMode = db.config.storeTaxModes && db.config.storeTaxModes[curStore];
        if (storeTaxMode) {
          const taxModeId = storeTaxMode === "in" ? 'taxIn' : 'taxEx';
          const taxEl = document.getElementById(taxModeId);
          if (taxEl) {
            taxEl.checked = true;
            if (isDebug()) {
              console.log('[StoreTaxMode] Auto-switch:', curStore, 'â†’', storeTaxMode);
              showToast(`ç¨${storeTaxMode === "in" ? "è¾¼" : "åˆ¥"}ã«è‡ªå‹•åˆ‡æ›¿`, 2000);
            }
          }
        }
      };
      list.appendChild(span);
    });

    const addBtn = document.createElement('span');
    addBtn.className = 'store-tag add-store';
    addBtn.innerText = 'ï¼‹åº—åå…¥åŠ›';
    addBtn.onclick = () => promptAddStore();
    list.appendChild(addBtn);
  }

  // ========= Home History =========
  function placeholderImg() {
    return 'https://placehold.jp/24/333/ccc/68x68.png?text=NoImage';
  }

  // âœ… renderHistory() ã®äºŒé‡èµ·å‹•é˜²æ­¢
  let renderHistoryInFlight = false;
  let renderHistorySeq = 0;

  async function renderHistory() {
    // âœ… äºŒé‡èµ·å‹•é˜²æ­¢: æ—¢ã«å®Ÿè¡Œä¸­ãªã‚‰æœ€æ–°ã®å‘¼ã³å‡ºã—ã ã‘ã‚’åæ˜ 
    const mySeq = ++renderHistorySeq;
    
    if (renderHistoryInFlight) {
      if (isDebug()) console.log('[renderHistory] Already in flight, queued:', mySeq);
      // æœ€æ–°ã®å‘¼ã³å‡ºã—ã ã‘ã‚’åæ˜ ã™ã‚‹ãŸã‚ã€å°‘ã—å¾…ã£ã¦å†å®Ÿè¡Œ
      setTimeout(() => {
        if (renderHistorySeq === mySeq) {
          renderHistory();
        }
      }, 100);
      return;
    }
    
    renderHistoryInFlight = true;
    
    try {
    const list = document.getElementById('historyList');
    if(!list) return;
      
      // âœ… å¿…ãšã¾ã£ã•ã‚‰ã«ã™ã‚‹
    list.innerHTML = "";

    const items = Object.keys(db.products).map(k => ({ code: k, ...db.products[k] }));
    items.sort((a,b) => (histTs(b.history?.[b.history.length-1]) || 0) - (histTs(a.history?.[a.history.length-1]) || 0));

    // âœ… é‡è¤‡é˜²æ­¢ã‚¬ãƒ¼ãƒ‰ï¼ˆcodeã‚­ãƒ¼ + æ­£è¦åŒ–ã‚­ãƒ¼ï¼‰
    const renderedKeys = new Set();
    const renderedNormalizedKeys = new Set();

    for (const it of items) {
      if (!it.history || !it.history.length) continue;
      
      // codeã‚­ãƒ¼ã§é‡è¤‡ãƒã‚§ãƒƒã‚¯
      if (renderedKeys.has(it.code)) {
        if (isDebug()) console.log('[renderHistory] Skipped duplicate code:', it.code);
        continue;
      }
      
      // æ­£è¦åŒ–ã‚­ãƒ¼ã§é‡è¤‡ãƒã‚§ãƒƒã‚¯
      const normalized = normalizeProductName(it.name, it.maker);
      if (normalized && normalized !== '|' && renderedNormalizedKeys.has(normalized)) {
        if (isDebug()) console.log('[renderHistory] Skipped duplicate normalized:', it.code, normalized);
        continue;
      }
      
      renderedKeys.add(it.code);
      if (normalized && normalized !== '|') {
        renderedNormalizedKeys.add(normalized);
      }
      const last = it.history[it.history.length-1];
      const div = document.createElement('div');
      div.className = 'card price-card';
      div.onclick = (e) => {
        // âœ… ä»–ã®é¸æŠã‚’è§£é™¤
        document.querySelectorAll('.price-card.selected').forEach(el => el.classList.remove('selected'));
        // âœ… è‡ªåˆ†ã‚’é¸æŠ
        div.classList.add('selected');
        openForm(it.code);
      };

      // âœ… ç”»åƒè¡¨ç¤ºï¼šå„ªå…ˆé †ä½
      // 1. è‡ªåˆ†ã®ç”»åƒï¼ˆIndexedDB / imageUrlï¼‰
      // 2. å…±æœ‰ç”»åƒã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤ºï¼ˆå›ºå®šã—ãªã„ï¼‰
      const imgId = `img_${it.code.replace(/[^a-zA-Z0-9_-]/g,'_')}`;
      let imgSrc = placeholderImg();
      let hasMyImage = false;

      // è‡ªåˆ†ã®ç”»åƒã‚’ç¢ºèª
      if (it.imageKey && typeof it.imageKey === 'string') {
        imgSrc = placeholderImg();
        hasMyImage = true;
      } else if (last && last.imageKey && typeof last.imageKey === 'string') {
        imgSrc = placeholderImg();
        hasMyImage = true;
      } else if (it.imageUrl && typeof it.imageUrl === 'string' && 
                 (it.imageUrl.startsWith('http://') || it.imageUrl.startsWith('https://') || it.imageUrl.startsWith('data:'))) {
        imgSrc = it.imageUrl;
        hasMyImage = true;
      } else if (last && last.imageUrl && typeof last.imageUrl === 'string' && 
                 (last.imageUrl.startsWith('http://') || last.imageUrl.startsWith('https://') || last.imageUrl.startsWith('data:'))) {
        imgSrc = last.imageUrl;
        hasMyImage = true;
      }

      // è‡ªåˆ†ã®ç”»åƒãŒãªã„å ´åˆã€å…±æœ‰ç”»åƒã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤º
      if (!hasMyImage && fbUrl) {
        try {
          const sharedImages = await getSharedImages(it.code);
          if (sharedImages.length > 0) {
            // ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸ã¶
            const randomImg = sharedImages[Math.floor(Math.random() * sharedImages.length)];
            if (randomImg && randomImg.imageUrl) {
              imgSrc = randomImg.imageUrl;
            }
          }
        } catch(e) {
          if (isDebug()) console.warn('[renderHistory] getSharedImages failed:', e);
        }
      }

      div.innerHTML = `
        <div class="d-flex align-items-center">
          <img id="${imgId}" src="${imgSrc}" class="prod-thumb" referrerpolicy="no-referrer">
          <div class="flex-grow-1 overflow-hidden">
            <div class="fw-bold text-white small text-truncate">${it.name || ''}</div>
            <div class="text-secondary" style="font-size:0.6rem;">${last.store || 'æœªè¨­å®š'}</div>
          </div>
          <div class="text-end ms-2">
            <div class="price-main">${last.price}<span style="font-size:0.6rem;">å††</span></div>
          </div>
        </div>`;
      list.appendChild(div);

      // âœ… IndexedDBç”»åƒã‚’é©ç”¨ï¼ˆå„ªå…ˆé †ä½ï¼šlast.imageKey â†’ it.imageKeyã€å¤±æ•—æ™‚ã¯imageUrlã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
      const imgEl = div.querySelector('img.prod-thumb');
      if (imgEl) {
        imgEl.referrerPolicy = "no-referrer";
        
        // è‡ªåˆ†ã®ç”»åƒãŒã‚ã‚‹å ´åˆ
        if (hasMyImage) {
          const fallbackUrl = (last && last.imageUrl && typeof last.imageUrl === 'string' && 
                              (last.imageUrl.startsWith('http://') || last.imageUrl.startsWith('https://') || last.imageUrl.startsWith('data:'))) 
                              ? last.imageUrl 
                              : (it.imageUrl && typeof it.imageUrl === 'string' && 
                                 (it.imageUrl.startsWith('http://') || it.imageUrl.startsWith('https://') || it.imageUrl.startsWith('data:'))) 
                                 ? it.imageUrl 
                                 : null;
          
          if (last && last.imageKey && typeof last.imageKey === 'string') {
            applyImageKeyToImg(imgEl, last.imageKey).catch(() => {
              if (imgEl) {
                imgEl.src = fallbackUrl || placeholderImg();
              }
            });
          } else if (it.imageKey && typeof it.imageKey === 'string') {
            applyImageKeyToImg(imgEl, it.imageKey).catch(() => {
              if (imgEl) {
                imgEl.src = fallbackUrl || placeholderImg();
              }
            });
          } else if (fallbackUrl) {
            if (fallbackUrl.startsWith('shared:')) {
              // å…±æœ‰ç”»åƒã®å‚ç…§ï¼ˆå®Ÿéš›ã®ç”»åƒã¯Firebaseã‹ã‚‰å–å¾—ï¼‰
              const imageId = fallbackUrl.replace('shared:', '');
              if (fbUrl) {
                (async () => {
                  try {
                    const imageUrl = getImageUrl(fbUrl, it.code, imageId);
                    const res = await fetchWithTimeout(imageUrl, {}, 8000);
                    const record = await res.json();
                    if (record && record.imageUrl) {
                      imgEl.src = record.imageUrl;
                    } else {
                      imgEl.src = placeholderImg();
                    }
                  } catch(e) {
                    imgEl.src = placeholderImg();
                  }
                })();
              } else {
                imgEl.src = placeholderImg();
              }
            } else {
              imgEl.src = fallbackUrl;
            }
          }
        } else {
          // å…±æœ‰ç”»åƒã®å ´åˆã€èª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã¯åˆ¥ç”»åƒã«å·®ã—æ›¿ãˆ
          imgEl.onerror = async () => {
            try {
              const sharedImages = await getSharedImages(it.code);
              if (sharedImages.length > 0) {
                const randomImg = sharedImages[Math.floor(Math.random() * sharedImages.length)];
                if (randomImg && randomImg.imageUrl) {
                  imgEl.src = randomImg.imageUrl;
                } else {
                  imgEl.src = placeholderImg();
                }
              } else {
                imgEl.src = placeholderImg();
              }
            } catch(e) {
              imgEl.src = placeholderImg();
            }
          };
        }
      }
    }
    } finally {
      // âœ… ãƒ­ãƒƒã‚¯è§£é™¤
      renderHistoryInFlight = false;
    }
  }

  // ========= Form =========
  async function openForm(code) {
    const calcArea = document.getElementById('calcOptionArea');
    const saveBtn = document.getElementById('saveBtn');
    const delBtn = document.getElementById('delHistBtn');
    const storeJumpBtn = document.getElementById('storeJumpBtn');
    if(calcArea) calcArea.style.display = 'flex';
    if(saveBtn) saveBtn.innerText = 'ä¿å­˜';
    if(delBtn) delBtn.style.display = 'none';
    if(storeJumpBtn) storeJumpBtn.style.display = 'none';

    curBarcode = code; editingHistIdx = null;
    const p = db.products[code];
    const exists = !!p;

    initCategorySelect();
    document.getElementById('mainView').style.display='none';
    document.getElementById('formView').style.display='block';

    const ind = document.getElementById('curStoreIndicator');
    if(ind) ind.innerText = `ã€ ${curStore} ã€‘ã§ä¿å­˜ã—ã¾ã™`;
    document.getElementById('inputPrice').value = "";

    const catSel = document.getElementById('inputCategory');
    const subSel = document.getElementById('inputSubCategory');

    if (!exists) {
      document.getElementById('inputName').value = "";
      document.getElementById('inputMaker').value = "";
      if (catSel) catSel.value = "__NONE__";
      if (subSel) { subSel.style.display = 'none'; subSel.value = "__NONE__"; }
      const prev = document.getElementById('previewImg');
      if (prev) {
        prev.src = placeholderImg();
        prev.referrerPolicy = "no-referrer";
      }
      tempImgData = null;
      
      // âœ… æ–°è¦å•†å“ã®å ´åˆã€JANã‚³ãƒ¼ãƒ‰ãªã‚‰Yahooæ¤œç´¢ã‚’è©¦è¡Œ
      if (code && /^\d{8,14}$/.test(String(code))) {
        try {
          const info = await lookupYahooByJan(String(code));
          if (info) {
            if (info.name) document.getElementById('inputName').value = info.name;
            if (info.maker) document.getElementById('inputMaker').value = info.maker;
            if (info.imageUrl && prev) {
              prev.src = info.imageUrl;
              tempImgData = { type:'url', url: info.imageUrl };
            }
            showToast("å•†å“æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ", 3000);
          }
        } catch(e) {
          if (isDebug()) showToast(`æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼: ${e.message}`, 5000);
        }
      }
    } else {
      document.getElementById('inputName').value = p.name || "";
      document.getElementById('inputMaker').value = p.maker || "";

      const catVal = p.category || "__NONE__";
      if (catSel) {
        catSel.value = ([...catSel.options].some(o => o.value === catVal)) ? catVal : "__NONE__";
      }

      if (catVal && catVal !== "__NONE__") {
        initSubCategorySelect(catVal);
        const subVal = p.subCategory || "__NONE__";
        if (subSel) {
          subSel.value = ([...subSel.options].some(o => o.value === subVal)) ? subVal : "__NONE__";
        }
      } else {
        if (subSel) subSel.style.display = 'none';
      }

      // âœ… ç”»åƒè¡¨ç¤ºï¼šå„ªå…ˆé †ä½
      // 1. è‡ªåˆ†ã®ç”»åƒï¼ˆIndexedDB / imageUrlï¼‰
      // 2. å…±æœ‰ç”»åƒã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤ºï¼ˆå›ºå®šã—ãªã„ï¼‰
      const prev = document.getElementById('previewImg');
      if (prev) {
        const last = p.history && p.history.length > 0 ? p.history[p.history.length - 1] : null;
        prev.src = placeholderImg();
        prev.referrerPolicy = "no-referrer";
        
        let hasMyImage = false;
        
        // è‡ªåˆ†ã®ç”»åƒã‚’ç¢ºèª
        if (last && last.imageKey && typeof last.imageKey === 'string') {
          hasMyImage = true;
          applyImageKeyToImg(prev, last.imageKey).catch(() => {
            if (p.imageKey && typeof p.imageKey === 'string') {
              applyImageKeyToImg(prev, p.imageKey).catch(() => {
                if (last && last.imageUrl && typeof last.imageUrl === 'string' && (last.imageUrl.startsWith('http') || last.imageUrl.startsWith('data:'))) {
                  prev.src = last.imageUrl;
                } else if (p.imageUrl && typeof p.imageUrl === 'string' && (p.imageUrl.startsWith('http') || p.imageUrl.startsWith('data:') || p.imageUrl.startsWith('shared:'))) {
                if (p.imageUrl.startsWith('shared:')) {
                  const imageId = p.imageUrl.replace('shared:', '');
                  if (fbUrl) {
                    (async () => {
                      try {
                        const imageUrl = getImageUrl(fbUrl, curBarcode, imageId);
                        const res = await fetchWithTimeout(imageUrl, {}, 8000);
                        const record = await res.json();
                        if (record && record.imageUrl) {
                          prev.src = record.imageUrl;
                        } else {
                          prev.src = placeholderImg();
                        }
                      } catch(e) {
                        prev.src = placeholderImg();
                      }
                    })();
                  } else {
                    prev.src = placeholderImg();
                  }
                } else {
                  prev.src = p.imageUrl;
                }
                } else {
                  prev.src = placeholderImg();
                }
              });
            } else {
              if (last && last.imageUrl && typeof last.imageUrl === 'string' && (last.imageUrl.startsWith('http') || last.imageUrl.startsWith('data:') || last.imageUrl.startsWith('shared:'))) {
                if (last.imageUrl.startsWith('shared:')) {
                  const imageId = last.imageUrl.replace('shared:', '');
                  if (fbUrl) {
                    (async () => {
                      try {
                        const imageUrl = getImageUrl(fbUrl, curBarcode, imageId);
                        const res = await fetchWithTimeout(imageUrl, {}, 8000);
                        const record = await res.json();
                        if (record && record.imageUrl) {
                          prev.src = record.imageUrl;
                        } else {
                          prev.src = placeholderImg();
                        }
                      } catch(e) {
                        prev.src = placeholderImg();
                      }
                    })();
                  } else {
                    prev.src = placeholderImg();
                  }
                } else {
                  prev.src = last.imageUrl;
                }
              } else if (p.imageUrl && typeof p.imageUrl === 'string' && (p.imageUrl.startsWith('http') || p.imageUrl.startsWith('data:') || p.imageUrl.startsWith('shared:'))) {
                if (p.imageUrl.startsWith('shared:')) {
                  const imageId = p.imageUrl.replace('shared:', '');
                  if (fbUrl) {
                    (async () => {
                      try {
                        const imageUrl = getImageUrl(fbUrl, curBarcode, imageId);
                        const res = await fetchWithTimeout(imageUrl, {}, 8000);
                        const record = await res.json();
                        if (record && record.imageUrl) {
                          prev.src = record.imageUrl;
                        } else {
                          prev.src = placeholderImg();
                        }
                      } catch(e) {
                        prev.src = placeholderImg();
                      }
                    })();
                  } else {
                    prev.src = placeholderImg();
                  }
                } else {
                  prev.src = p.imageUrl;
                }
              } else {
                prev.src = placeholderImg();
              }
            }
          });
        } else if (p.imageKey && typeof p.imageKey === 'string') {
          hasMyImage = true;
          applyImageKeyToImg(prev, p.imageKey).catch(() => {
            if (last && last.imageUrl && typeof last.imageUrl === 'string' && (last.imageUrl.startsWith('http') || last.imageUrl.startsWith('data:') || last.imageUrl.startsWith('shared:'))) {
              if (last.imageUrl.startsWith('shared:')) {
                const imageId = last.imageUrl.replace('shared:', '');
                if (fbUrl) {
                  (async () => {
                    try {
                      const imageUrl = getImageUrl(fbUrl, curBarcode, imageId);
                      const res = await fetchWithTimeout(imageUrl, {}, 8000);
                      const record = await res.json();
                      if (record && record.imageUrl) {
                        prev.src = record.imageUrl;
                      } else {
                        prev.src = placeholderImg();
                      }
                    } catch(e) {
                      prev.src = placeholderImg();
                    }
                  })();
                } else {
                  prev.src = placeholderImg();
                }
              } else {
                prev.src = last.imageUrl;
              }
            } else if (p.imageUrl && typeof p.imageUrl === 'string' && (p.imageUrl.startsWith('http') || p.imageUrl.startsWith('data:') || p.imageUrl.startsWith('shared:'))) {
              if (p.imageUrl.startsWith('shared:')) {
                const imageId = p.imageUrl.replace('shared:', '');
                if (fbUrl) {
                  (async () => {
                    try {
                      const imageUrl = getImageUrl(fbUrl, curBarcode, imageId);
                      const res = await fetchWithTimeout(imageUrl, {}, 8000);
                      const record = await res.json();
                      if (record && record.imageUrl) {
                        prev.src = record.imageUrl;
                      } else {
                        prev.src = placeholderImg();
                      }
                    } catch(e) {
                      prev.src = placeholderImg();
                    }
                  })();
                } else {
                  prev.src = placeholderImg();
                }
              } else {
                prev.src = p.imageUrl;
              }
            } else {
              prev.src = placeholderImg();
            }
          });
      } else if (last && last.imageUrl && typeof last.imageUrl === 'string' && (last.imageUrl.startsWith('http') || last.imageUrl.startsWith('data:') || last.imageUrl.startsWith('shared:'))) {
        if (last.imageUrl.startsWith('shared:')) {
          // å…±æœ‰ç”»åƒã®å‚ç…§ï¼ˆè‡ªåˆ†ã®ç”»åƒã¨ã—ã¦æ‰±ã†ï¼‰
          hasMyImage = true;
          const imageId = last.imageUrl.replace('shared:', '');
          if (fbUrl) {
            try {
              const imageUrl = getImageUrl(fbUrl, curBarcode, imageId);
              const res = await fetchWithTimeout(imageUrl, {}, 8000);
              const record = await res.json();
              if (record && record.imageUrl) {
                prev.src = record.imageUrl;
              } else {
                prev.src = placeholderImg();
              }
            } catch(e) {
              prev.src = placeholderImg();
            }
          } else {
            prev.src = placeholderImg();
          }
        } else {
          prev.src = last.imageUrl;
          hasMyImage = true;
        }
      } else if (p.imageUrl && typeof p.imageUrl === 'string' && (p.imageUrl.startsWith('http') || p.imageUrl.startsWith('data:') || p.imageUrl.startsWith('shared:'))) {
        if (p.imageUrl.startsWith('shared:')) {
          // å…±æœ‰ç”»åƒã®å‚ç…§ï¼ˆè‡ªåˆ†ã®ç”»åƒã¨ã—ã¦æ‰±ã†ï¼‰
          hasMyImage = true;
          const imageId = p.imageUrl.replace('shared:', '');
          if (fbUrl) {
            try {
              const imageUrl = getImageUrl(fbUrl, curBarcode, imageId);
              const res = await fetchWithTimeout(imageUrl, {}, 8000);
              const record = await res.json();
              if (record && record.imageUrl) {
                prev.src = record.imageUrl;
              } else {
                prev.src = placeholderImg();
              }
            } catch(e) {
              prev.src = placeholderImg();
            }
          } else {
            prev.src = placeholderImg();
          }
        } else {
          prev.src = p.imageUrl;
          hasMyImage = true;
        }
      }

        // è‡ªåˆ†ã®ç”»åƒãŒãªã„å ´åˆã€å…±æœ‰ç”»åƒã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ è¡¨ç¤º
        if (!hasMyImage && fbUrl) {
          (async () => {
            try {
              const sharedImages = await getSharedImages(curBarcode);
              if (sharedImages.length > 0) {
                const randomImg = sharedImages[Math.floor(Math.random() * sharedImages.length)];
                if (randomImg && randomImg.imageUrl) {
                  prev.src = randomImg.imageUrl;
                  // èª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã¯åˆ¥ç”»åƒã«å·®ã—æ›¿ãˆ
                  prev.onerror = async () => {
                    try {
                      const retryImages = await getSharedImages(curBarcode);
                      if (retryImages.length > 0) {
                        const retryImg = retryImages[Math.floor(Math.random() * retryImages.length)];
                        if (retryImg && retryImg.imageUrl) {
                          prev.src = retryImg.imageUrl;
                        } else {
                          prev.src = placeholderImg();
                        }
                      } else {
                        prev.src = placeholderImg();
                      }
                    } catch(e) {
                      prev.src = placeholderImg();
                    }
                  };
                }
              }
            } catch(e) {
              if (isDebug()) console.warn('[openForm] getSharedImages failed:', e);
            }
          })();
        }
      }
      tempImgData = null; // æ–°è¦é¸æŠãŒã‚ã‚Œã°ä¸Šæ›¸ã
    }

    renderDetailHistory(exists ? p.history : []);
    renderStats(exists ? p.history : []);
  }

  function renderStats(history) {
    const box = document.getElementById('statsBox');
    if (!box) return;
    if (!Array.isArray(history) || history.length === 0) { box.innerHTML = "éå»ãƒ‡ãƒ¼ã‚¿ãªã—"; return; }
    const pArr = history.map(h => h.price);
    const avg = Math.floor(pArr.reduce((a,b)=>a+b,0)/pArr.length);
    const low = Math.min(...pArr);
    const last = pArr[pArr.length-1];
    box.innerHTML = `<div class="stats-row">
      <div class="stat-item">å¹³å‡<span class="stat-val">${avg}å††</span></div>
      <div class="stat-item">æœ€å®‰<span class="stat-val text-danger">${low}å††</span></div>
      <div class="stat-item">å‰å›<span class="stat-val">${last}å††</span></div>
    </div>`;
  }

  function renderDetailHistory(history) {
    const div = document.getElementById('detailHistory');
    if(!div) return;
    div.innerHTML = "";
    const safeHistory = Array.isArray(history) ? history : [];

    [...safeHistory].reverse().forEach((h, idx) => {
      const row = document.createElement('div');
      row.className = "history-row";
      const actIdx = safeHistory.length - 1 - idx;

      if (editingHistIdx !== null && actIdx === editingHistIdx) row.classList.add("selected");
      row.onclick = () => editHistoryMode(actIdx);

      const t = histTs(h);
      const dateStr = t ? new Date(t).toLocaleString() : "(ä¸æ˜)";
      row.innerHTML = `
        <div class="flex-grow-1">
          <span class="text-secondary small">${dateStr}</span><br>
          <span class="text-white fw-bold">${h.store || 'æœªè¨­å®š'}</span>
        </div>
        <div class="text-end">
          <span class="fw-bold text-white">${h.price}å††</span><br>
          <span class="text-info small">ã‚¿ãƒƒãƒ—ã§ç·¨é›†</span>
        </div>`;
      div.appendChild(row);
    });
  }

  function editHistoryMode(idx) {
    editingHistIdx = idx;

    const p = db.products[curBarcode];
    const h = p && Array.isArray(p.history) ? p.history[idx] : null;
    if(!h) return;

    document.getElementById('inputPrice').value = h.price;
    document.getElementById('inputDisc').value = 0;
    document.getElementById('taxIn').checked = true;

    curStore = h.store || "æœªè¨­å®š";
    const ind = document.getElementById('curStoreIndicator');
    if(ind) ind.innerText = `ã€ ${curStore} ã€‘ã§ä¿å­˜ã—ã¾ã™`;

    renderStoreList();
    document.getElementById('calcOptionArea').style.display = "none";
    document.getElementById('saveBtn').innerText = "å¤‰æ›´ç¢ºå®š";
    document.getElementById('delHistBtn').style.display = "block";
    document.getElementById('storeJumpBtn').style.display = "block";

    renderDetailHistory(p.history);

    window.scrollTo({ top: 0, behavior: 'smooth' });
    showToast("åº—åã¯ä¸Šã®ãƒãƒƒãƒ—ã§å¤‰æ›´ã§ãã¾ã™", 3000);
    document.getElementById('priceSection').scrollIntoView({behavior: 'smooth'});
  }

  function jumpToStoreChips() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
    showToast("ä¸Šã®åº—åãƒãƒƒãƒ—ã§å¤‰æ›´ã§ãã¾ã™", 3000);
  }

  async function saveData() {
    const saveBtn = document.getElementById('saveBtn');
    
    // âœ… ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆäºŒåº¦æŠ¼ã—é˜²æ­¢ï¼‰
    if (saveBtn) saveBtn.disabled = true;
    
    try {
      if (curStore === "æœªè¨­å®š") {
        showToast("åº—åã‚’é¸ã‚“ã§ãã ã•ã„", 4000);
        if (saveBtn) saveBtn.disabled = false;
        return;
      }

      const cat = document.getElementById('inputCategory').value;
      if (cat === "__NONE__") {
        showToast("ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãã ã•ã„", 4000);
        if (saveBtn) saveBtn.disabled = false;
        return;
      }

      const subSel = document.getElementById('inputSubCategory');
      const needsSub = (subSel && subSel.style.display !== 'none');
      const sub = needsSub ? subSel.value : "__NONE__";
      if (needsSub && sub === "__NONE__") {
        showToast("ã‚µãƒ–ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãã ã•ã„", 4000);
        if (saveBtn) saveBtn.disabled = false;
        return;
      }

      const p = db.products[curBarcode] || { history: [] };
      p.name = document.getElementById('inputName').value || "åç§°ãªã—";
      p.category = cat;
      p.subCategory = needsSub ? sub : "";
      p.maker = document.getElementById('inputMaker').value || "";

      // âœ… ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
      if (isDebug()) {
        console.log("[SaveData] code:", curBarcode, "store:", curStore, "category:", cat, "subCategory:", sub);
      }

      // âœ… ç”»åƒï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰â†’ Firebaseå…±æœ‰ã¾ãŸã¯IndexedDBã¸ä¿å­˜
      if (tempImgData && tempImgData.type === 'shared' && tempImgData.imageId) {
        // å…±æœ‰ç”»åƒã®å ´åˆã€imageUrlã«å…±æœ‰ç”»åƒã®URLã‚’ä¿å­˜ï¼ˆå‚ç…§ã®ã¿ï¼‰
        // å®Ÿéš›ã®ç”»åƒãƒ‡ãƒ¼ã‚¿ã¯Firebaseã«ä¿å­˜æ¸ˆã¿
        p.imageUrl = `shared:${tempImgData.imageId}`;
        delete p.image;
        delete p.imageKey; // å…±æœ‰ç”»åƒã¯imageKeyã‚’ä½¿ã‚ãªã„
      } else if (tempImgData && typeof tempImgData === 'string' && tempImgData.startsWith('data:')) {
        // æ—§æ–¹å¼ï¼šdataURL â†’ IndexedDB
        const blob = dataURLtoBlob(tempImgData);
        if (blob) {
          const key = 'img_' + String(curBarcode || '').replace(/[^\w\-]/g, '_');
          await idbPut(key, blob);
          p.imageKey = key;
        }
        delete p.imageData;
        delete p.image;
      } else if (tempImgData && tempImgData.type === 'key') {
        p.imageKey = tempImgData.key;
        delete p.image;
      } else if (tempImgData && tempImgData.type === 'url') {
        p.imageUrl = tempImgData.url;
        delete p.image;
      }

      const val = Number(document.getElementById('inputPrice').value);
      if (!Number.isFinite(val) || val <= 0) {
        showToast("ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", 4000);
        if (saveBtn) saveBtn.disabled = false;
        return;
      }

      if (editingHistIdx !== null) {
        p.history[editingHistIdx].price = val;
        p.history[editingHistIdx].store = curStore;
        showToast("å¤‰æ›´ã‚’åæ˜ ã—ã¾ã—ãŸ", 2000);
        if (isDebug()) console.log("[SaveData] History updated:", editingHistIdx);
      } else {
        const disc = Number(document.getElementById('inputDisc').value || 0);
        let finalP = Math.floor(val * (1 - disc/100));
        const isTaxEx = document.getElementById('taxEx').checked;
        if(isTaxEx) finalP = Math.floor(finalP * 1.08);
        db.config.lastTax = isTaxEx ? "ex" : "in";
        
        // âœ… ã‚¹ãƒˆã‚¢ã®ç¨åˆ¥/ç¨è¾¼æ—¢å®šå€¤ã‚’ä¿å­˜ï¼ˆä¸€åº¦è¨­å®šã—ãŸã‚‰ä»¥å¾Œè‡ªå‹•åˆ‡æ›¿ï¼‰
        if (curStore && curStore !== "æœªè¨­å®š") {
          if (!db.config.storeTaxModes) db.config.storeTaxModes = {};
          db.config.storeTaxModes[curStore] = isTaxEx ? "ex" : "in";
          if (isDebug()) {
            console.log('[StoreTaxMode] Saved:', curStore, 'â†’', db.config.storeTaxModes[curStore]);
          }
        }
        const entry = { price: finalP, store: curStore, ts: Date.now() };
        if(curPos) { entry.lat = curPos.lat; entry.lng = curPos.lng; }
        p.history.push(entry);
        showToast("ä¿å­˜å®Œäº†", 2000);
        if (isDebug()) console.log("[SaveData] New entry added:", entry);
      }

      db.products[curBarcode] = p;
      db = normalizeDb(db);

      saveLocalOnly();
      syncFirebasePut();

      renderHistory();
      showHome();
      
      if (isDebug()) console.log("[SaveData] Save completed successfully");
      
    } catch(e) {
      showToast("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ", 8000);
      if (isDebug()) {
        console.error("[SaveData] Error:", e);
        console.error("[SaveData] Stack:", e.stack);
      }
    } finally {
      // âœ… ç¢ºå®Ÿã«ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
      if (saveBtn) saveBtn.disabled = false;
    }
  }

  function toggleHistoryList() {
    const div = document.getElementById('detailHistory');
    const btn = document.getElementById('toggleHistBtn');
    if (!div || !btn) return;
    const isHidden = (div.style.display === "none" || !div.style.display);
    div.style.display = isHidden ? "block" : "none";
    btn.innerText = isHidden ? "è³¼å…¥å±¥æ­´ã‚’éš ã™" : "è³¼å…¥å±¥æ­´ã‚’è¡¨ç¤ºï¼ˆã‚¿ãƒƒãƒ—ã§ç·¨é›†ï¼‰";
  }

  // ========= GPSè·é›¢è¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼šãƒãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ³å…¬å¼ï¼‰ =========
  function calcDistance(lat1, lng1, lat2, lng2) {
    const R = 6371; // åœ°çƒã®åŠå¾„ï¼ˆkmï¼‰
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
  }

  function toggleGps() {
    if(!isGpsOn) {
      isGpsOn = true; lastGpsTime = "â€¦"; renderStoreList(); 
      showToast("GPSå–å¾—ä¸­â€¦", 3000);
      
      if (!navigator.geolocation) {
        showToast("GPSæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“", 5000);
        isGpsOn = false; renderStoreList();
        return;
      }

      navigator.geolocation.getCurrentPosition(async (pos) => {
        curPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        const d = new Date(); lastGpsTime = `${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
        
        // âœ… GPSå–å¾—æˆåŠŸå¾Œã€è¿‘éš£åº—èˆ—ã‚’å–å¾—ã—ã¦ãƒªã‚¹ãƒˆã‚’æ›´æ–°
        try {
          const nearbyStores = await fetchNearbyStores();
          if (nearbyStores && nearbyStores.length > 0) {
            window.nearbyStoreNames = nearbyStores;
            if (isDebug()) console.log('[GPS] Nearby stores loaded:', nearbyStores.length);
          }
        } catch(e) {
          if (isDebug()) console.warn('[GPS] fetchNearbyStores failed:', e);
        }
        
        renderStoreList();
        
        const msg = isDebug() 
          ? `GPSå–å¾—æˆåŠŸï¼ˆ${curPos.lat.toFixed(4)}, ${curPos.lng.toFixed(4)}ï¼‰` 
          : "GPSå–å¾—æˆåŠŸ";
        showToast(msg, 2000);
      }, (err) => {
        const errMsg = err.code === 1 ? "ä½ç½®æƒ…å ±ã®å–å¾—ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ" :
                      err.code === 2 ? "ä½ç½®æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ" :
                      err.code === 3 ? "ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ" :
                      `GPSã‚¨ãƒ©ãƒ¼: ${err.message}`;
        showToast(errMsg, 8000);
        isGpsOn = false; curPos = null; lastGpsTime = ""; renderStoreList();
      }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 });
    } else {
      isGpsOn = false; curPos = null; lastGpsTime = ""; 
      window.nearbyStoreNames = []; // GPS OFFæ™‚ã¯è¿‘éš£åº—èˆ—å€™è£œã‚‚ã‚¯ãƒªã‚¢
      renderStoreList(); 
      showToast("GPS OFF", 1500);
    }
  }

  // ========= Yahooå•†å“æƒ…å ±ã®è‡ªå‹•æ•´å½¢ï¼ˆ12æœ¬1ç®±å•é¡Œå¯¾å¿œï¼‰ =========
  // ========= æ±ç”¨æ­£è¦åŒ–é–¢æ•°ï¼ˆãƒ¡ãƒ¼ã‚«ãƒ¼å/è²©å£²åº—åæ··å…¥é™¤å»ï¼‰ =========
  function normalizeMakerName(maker) {
    if (!maker || !maker.trim()) return maker || '';
    let normalized = String(maker).trim();
    
    // âœ… è²©å£²åº—åãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’é™¤å»ï¼ˆå¼·åŒ–ç‰ˆï¼‰
    const storePatterns = [
      /\s*åº—\s*$/gi,
      /\s*ã‚¹ãƒˆã‚¢\s*$/gi,
      /\s*ã‚·ãƒ§ãƒƒãƒ—\s*$/gi,
      /\s*ã‚¹ãƒˆã‚¢ãƒ¼ã‚º\s*$/gi,
      /\s*ã‚·ãƒ§ãƒƒãƒ—ã‚¹\s*$/gi,
      /\s*ãƒ¢ãƒ¼ãƒ«\s*$/gi,
      /\s*ãƒãƒ¼ã‚±ãƒƒãƒˆ\s*$/gi,
      /\s*ãƒ‰ãƒƒãƒˆã‚³ãƒ \s*$/gi,
      /\s*\.com\s*$/gi,
      /\s*\.co\.jp\s*$/gi,
      /æ¥½å¤©/gi,
      /Amazon/gi,
      /ãƒ¤ãƒ•ãƒ¼/gi,
      /Yahoo/gi,
      /Rakuten/gi,
      /ãƒ¡ãƒ«ã‚«ãƒª/gi,
      /mercari/gi,
      /å…¬å¼/gi,
      /Official/gi,
      /æœ¬åº—/gi,
      /æ”¯åº—/gi,
      /ã‚ªãƒ³ãƒ©ã‚¤ãƒ³/gi,
      /ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ/gi,
      /\s*inc\s*$/gi,
      /\s*ltd\s*$/gi,
      /\s*corp\s*$/gi,
      /\s*group\s*$/gi
    ];
    
    storePatterns.forEach(pattern => {
      normalized = normalized.replace(pattern, '');
    });
    
    // âœ… ãƒ¡ãƒ¼ã‚«ãƒ¼é‡è¤‡ã‚’é™¤å»ï¼ˆä¾‹ï¼šã€Œã‚³ã‚«ãƒ»ã‚³ãƒ¼ãƒ© ã‚³ã‚«ãƒ»ã‚³ãƒ¼ãƒ©ã€â†’ã€Œã‚³ã‚«ãƒ»ã‚³ãƒ¼ãƒ©ã€ï¼‰
    const words = normalized.split(/\s+/).filter(w => w.length > 0);
    const uniqueWords = [];
    const seen = new Set();
    words.forEach(word => {
      const lower = word.toLowerCase();
      if (!seen.has(lower)) {
        seen.add(lower);
        uniqueWords.push(word);
      }
    });
    normalized = uniqueWords.join(' ');
    
    normalized = normalized.replace(/\s+/g, ' ').trim();
    return normalized || maker; // ç©ºã«ãªã£ãŸå ´åˆã¯å…ƒã«æˆ»ã™
  }

  function normalizeYahooProductInfo(info) {
    if (!info || !info.name) return info;
    
    const original = {
      name: info.name,
      maker: info.maker || '',
      imageUrl: info.imageUrl || ''
    };
    
    let name = original.name;
    let maker = original.maker;
    let packHint = false; // ã¾ã¨ã‚è²·ã„æ¤œå‡ºãƒ•ãƒ©ã‚°
    let packCount = null; // ã¾ã¨ã‚è²·ã„å€‹æ•°
    let isCase = false; // ã‚±ãƒ¼ã‚¹å•†å“ãƒ•ãƒ©ã‚°
    let trustScore = 100; // ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ï¼ˆåˆæœŸå€¤100ï¼‰
    
    // âœ… 1. ã¾ã¨ã‚è²·ã„èªã‚’æ¤œå‡ºï¼ˆä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ä»˜ããƒ»å¼·åŒ–ç‰ˆï¼‰
    const bulkPatterns = [
      { pattern: /Ã—\s*(\d+)\s*(æœ¬|å€‹|ç¼¶|è¢‹|ãƒ‘ãƒƒã‚¯)/gi, trust: 90 }, // packç–‘ã„å¼·
      { pattern: /(\d+)\s*(æœ¬|å€‹|ç¼¶|è¢‹|ãƒ‘ãƒƒã‚¯)\s*Ã—/gi, trust: 90 },
      { pattern: /(\d+)\s*(æœ¬|å€‹|ç¼¶|è¢‹|ãƒ‘ãƒƒã‚¯)\s*ã‚»ãƒƒãƒˆ/gi, trust: 85 },
      { pattern: /ã‚±ãƒ¼ã‚¹/gi, trust: 80 },
      { pattern: /ç®±/gi, trust: 75 }, // ã€Œç®±ã€å˜ç‹¬ã‚‚æ¤œå‡º
      { pattern: /ç®±è²·ã„/gi, trust: 75 },
      { pattern: /ã¾ã¨ã‚è²·ã„/gi, trust: 70 },
      { pattern: /ã‚»ãƒƒãƒˆè²©å£²/gi, trust: 70 },
      { pattern: /æ¥­å‹™ç”¨/gi, trust: 75 }, // æ¥­å‹™ç”¨ã‚‚æ¤œå‡º
      { pattern: /\[\s*(\d+)\s*(æœ¬|å€‹|ç¼¶|è¢‹|ãƒ‘ãƒƒã‚¯)\s*\]/gi, trust: 85 }
    ];
    
    let maxPackTrust = 0;
    bulkPatterns.forEach(({ pattern, trust }) => {
      const match = pattern.exec(name);
      if (match) {
        packHint = true;
        if (trust > maxPackTrust) {
          maxPackTrust = trust;
        }
        // packCountã‚’æŠ½å‡ºï¼ˆæ•°å­—éƒ¨åˆ†ï¼‰
        if (match[1]) {
          const count = parseInt(match[1], 10);
          if (count > 1 && (!packCount || count > packCount)) {
            packCount = count;
          }
        }
        // ã‚±ãƒ¼ã‚¹åˆ¤å®š
        if (/ã‚±ãƒ¼ã‚¹|ç®±è²·ã„|ã¾ã¨ã‚è²·ã„|ã‚»ãƒƒãƒˆè²©å£²/i.test(match[0])) {
          isCase = true;
        }
      }
    });
    
    // âœ… ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢èª¿æ•´ï¼ˆpackç–‘ã„ãŒå¼·ã„ã¨ããƒ»å¼·åŒ–ç‰ˆï¼‰
    if (maxPackTrust >= 80) {
      trustScore -= 30; // packç–‘ã„å¼·ï¼ˆã‚¹ã‚³ã‚¢ã‚’ä¸‹ã’ã‚‹ï¼‰
    } else if (maxPackTrust >= 70) {
      trustScore -= 20; // packç–‘ã„ä¸­ï¼ˆã‚¹ã‚³ã‚¢ã‚’ä¸‹ã’ã‚‹ï¼‰
    }
    
    // âœ… è¿½åŠ ï¼šå•†å“åã«è²©å£²åº—åã£ã½ã„èªãŒæ··å…¥ã—ã¦ã„ã‚‹å ´åˆã‚‚ã‚¹ã‚³ã‚¢ã‚’ä¸‹ã’ã‚‹
    const storeNamePatterns = [
      /æ¥½å¤©/gi, /Amazon/gi, /ãƒ¤ãƒ•ãƒ¼/gi, /Yahoo/gi, /Rakuten/gi,
      /ãƒ¡ãƒ«ã‚«ãƒª/gi, /mercari/gi, /å…¬å¼/gi, /Official/gi,
      /æœ¬åº—/gi, /æ”¯åº—/gi, /ã‚ªãƒ³ãƒ©ã‚¤ãƒ³/gi, /ãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ/gi
    ];
    let hasStoreName = false;
    storeNamePatterns.forEach(pattern => {
      if (pattern.test(name)) {
        hasStoreName = true;
      }
    });
    if (hasStoreName) {
      trustScore -= 15; // è²©å£²åº—åæ··å…¥ã§ã‚¹ã‚³ã‚¢ã‚’ä¸‹ã’ã‚‹
    }
    
    // âœ… 2. ä¸è¦ãªè²©ä¿ƒæ–‡è¨€ã‚’é™¤å»
    const promoPatterns = [
      /ã€Œ[^ã€]*é€æ–™[^ã€]*ã€/gi,
      /ã€Œ[^ã€]*ç„¡æ–™[^ã€]*ã€/gi,
      /ã€Œ[^ã€]*åœ°åŸŸé™å®š[^ã€]*ã€/gi,
      /ã€Œ[^ã€]*æœ€çŸ­[^ã€]*ã€/gi,
      /ã€Œ[^ã€]*å…¬å¼[^ã€]*ã€/gi,
      /ã€Œ[^ã€]*PayPay[^ã€]*ã€/gi,
      /ã€Œ[^ã€]*ãƒã‚¤ãƒ³ãƒˆ[^ã€]*ã€/gi,
      /ã€[^ã€‘]*é€æ–™[^ã€‘]*ã€‘/gi,
      /ã€[^ã€‘]*ç„¡æ–™[^ã€‘]*ã€‘/gi,
      /ã€[^ã€‘]*å…¬å¼[^ã€‘]*ã€‘/gi,
      /\([^)]*é€æ–™[^)]*\)/gi,
      /\([^)]*ç„¡æ–™[^)]*\)/gi,
      /\s*\/ot\/\s*$/gi,
      /\s*\/\s*$/gi
    ];
    
    promoPatterns.forEach(pattern => {
      name = name.replace(pattern, '');
    });
    
    // âœ… 3. é‡è¤‡ãƒ»å†—é•·ãª [ ] å†…ã®æƒ…å ±ã‚’é™¤å»
    // ä¾‹ï¼š[å°å²©äº• ãƒŸãƒ«ã‚¯ã‚³ã‚³ã‚¢ ã‚³ã‚³ã‚¢ 400g] â†’ æ—¢ã«å•†å“åã«å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤
    const bracketPattern = /\[[^\]]+\]/g;
    const brackets = name.match(bracketPattern);
    if (brackets) {
      brackets.forEach(bracket => {
        const content = bracket.replace(/[\[\]]/g, '').trim();
        // å…ƒã®åå‰ã«æ—¢ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        const nameWithoutBracket = name.replace(bracket, '').trim();
        if (nameWithoutBracket.includes(content.substring(0, 10))) {
          // é‡è¤‡ã—ã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤
          name = name.replace(bracket, '');
        }
      });
    }
    
    // âœ… 4. ã¾ã¨ã‚è²·ã„è¡¨è¨˜ã‚’å•†å“åæœ¬ä½“ã‹ã‚‰å‰Šé™¤ï¼ˆåˆ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«é€ƒãŒã™æº–å‚™ï¼‰
    if (packHint) {
      // ã¾ã¨ã‚è²·ã„è¡¨è¨˜ã‚’ä¸€æ—¦å‰Šé™¤ï¼ˆå•†å“åæœ¬ä½“ã‹ã‚‰å¤–ã™ï¼‰
      bulkPatterns.forEach(({ pattern }) => {
        name = name.replace(pattern.pattern || pattern, '');
      });
      // ã€Œ12æœ¬ã€ã€Œã‚±ãƒ¼ã‚¹ã€ç­‰ã‚‚å‰Šé™¤
      name = name.replace(/\s*Ã—\s*\d+\s*(æœ¬|å€‹|ç¼¶|è¢‹|ãƒ‘ãƒƒã‚¯)\s*/gi, '');
      name = name.replace(/\s*\d+\s*(æœ¬|å€‹|ç¼¶|è¢‹|ãƒ‘ãƒƒã‚¯)\s*Ã—\s*/gi, '');
      name = name.replace(/\s*\d+\s*(æœ¬|å€‹|ç¼¶|è¢‹|ãƒ‘ãƒƒã‚¯)\s*ã‚»ãƒƒãƒˆ\s*/gi, '');
      name = name.replace(/\s*ã‚±ãƒ¼ã‚¹\s*/gi, '');
      name = name.replace(/\s*ç®±\s*/gi, '');
      name = name.replace(/\s*ç®±è²·ã„\s*/gi, '');
      name = name.replace(/\s*ã¾ã¨ã‚è²·ã„\s*/gi, '');
      name = name.replace(/\s*ã‚»ãƒƒãƒˆè²©å£²\s*/gi, '');
      name = name.replace(/\s*æ¥­å‹™ç”¨\s*/gi, '');
    }
    
    // âœ… å•†å“åã‹ã‚‰è²©å£²åº—åã£ã½ã„èªã‚’é™¤å»
    const storeNameInProductPatterns = [
      /\s*æ¥½å¤©\s*/gi, /\s*Amazon\s*/gi, /\s*ãƒ¤ãƒ•ãƒ¼\s*/gi, /\s*Yahoo\s*/gi,
      /\s*Rakuten\s*/gi, /\s*ãƒ¡ãƒ«ã‚«ãƒª\s*/gi, /\s*mercari\s*/gi,
      /\s*å…¬å¼\s*/gi, /\s*Official\s*/gi, /\s*æœ¬åº—\s*/gi, /\s*æ”¯åº—\s*/gi
    ];
    storeNameInProductPatterns.forEach(pattern => {
      name = name.replace(pattern, ' ');
    });
    
    // âœ… 5. ãƒ¡ãƒ¼ã‚«ãƒ¼åã‹ã‚‰è²©å£²åº—åã‚’é™¤å»ï¼ˆæ±ç”¨é–¢æ•°ã‚’ä½¿ç”¨ï¼‰
    maker = normalizeMakerName(maker);
    
    // âœ… 6. ç©ºç™½ãƒ»è¨˜å·ã®æ•´ç†
    name = name.replace(/\s+/g, ' ').trim();
    name = name.replace(/^[\s\-ãƒ»]+|[\s\-ãƒ»]+$/g, '');
    maker = maker.replace(/\s+/g, ' ').trim();
    
    // âœ… å®¹é‡/å€‹æ•°ãŒéå‰°ãªå ´åˆã®packç–‘ã„åˆ¤å®š
    if (!packHint && packCount === null) {
      // å•†å“åã«å¤§ããªæ•°å­—ãŒå«ã¾ã‚Œã‚‹å ´åˆï¼ˆä¾‹ï¼š24æœ¬ã€12å€‹ï¼‰
      const largeNumberMatch = name.match(/(\d{2,})\s*(æœ¬|å€‹|ç¼¶|è¢‹|ãƒ‘ãƒƒã‚¯)/i);
      if (largeNumberMatch) {
        const count = parseInt(largeNumberMatch[1], 10);
        if (count >= 12) {
          packHint = true;
          packCount = count;
          trustScore -= 15; // packç–‘ã„ä¸­
        }
      }
    }
    
    // âœ… 7. ã¾ã¨ã‚è²·ã„æ³¨è¨˜ã‚’è¿½åŠ ï¼ˆçŸ­ãï¼‰
    if (packHint && name.length > 0) {
      name = name + 'ï¼ˆã‚±ãƒ¼ã‚¹ï¼‰';
    }
    
    // âœ… ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
    if (isDebug() && (name !== original.name || maker !== original.maker)) {
      console.log('[Normalize] Before:', original.name);
      console.log('[Normalize] After:', name);
      if (packHint) console.log('[Normalize] Pack hint detected');
    }
    
    return {
      name: name || original.name, // ç©ºã«ãªã£ãŸå ´åˆã¯å…ƒã«æˆ»ã™
      maker: maker || original.maker,
      imageUrl: original.imageUrl,
      packHint: packHint, // ã¾ã¨ã‚è²·ã„ãƒ•ãƒ©ã‚°
      packCount: packCount, // ã¾ã¨ã‚è²·ã„å€‹æ•°
      isCase: isCase, // ã‚±ãƒ¼ã‚¹å•†å“ãƒ•ãƒ©ã‚°
      trustScore: trustScore // ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ï¼ˆ100ãŒæœ€é«˜ï¼‰
    };
  }

  // ========= Open Food Facts APIï¼ˆJANã‚³ãƒ¼ãƒ‰æ¤œç´¢ï¼‰ =========
  async function lookupOffByJan(jan) {
    try {
      if (!jan || !/^\d{8,14}$/.test(jan)) {
        return null;
      }

      // âœ… ãƒ‡ãƒãƒƒã‚°: OFFæ¤œç´¢é–‹å§‹
      if (isDebug()) {
        showToast(`[OFF] Fetching...`, 3000);
        console.log("[OFF] JAN:", jan);
      }

      // âœ… ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆæ—¥æœ¬å„ªå…ˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ä¸–ç•Œç‰ˆï¼‰
      const endpoints = [
        `https://jp.openfoodfacts.org/api/v2/product/${jan}.json`,
        `https://world.openfoodfacts.org/api/v2/product/${jan}.json`
      ];

      // âœ… AbortController+timeoutï¼ˆ12ç§’ã€Yahooã¨æƒãˆã‚‹ï¼‰
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 12000);

      let lastError = null;
      for (const endpoint of endpoints) {
        try {
          const res = await fetch(endpoint, {
            cache: 'no-store',
            signal: controller.signal,
            mode: 'cors',
            credentials: 'omit'
          });
          clearTimeout(timeoutId);

          if (!res.ok) {
            lastError = new Error(`HTTP ${res.status}`);
            continue; // æ¬¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è©¦ã™
          }

          const json = await res.json();

          // âœ… OFF APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ã‚’ç¢ºèª
          if (json && json.status === 1 && json.product) {
            const product = json.product;

            // âœ… å•†å“åå€™è£œï¼ˆå„ªå…ˆé †ä½: product_name_ja â†’ product_name â†’ generic_name_ja â†’ generic_nameï¼‰
            let displayName = '';
            if (product.product_name_ja && product.product_name_ja.trim()) {
              displayName = product.product_name_ja.trim();
            } else if (product.product_name && product.product_name.trim()) {
              displayName = product.product_name.trim();
            } else if (product.generic_name_ja && product.generic_name_ja.trim()) {
              displayName = product.generic_name_ja.trim();
            } else if (product.generic_name && product.generic_name.trim()) {
              displayName = product.generic_name.trim();
            }

            // âœ… ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šãªã‚‰å…ˆé ­ã ã‘ï¼‰
            let brand = '';
            if (product.brands && product.brands.trim()) {
              const brands = product.brands.split(',').map(b => b.trim()).filter(b => b.length > 0);
              brand = brands.length > 0 ? brands[0] : '';
            }

            // âœ… ç”»åƒï¼ˆimage_front_url â†’ image_urlï¼‰
            let imageUrl = '';
            if (product.image_front_url && product.image_front_url.trim()) {
              imageUrl = product.image_front_url.trim();
            } else if (product.image_url && product.image_url.trim()) {
              imageUrl = product.image_url.trim();
            }

            // âœ… å•†å“èº«å…ƒæƒ…å ±ãŒ1ã¤ã§ã‚‚å–å¾—ã§ããŸã‚‰æˆåŠŸ
            if (displayName || brand || imageUrl) {
              // âœ… OFFã®ä½¿ã„æ–¹ãƒ«ãƒ¼ãƒ«ï¼šæ¡ä»¶ãƒã‚§ãƒƒã‚¯
              let shouldUse = false;
              let reason = '';

              // âœ… æ¡ä»¶1: å•†å“åãŒæ—¥æœ¬èªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§å–ã‚Œã‚‹ã€ã¾ãŸã¯æ—¥æœ¬èªãŒååˆ†å«ã¾ã‚Œã‚‹
              const hasJapanese = /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/.test(displayName);
              const isJapaneseField = product.product_name_ja || product.generic_name_ja;

              if (isJapaneseField || (displayName && hasJapanese && displayName.length > 0)) {
                shouldUse = true;
                reason = 'æ—¥æœ¬èªOK';
                // âœ… ç”»åƒãŒãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ•ç¨¿ã£ã½ã„å ´åˆã¯ç”»åƒã‚’æ¡ç”¨ã—ãªã„ï¼ˆå•†å“åã®ã¿ï¼‰
                if (isUserUploadImage) {
                  imageUrl = ''; // ç”»åƒã‚’ã‚¯ãƒªã‚¢ï¼ˆå•†å“åã®ã¿æ¡ç”¨ï¼‰
                  reason += 'ï¼ˆç”»åƒã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ•ç¨¿ã®ãŸã‚é™¤å¤–ï¼‰';
                }
              } else {
                shouldUse = false;
                reason = 'è‹±èªå/æ—¥æœ¬èªä¸è¶³';
              }

              // âœ… æ¡ä»¶2: ç”»åƒãŒæ˜ã‚‰ã‹ã«å•†å“æ­£é¢ï¼ˆè‡ªæ’®ã‚Š/ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ•ç¨¿ã£ã½ã„ã®ã¯è‡ªå‹•æ¡ç”¨ã—ãªã„ï¼‰
              // ç°¡æ˜“åˆ¤å®šï¼šç”»åƒURLã« "front" ãŒå«ã¾ã‚Œã‚‹ã€ã¾ãŸã¯ "image_front_url" ãŒå­˜åœ¨ã™ã‚‹
              const isFrontImage = imageUrl && (
                imageUrl.includes('front') || 
                imageUrl.includes('image_front') ||
                product.image_front_url
              );
              
              // âœ… ç”»åƒãŒ"è‡ªæ’®ã‚Š/ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ•ç¨¿"ã£ã½ã„ï¼ˆé›‘ãƒ»æš—ã„ãƒ»æ–œã‚ãƒ»èƒŒæ™¯ã‚ã‚Šç­‰ï¼‰å ´åˆã¯æ¡ç”¨ã—ãªã„
              // åˆ¤å®šï¼šç”»åƒURLã« "user" ã‚„ "upload" ãŒå«ã¾ã‚Œã‚‹ã€ã¾ãŸã¯ "front" ãŒå«ã¾ã‚Œãªã„å ´åˆã¯ç–‘ã‚ã—ã„
              const isUserUploadImage = imageUrl && (
                imageUrl.includes('user') || 
                imageUrl.includes('upload') ||
                imageUrl.includes('mobile') ||
                (!isFrontImage && imageUrl.includes('images.openfoodfacts.org'))
              );

              if (imageUrl && (isUserUploadImage || !isFrontImage)) {
                // ç”»åƒãŒå­˜åœ¨ã™ã‚‹ãŒã€æ­£é¢ç”»åƒã§ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ã€ã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ•ç¨¿ã£ã½ã„
                // ãŸã ã—ã€å•†å“åãŒæ—¥æœ¬èªãªã‚‰æ¡ç”¨ï¼ˆç”»åƒã¯è£œå®Œã¨ã—ã¦ã€ç”»åƒè‡ªä½“ã¯æ¡ç”¨ã—ãªã„ï¼‰
                if (!shouldUse) {
                  shouldUse = false;
                  reason = 'ç”»åƒå“è³ªä¸è¶³ï¼ˆè‡ªæ’®ã‚Š/æ£šå†™çœŸã®å¯èƒ½æ€§ï¼‰';
                }
              }

              // âœ… æ¡ä»¶ã‚’æº€ãŸã•ãªã„å ´åˆã®æŒ™å‹•
              if (!shouldUse) {
                if (isDebug()) {
                  showToast(`[OFF] è‹±èª/ç”»åƒå“è³ªã®ç†ç”±ã§æ¡ç”¨ã—ãªã„ (${reason})`, 5000);
                  console.log("[OFF] Rejected:", reason, { displayName, brand, imageUrl });
                } else {
                  // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒˆãƒ¼ã‚¹ãƒˆ1å›ã ã‘ã§OKï¼ˆUIè¿½åŠ ãªã—ï¼‰
                  showToast(`[OFF] å•†å“æƒ…å ±ã®å“è³ªãŒä¸è¶³ã®ãŸã‚æ¡ç”¨ã—ã¾ã›ã‚“`, 3000);
                }
                return null; // è‡ªå‹•å…¥åŠ›ã—ãªã„
              }

              // âœ… æ¡ä»¶ã‚’æº€ãŸã—ãŸå ´åˆã®ã¿æ¡ç”¨
              const result = {
                name: displayName || '',
                maker: brand || '',
                imageUrl: imageUrl || ''
              };

              if (isDebug()) {
                showToast(`[OFF] OK name=${result.name ? result.name.substring(0, 20) + '...' : '(empty)'} brand=${result.maker || '(empty)'} img=${result.imageUrl ? 'OK' : '(empty)'}`, 5000);
                console.log("[OFF] Found:", result);
              }

              return result;
            }
          }

          // âœ… status=0 ã¾ãŸã¯ productãŒç„¡ã„å ´åˆã¯æ¬¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è©¦ã™
          lastError = new Error('Product not found');
          continue;

        } catch(e) {
          lastError = e;
          if (e.name === 'AbortError') {
            // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã®å ´åˆã¯æ¬¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è©¦ã•ãªã„
            break;
          }
          // ãã®ä»–ã®ã‚¨ãƒ©ãƒ¼ã¯æ¬¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è©¦ã™
          continue;
        }
      }

      // âœ… å…¨ã¦ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§å¤±æ•—
      if (isDebug()) {
        const errorDetail = lastError && lastError.name === 'AbortError' ? 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ12ç§’ï¼‰' : (lastError && lastError.message) || 'Product not found';
        showToast(`[OFF] Miss/Fail â†’ fallback Yahoo normalize (${errorDetail})`, 5000);
        console.log("[OFF] Failed:", lastError);
      }
      return null;

    } catch(e) {
      // âœ… äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼
      if (isDebug()) {
        const errorDetail = e.name === 'AbortError' ? 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ12ç§’ï¼‰' : e.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';
        showToast(`[OFF] Error: ${errorDetail} â†’ fallback Yahoo normalize`, 5000);
        console.error("[OFF] Error:", e);
      }
      return null;
    }
  }

  // ========= æ¥½å¤©APIï¼ˆJANã‚³ãƒ¼ãƒ‰æ¤œç´¢ãƒ»å›½å†…DBç¬¬2å„ªå…ˆï¼‰ =========
  async function lookupRakutenByJan(jan, keyword = null) {
    try {
      if (!jan || !/^\d{8,14}$/.test(jan)) {
        return null;
      }

      // âœ… ãƒ‡ãƒãƒƒã‚°: æ¥½å¤©æ¤œç´¢é–‹å§‹
      if (isDebug()) {
        showToast(`[æ¥½å¤©] Fetching...`, 3000);
        console.log("[Rakuten] JAN:", jan, "Keyword:", keyword);
      }

      // âœ… Yahoo ProxyçµŒç”±ã§æ¥½å¤©ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆaction=rakutenï¼‰
      const proxyUrl = (window.SP_CONFIG && window.SP_CONFIG.yahooProxyExecUrl) ? window.SP_CONFIG.yahooProxyExecUrl.trim() : '';
      
      if (!proxyUrl) {
        if (isDebug()) {
          showToast("[æ¥½å¤©] Proxy URL not configured", 5000);
        }
        return null;
      }

      // âœ… ãƒªã‚¯ã‚¨ã‚¹ãƒˆURLï¼ˆJANå„ªå…ˆã€ãƒ€ãƒ¡ãªã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼‰
      let requestUrl = '';
      if (jan) {
        requestUrl = `${proxyUrl}?action=rakuten&jan=${encodeURIComponent(jan)}`;
      } else if (keyword) {
        requestUrl = `${proxyUrl}?action=rakuten&keyword=${encodeURIComponent(keyword)}`;
      } else {
        return null;
      }

      // âœ… AbortController+timeoutï¼ˆ12ç§’ã€Yahooã¨æƒãˆã‚‹ï¼‰
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 12000);

      const res = await fetch(requestUrl, {
        cache: 'no-store',
        signal: controller.signal,
        mode: 'cors',
        credentials: 'omit'
      });
      clearTimeout(timeoutId);

      if (!res.ok) {
        // âœ… P0: Proxyå´ãŒæœªå®Ÿè£…ï¼ˆ404/500ç­‰ï¼‰ãªã‚‰å³nullè¿”ã—
        if (isDebug()) {
          showToast(`[æ¥½å¤©] Proxyæœªå®Ÿè£…ã®å¯èƒ½æ€§ (HTTP ${res.status})`, 5000);
          console.log("[Rakuten] Proxy may not be implemented, HTTP:", res.status);
        }
        return null; // å³nullè¿”ã—ï¼ˆç„¡åŠ¹ï¼‰
      }

      const json = await res.json();
      
      // âœ… P0: Proxyå´ãŒæœªå®Ÿè£…ï¼ˆok:falseç­‰ï¼‰ãªã‚‰å³nullè¿”ã—
      if (!json || !json.ok) {
        if (isDebug()) {
          showToast(`[æ¥½å¤©] Proxyæœªå®Ÿè£…ã®å¯èƒ½æ€§ (ok:false)`, 5000);
          console.log("[Rakuten] Proxy may not be implemented, response:", json);
        }
        return null; // å³nullè¿”ã—ï¼ˆç„¡åŠ¹ï¼‰
      }

      // âœ… æ¥½å¤©APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ã‚’ç¢ºèª
      if (json && json.ok && json.product) {
        const product = json.product;

        // âœ… å•†å“å
        let displayName = '';
        if (product.name && product.name.trim()) {
          displayName = product.name.trim();
        }

        // âœ… ãƒ–ãƒ©ãƒ³ãƒ‰/ãƒ¡ãƒ¼ã‚«ãƒ¼
        let brand = '';
        if (product.brand && product.brand.trim()) {
          brand = product.brand.trim();
        } else if (product.maker && product.maker.trim()) {
          brand = product.maker.trim();
        }

        // âœ… ç”»åƒï¼ˆå˜å“ç”»åƒã‚’å„ªå…ˆï¼‰
        let imageUrl = '';
        if (product.imageUrl && product.imageUrl.trim()) {
          imageUrl = product.imageUrl.trim();
        } else if (product.mediumImageUrl && product.mediumImageUrl.trim()) {
          imageUrl = product.mediumImageUrl.trim();
        }

        // âœ… å•†å“èº«å…ƒæƒ…å ±ãŒ1ã¤ã§ã‚‚å–å¾—ã§ããŸã‚‰æˆåŠŸ
        if (displayName || brand || imageUrl) {
          // âœ… ãƒ¡ãƒ¼ã‚«ãƒ¼åã®æ­£è¦åŒ–ï¼ˆæ±ç”¨é–¢æ•°ã‚’ä½¿ç”¨ï¼‰
          brand = normalizeMakerName(brand);

          const result = {
            name: displayName || '',
            maker: brand || '',
            imageUrl: imageUrl || ''
          };

          if (isDebug()) {
            showToast(`[æ¥½å¤©] OK name=${result.name ? result.name.substring(0, 20) + '...' : '(empty)'} brand=${result.maker || '(empty)'} img=${result.imageUrl ? 'OK' : '(empty)'}`, 5000);
            console.log("[Rakuten] Found:", result);
          }

          return result;
        }
      }

      // âœ… å–å¾—å¤±æ•—
      if (isDebug()) {
        showToast(`[æ¥½å¤©] Miss/Fail`, 3000);
        console.log("[Rakuten] Failed: Product not found");
      }
      return null;

    } catch(e) {
      // âœ… P0: äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ï¼ˆProxyæœªå®Ÿè£…ã®å¯èƒ½æ€§ï¼‰â†’ å³nullè¿”ã—
      if (isDebug()) {
        const errorDetail = e.name === 'AbortError' ? 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ12ç§’ï¼‰' : e.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';
        showToast(`[æ¥½å¤©] Proxyæœªå®Ÿè£…ã®å¯èƒ½æ€§ (${errorDetail})`, 5000);
        console.error("[Rakuten] Proxy may not be implemented, error:", e);
      }
      return null; // å³nullè¿”ã—ï¼ˆç„¡åŠ¹ï¼‰
    }
  }

  // ========= Yahoo Shopping APIï¼ˆJANã‚³ãƒ¼ãƒ‰æ¤œç´¢ï¼‰with ã‚­ãƒ£ãƒƒã‚·ãƒ¥ =========
  async function lookupYahooByJan(jan, forceUpdate = false) {
    try {
      // âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯ï¼ˆ7æ—¥é–“æœ‰åŠ¹ï¼‰
      const cacheKey = `yahoo_cache_${jan}`;
      const cacheTtl = 7 * 24 * 60 * 60 * 1000; // 7æ—¥
      
      if (!forceUpdate) {
        try {
          const cached = localStorage.getItem(cacheKey);
          if (cached) {
            const cacheData = JSON.parse(cached);
            if (cacheData && cacheData.ts && (Date.now() - cacheData.ts < cacheTtl)) {
              if (isDebug()) console.log("[YahooSearch] Cache hit:", jan);
              return cacheData.data || null;
            }
          }
        } catch(e) {
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
        }
      }
      
      // Config.jsonã‹ã‚‰Yahoo Proxy URLã‚’å–å¾—ï¼ˆæœ€å„ªå…ˆï¼‰
      const proxyUrl = (window.SP_CONFIG && window.SP_CONFIG.yahooProxyExecUrl) ? window.SP_CONFIG.yahooProxyExecUrl.trim() : '';
      
      if (!proxyUrl) {
        if (isDebug()) {
          showToast("Yahooæ¤œç´¢ãƒ—ãƒ­ã‚­ã‚·URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“", 5000);
        }
        return null;
      }

      // âœ… ãƒ‡ãƒãƒƒã‚°: Yahooæ¤œç´¢é–‹å§‹
      const requestUrl = `${proxyUrl}?jan=${encodeURIComponent(jan)}`;
      if (isDebug()) {
        showToast(`[Yahoo] Fetching: ${requestUrl}`, 5000);
        console.log("[YahooSearch] JAN:", jan, "Proxy URL:", proxyUrl);
        console.log("[YahooSearch] Request URL:", requestUrl);
      }
      
      // âœ… AbortController+timeoutï¼ˆ12ç§’ï¼‰
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 12000);
      
      showToast("Yahooæ¤œç´¢ä¸­â€¦", 5000);
      const res = await fetch(requestUrl, { 
        cache: 'no-store', 
        signal: controller.signal 
      });
      clearTimeout(timeoutId);
      
      // âœ… ãƒ‡ãƒãƒƒã‚°: HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
      if (isDebug()) {
        showToast(`[Yahoo] HTTP Status: ${res.status} ${res.statusText}`, 5000);
        console.log("[YahooSearch] HTTP Status:", res.status, res.statusText);
      }
      
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }
      
      const json = await res.json();
      
      if (json && json.name) {
        const rawResult = {
          name: json.name || "",
          maker: json.maker || "",
          imageUrl: json.imageUrl || ""
        };
        
        // âœ… å•†å“æƒ…å ±ã‚’è‡ªå‹•æ•´å½¢ï¼ˆ12æœ¬1ç®±å•é¡Œå¯¾å¿œï¼‰
        const result = normalizeYahooProductInfo(rawResult);
        
        // âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ï¼ˆæ•´å½¢å¾Œï¼‰
        try {
          localStorage.setItem(cacheKey, JSON.stringify({
            ts: Date.now(),
            data: result
          }));
        } catch(e) {
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
        }
        
        if (isDebug()) {
          console.log("[YahooSearch] Found:", json.name);
          if (result.packHint) {
            showToast('[Yahoo] ã¾ã¨ã‚è²·ã„å•†å“ã‚’æ¤œå‡ºã—ã¾ã—ãŸ', 3000);
          }
        }
        return result;
      }
      return null;
    } catch(e) {
      // âœ… ãƒ‡ãƒãƒƒã‚°: ã‚¨ãƒ©ãƒ¼è©³ç´°è¡¨ç¤º
      if (isDebug()) {
        const errorDetail = e.name === 'AbortError' ? 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆ12ç§’ï¼‰' : e.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼';
        showToast(`[Yahoo] Error: ${errorDetail}`, 8000);
        console.error("[YahooSearch] Error:", e);
        console.error("[YahooSearch] Error name:", e.name);
        console.error("[YahooSearch] Error stack:", e.stack);
      } else {
        showToast(`Yahooæ¤œç´¢å¤±æ•—: ${e.name === 'AbortError' ? 'ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ' : 'é€šä¿¡ã‚¨ãƒ©ãƒ¼'}`, 5000);
      }
      return null;
    }
  }

  // ========= è¿‘éš£åº—èˆ—å–å¾—ï¼ˆYahooProxyçµŒç”±ã§OSMæ¤œç´¢ï¼‰ =========
  async function fetchNearbyStores() {
    try {
      const proxyUrl = (window.SP_CONFIG && window.SP_CONFIG.yahooProxyExecUrl) ? window.SP_CONFIG.yahooProxyExecUrl.trim() : '';
      
      if (!proxyUrl) {
        if (isDebug()) {
          console.log('[FetchStores] Proxy URL not configured');
          showToast('Yahoo Proxy URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 10000);
        }
        return [];
      }

      // å„ªå…ˆé †ä½1: GPSåº§æ¨™ï¼ˆcurPosï¼‰
      if (isGpsOn && curPos && curPos.lat && curPos.lng) {
        const radiusKm = 5; // GPSæ™‚ã¯5km
        const limit = 40;
        const requestUrl = `${proxyUrl}?action=stores&lat=${curPos.lat}&lng=${curPos.lng}&radius_km=${radiusKm}&limit=${limit}`;
        
        if (isDebug()) console.log('[FetchStores] GPS mode:', requestUrl);
        
        const res = await fetchWithTimeout(requestUrl, { cache: 'no-store' }, 15000);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        
        const json = await res.json();
        if (json && json.ok && Array.isArray(json.stores)) {
          if (isDebug()) console.log('[FetchStores] GPS result:', json.stores.length, 'stores');
          // âœ… trim() + ç©ºè¦ç´ é™¤å»
          return json.stores.map(s => String(s.name || '').trim()).filter(n => n.length > 0);
        }
        return [];
      }

      // å„ªå…ˆé †ä½2: ç”Ÿæ´»åœï¼ˆareaï¼‰
      const area = (db && db.config && db.config.homeCity) ? String(db.config.homeCity).trim() : '';
      if (area) {
        const radiusKm = 15; // areaæ™‚ã¯15km
        const limit = 40;
        const requestUrl = `${proxyUrl}?action=stores&area=${encodeURIComponent(area)}&radius_km=${radiusKm}&limit=${limit}`;
        
        if (isDebug()) console.log('[FetchStores] Area mode:', area, requestUrl);
        
        const res = await fetchWithTimeout(requestUrl, { cache: 'no-store' }, 15000);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        
        const json = await res.json();
        if (json && json.ok && Array.isArray(json.stores)) {
          if (isDebug()) console.log('[FetchStores] Area result:', json.stores.length, 'stores');
          // âœ… trim() + ç©ºè¦ç´ é™¤å»
          return json.stores.map(s => String(s.name || '').trim()).filter(n => n.length > 0);
        } else if (json && !json.ok) {
          // ã‚¨ãƒ©ãƒ¼æ™‚ï¼ˆä¾‹ï¼šä½¿ç”¨ã§ããªã„ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰
          if (isDebug()) {
            console.log('[FetchStores] Area failed:', json.error || 'unknown');
            showToast('åº—èˆ—æ¤œç´¢å¤±æ•—: ' + (json.error || 'unknown'), 10000);
          }
          // GPSã¸ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯ã€ã™ã§ã«ä¸Šã§è©¦ã—ã¦ã„ã‚‹ã®ã§ã€ã“ã“ã§ã¯ç©ºé…åˆ—ã‚’è¿”ã™
          return [];
        }
        return [];
      }

      // GPS/areaã©ã¡ã‚‰ã‚‚ãªã„å ´åˆ
      if (isDebug()) console.log('[FetchStores] No GPS or area configured');
      return [];

    } catch(e) {
      if (isDebug()) {
        console.error('[FetchStores] Error:', e);
      }
      return [];
    }
  }

  function startScanner() {
    if(isScanning) {
      if (isDebug()) {
        console.log("[Scanner] Already scanning, skip");
      }
      return;
    }
    
    // âœ… P0: Html5Qrcodeãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ç¢ºèª
    if (typeof Html5Qrcode === 'undefined') {
      const errorMsg = "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚";
      showToast(errorMsg, 10000);
      if (isDebug()) {
        console.error("[Scanner] Html5Qrcode library not loaded");
        setLastError(`[Scanner] ${errorMsg}`);
      }
      return;
    }
    
    isScanning = true;
    document.getElementById('camera-area').style.display='block';
    // âœ… P0: ãƒˆãƒ¼ã‚¹ãƒˆã€Œã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­â€¦ã€ã¯è¡¨ç¤ºã—ãªã„ï¼ˆæœ€ä½ã§ã‚‚ debug=1 ã®æ™‚ã ã‘ã«é™å®šï¼‰
    if (isDebug()) {
      showToast("ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­â€¦", 2000);
      console.log("[Scanner] Starting scanner...");
    }
    
    try {
      if(!scanner) {
        scanner = new Html5Qrcode("interactive");
        if (isDebug()) {
          console.log("[Scanner] Html5Qrcode instance created");
        }
      }
    } catch(e) {
      isScanning = false;
      document.getElementById('camera-area').style.display='none';
      const errorMsg = `ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message || e}`;
      showToast(errorMsg, 10000);
      if (isDebug()) {
        console.error("[Scanner] Initialization error:", e);
        setLastError(`[Scanner] ${errorMsg}`);
      }
      return;
    }
    
    // âœ… P0: ã‚«ãƒ¡ãƒ©ã®ãƒ”ãƒ³ãƒˆå•é¡Œå¯¾å¿œ
    // âœ… P0ä¿®æ­£: cameraIdOrConfigã¯1ã‚­ãƒ¼ã ã‘ã«ã™ã‚‹ï¼ˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¦æ±‚ã«æº–æ‹ ï¼‰
    // âœ… getUserMedia ã¯æœ€åˆã¯å®‰å…¨ã«å–å¾—ï¼ˆè½ã¡ã«ãã„æ¡ä»¶ï¼‰
    const cameraConfig = {
      facingMode: "environment" // èƒŒé¢ã‚«ãƒ¡ãƒ©å›ºå®šï¼ˆ1ã‚­ãƒ¼ã®ã¿ï¼‰
    };
    
    // âœ… P0: ãã®ä»–ã®è¨­å®šï¼ˆè§£åƒåº¦ãƒ»ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ç­‰ï¼‰ã¯åˆ¥ã®è¨­å®šå¼•æ•°ã¸åˆ†é›¢
    // âœ… P0ä¿®æ­£: Html5Qrcodeãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è¦æ±‚ã«æº–æ‹ ï¼ˆcameraIdOrConfigã¯1ã‚­ãƒ¼ã®ã¿ï¼‰
    const scannerConfig = {
      fps: 15,
      qrbox: {width: 280, height: 180}, // ROIå†…ã ã‘ã®æ¤œå‡ºã‚’ç¢ºå®Ÿã«ã™ã‚‹
      aspectRatio: 1.0, // æ­£æ–¹å½¢ã«è¿‘ã„å½¢çŠ¶ã§ç²¾åº¦å‘ä¸Š
      disableFlip: false // ãƒ•ãƒªãƒƒãƒ—ã‚’æœ‰åŠ¹ã«ã—ã¦æ¤œå‡ºç²¾åº¦å‘ä¸Š
      // âœ… æ³¨æ„: è§£åƒåº¦è¨­å®šã¯ã€ã‚«ãƒ¡ãƒ©èµ·å‹•å¾Œã«track.applyConstraints()ã§é©ç”¨ï¼ˆå¾Œç¶šã®å‡¦ç†ã§å®Ÿè£…æ¸ˆã¿ï¼‰
    };
    
    // âœ… P0: æ¤œå‡ºã¯æ ï¼ˆROIï¼‰å†…ã ã‘ã«ã—ã¦ç²¾åº¦/é€Ÿåº¦ã‚’ä¸Šã’ã‚‹ï¼ˆç´°ã„å´é¢ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã§ç‰¹ã«ï¼‰
    scanner.start(cameraConfig, scannerConfig, async (t)=> {
      // âœ… ã‚¹ã‚­ãƒ£ãƒ³ãƒãƒ¼DOMè¦ç´ ã‚’ç¢ºå®Ÿã«ç”Ÿæˆãƒ»é…ç½®ï¼ˆã‚«ãƒ¡ãƒ©èµ·å‹•æˆåŠŸå¾Œã™ãï¼‰
      ensureScanbarDom();
      
      showToast("èª­ã¿å–ã‚ŠOK", 1500);
      
      // âœ… P0: å–å¾—ã§ããŸã‚‰ track.applyConstraints() ã‚’æ®µéšçš„ã«try
      try {
        const videoElement = document.querySelector('#interactive video');
        if (videoElement && videoElement.srcObject) {
          const stream = videoElement.srcObject;
          const track = stream.getVideoTracks()[0];
          if (track) {
            // âœ… track.getCapabilities() ã§ç«¯æœ«ã®å¯¾å¿œçŠ¶æ³ã‚’ç¢ºèª
            const capabilities = track.getCapabilities ? track.getCapabilities() : {};
            const settings = track.getSettings ? track.getSettings() : {};
            
            // âœ… torchï¼ˆãƒ©ã‚¤ãƒˆï¼‰å¯¾å¿œãƒã‚§ãƒƒã‚¯ï¼ˆæš—æ‰€ã ã‘è‡ªå‹•ç‚¹ç¯ï¼‰
            if (capabilities.torch && capabilities.torch.length > 0) {
              try {
                // ç°¡æ˜“çš„ãªæ˜ã‚‹ã•åˆ¤å®šï¼ˆç’°å¢ƒå…‰ã‚»ãƒ³ã‚µãƒ¼ãŒãªã„å ´åˆã®ä»£æ›¿ï¼‰
                // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ã‚ˆã‚Šé«˜åº¦ãªåˆ¤å®šãŒå¿…è¦ãªå ´åˆãŒã‚ã‚‹
                const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                // ã‚ˆã‚Šç¢ºå®Ÿãªæ–¹æ³•ï¼šæ˜ã‚‹ã•ãŒä½ã„ã¨åˆ¤æ–­ã—ãŸå ´åˆã®ã¿ç‚¹ç¯
                // ã“ã“ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ˜ç¤ºçš„ã«è¦æ±‚ã—ãªã„é™ã‚Šã€è‡ªå‹•ç‚¹ç¯ã¯æ§ãˆã‚ã«
                // å°†æ¥çš„ã«ã¯ã€å®Ÿéš›ã®ç’°å¢ƒå…‰ã‚»ãƒ³ã‚µãƒ¼ã‚„ã‚«ãƒ¡ãƒ©ã®æ˜ã‚‹ã•æƒ…å ±ã‚’ä½¿ç”¨å¯èƒ½
                if (isDebug()) {
                  console.log("[Camera] torch capability available:", capabilities.torch);
                }
              } catch(e) {
                if (isDebug()) {
                  console.log("[Camera] torch check error:", e);
                }
              }
            }
            
            // âœ… P0: ãƒ”ãƒ³ãƒˆæ”¹å–„ï¼ˆé€£ç¶šAF/éœ²å‡º/ãƒ›ãƒ¯ã‚¤ãƒˆãƒãƒ©ãƒ³ã‚¹ç­‰ã®å¼·åŒ–ï¼‰
            // getCapabilities() ã‚’è¦‹ã¦ã€å¯¾å¿œç«¯æœ«ã¯ focusMode=continuous ã‚’å„ªå…ˆ
            const constraints = [];
            
            // âœ… focusMode: continuousï¼ˆé€£ç¶šã‚ªãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹å„ªå…ˆï¼‰
            if (capabilities.focusMode && capabilities.focusMode.includes && capabilities.focusMode.includes("continuous")) {
              constraints.push({ focusMode: "continuous" });
            } else if (capabilities.focusMode && Array.isArray(capabilities.focusMode) && capabilities.focusMode.includes("continuous")) {
              constraints.push({ focusMode: "continuous" });
            } else {
              // å¯¾å¿œã—ã¦ã„ãªã„å ´åˆã¯ manual ã‚’è©¦ã™ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
              if (capabilities.focusMode && (capabilities.focusMode.includes && capabilities.focusMode.includes("manual") || 
                  (Array.isArray(capabilities.focusMode) && capabilities.focusMode.includes("manual")))) {
                constraints.push({ focusMode: "manual" });
              }
            }
            
            // âœ… exposureMode: continuousï¼ˆé€£ç¶šéœ²å‡ºèª¿æ•´ï¼‰
            if (capabilities.exposureMode && capabilities.exposureMode.includes && capabilities.exposureMode.includes("continuous")) {
              constraints.push({ exposureMode: "continuous" });
            } else if (capabilities.exposureMode && Array.isArray(capabilities.exposureMode) && capabilities.exposureMode.includes("continuous")) {
              constraints.push({ exposureMode: "continuous" });
            }
            
            // âœ… whiteBalanceMode: continuousï¼ˆãƒ›ãƒ¯ã‚¤ãƒˆãƒãƒ©ãƒ³ã‚¹èª¿æ•´ï¼‰
            if (capabilities.whiteBalanceMode && capabilities.whiteBalanceMode.includes && capabilities.whiteBalanceMode.includes("continuous")) {
              constraints.push({ whiteBalanceMode: "continuous" });
            } else if (capabilities.whiteBalanceMode && Array.isArray(capabilities.whiteBalanceMode) && capabilities.whiteBalanceMode.includes("continuous")) {
              constraints.push({ whiteBalanceMode: "continuous" });
            }
            
            // âœ… zoom: 1.2 ã¯æ¡ä»¶ä»˜ãï¼ˆcapabilityãŒã‚ã‚Šã€ã‹ã¤èª­ã¿å–ã‚ŠãŒãƒ–ãƒ¬ã‚‹ç«¯æœ«ã®ã¿ï¼‰
            if (capabilities.zoom && capabilities.zoom.max && capabilities.zoom.max >= 1.2) {
              constraints.push({ zoom: 1.2 }); // æ§ãˆã‚ãªã‚ºãƒ¼ãƒ ï¼ˆå¯¾å¿œç«¯æœ«ã®ã¿ï¼‰
            }
            
            for (let i = 0; i < constraints.length; i++) {
              try {
                await track.applyConstraints({ advanced: [constraints[i]] });
                if (isDebug()) {
                  const constraintName = Object.keys(constraints[i])[0];
                  showToast(`[Camera] Constraint ${i+1} OK: ${constraintName}`, 2000);
                  console.log("[Camera] Applied constraint:", constraints[i]);
                }
              } catch(e) {
                if (isDebug()) {
                  const constraintName = Object.keys(constraints[i])[0];
                  console.log(`[Camera] Constraint ${i+1} failed: ${constraintName}`, e.message);
                }
                // å¤±æ•—ã—ã¦ã‚‚ç¶™ç¶š
              }
            }
          }
        }
      } catch(e) {
        if (isDebug()) {
          console.log("[Camera] applyConstraints error:", e);
        }
        // ã‚¨ãƒ©ãƒ¼ã¯æ¡ã‚Šã¤ã¶ã—ã¦ç¶™ç¶š
      }
      
      await stopScanner();
      
      // âœ… å…±é€šå‡¦ç†ã¸ï¼ˆæ‰‹å…¥åŠ›ã¨åŒã˜ï¼‰
      await processBarcodeData(t);
    }).catch((err) => {
      // âœ… P0: ã‚¹ã‚­ãƒ£ãƒŠãƒ¼èµ·å‹•å¤±æ•—æ™‚ã®è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      let errorMsg = "èµ·å‹•å¤±æ•—";
      let errorDetail = "";
      
      if (err) {
        if (err instanceof Error) {
          errorMsg = err.message || "èµ·å‹•å¤±æ•—";
          errorDetail = err.name || "";
          if (err.stack) {
            console.error("[Scanner] Error stack:", err.stack);
          }
        } else if (typeof err === 'string') {
          errorMsg = err;
        } else {
          errorMsg = JSON.stringify(err) || "èµ·å‹•å¤±æ•—";
        }
      }
      
      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è©³ç´°åŒ–
      if (errorMsg.includes('NotAllowedError') || errorMsg.includes('Permission denied')) {
        errorMsg = "ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã®è¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
      } else if (errorMsg.includes('NotFoundError') || errorMsg.includes('No camera found')) {
        errorMsg = "ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚«ãƒ¡ãƒ©ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
      } else if (errorMsg.includes('NotReadableError') || errorMsg.includes('Could not start video source')) {
        errorMsg = "ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ä¸­ã§ã™ã€‚ä»–ã®ã‚¢ãƒ—ãƒªã§ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
      } else if (errorMsg.includes('OverconstrainedError') || errorMsg.includes('constraint')) {
        errorMsg = "ã‚«ãƒ¡ãƒ©ã®è¨­å®šãŒç«¯æœ«ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚";
      }
      
      const fullErrorMsg = errorDetail ? `${errorDetail}: ${errorMsg}` : errorMsg;
      
      // âœ… P0ä¿®æ­£: ã‚¹ã‚­ãƒ£ãƒŠãƒ¼èµ·å‹•å¤±æ•—æ™‚ã¯å¿…ãš15ç§’è¡¨ç¤ºï¼ˆdebug=1æ™‚ã¯ç”»é¢å†…ãƒ­ã‚°ã«ã‚‚æ®‹ã™ï¼‰
      const errorToastMsg = `[Scannerèµ·å‹•å¤±æ•—] ${fullErrorMsg}`;
      showToast(errorToastMsg, 15000); // æœ€ä½15ç§’
      
      // âœ… P0ä¿®æ­£: debug=1 æ™‚ã¯ã€åŒã˜å†…å®¹ã‚’ç”»é¢å†…ãƒ­ã‚°ã«ã‚‚æ®‹ã™ï¼ˆæ¶ˆãˆãªã„é ˜åŸŸï¼‰
      if (isDebug()) {
        console.error("[Scanner] Start failed:", {
          error: err,
          message: errorMsg,
          detail: errorDetail,
          stack: err instanceof Error ? err.stack : '',
          rawError: err
        });
      }
      
      // âœ… P0ä¿®æ­£: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’ä¿å­˜ï¼ˆè¨ºæ–­ãƒ„ãƒ¼ãƒ«ç”¨ï¼‰- ç”Ÿã®ä¾‹å¤–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚å¿…ãšä¿å­˜
      addErrorLog({
        type: 'scanner_start_failed',
        message: errorMsg,
        detail: errorDetail,
        stack: err instanceof Error ? err.stack : '',
        rawError: String(err),
        rawErrorObject: err instanceof Error ? {
          name: err.name,
          message: err.message,
          stack: err.stack
        } : err,
        timestamp: new Date().toISOString()
      });
      
      stopScanner();
    });
    
    // âœ… ã‚¹ã‚­ãƒ£ãƒ³ãƒãƒ¼DOMè¦ç´ ã‚’ç¢ºå®Ÿã«ç”Ÿæˆãƒ»é…ç½®ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ã‚‚å®Ÿè¡Œï¼‰
    setTimeout(() => {
      ensureScanbarDom();
      
      // âœ… debug=1æ™‚ã«ã‚¹ã‚­ãƒ£ãƒ³ãƒãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
      if (isDebug()) {
        displayScanbarDebugInfo();
      }
    }, 300); // ã‚«ãƒ¡ãƒ©èµ·å‹•å¾Œ0.3ç§’å¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œ
  }
  
  // âœ… ã‚¹ã‚­ãƒ£ãƒ³ãƒãƒ¼DOMè¦ç´ ã‚’ç¢ºå®Ÿã«ç”Ÿæˆãƒ»é…ç½®ã™ã‚‹é–¢æ•°ï¼ˆè‡ªå·±ä¿®å¾©æ©Ÿèƒ½ï¼‰
  function ensureScanbarDom() {
    const cameraArea = document.getElementById('camera-area');
    if (!cameraArea) {
      console.error('[EnsureScanbar] camera-area not found');
      return false;
    }
    
    // âœ… (1) scan-frame ã‚’ç¢ºä¿ï¼ˆãªã‘ã‚Œã°ä½œæˆï¼‰
    let scanFrame = cameraArea.querySelector('.scan-frame');
    if (!scanFrame) {
      scanFrame = document.createElement('div');
      scanFrame.className = 'scan-frame';
      cameraArea.appendChild(scanFrame);
      
      if (isDebug()) {
        console.log('[EnsureScanbar] Created scan-frame');
      }
    }
    
    // âœ… scan-frame ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¢ºå®Ÿã«è¨­å®š
    scanFrame.style.position = 'absolute';
    scanFrame.style.top = '50%';
    scanFrame.style.left = '50%';
    scanFrame.style.transform = 'translate(-50%, -50%)';
    scanFrame.style.width = '280px';
    scanFrame.style.height = '180px';
    scanFrame.style.zIndex = '2001'; // videoã‚ˆã‚Šå‰é¢
    scanFrame.style.pointerEvents = 'none';
    
    // âœ… (2) scan-laser ã‚’ç¢ºä¿ï¼ˆãªã‘ã‚Œã°ä½œæˆï¼‰
    let scanLaser = scanFrame.querySelector('.scan-laser');
    if (!scanLaser) {
      scanLaser = document.createElement('div');
      scanLaser.className = 'scan-laser';
      scanFrame.appendChild(scanLaser);
      
      if (isDebug()) {
        console.log('[EnsureScanbar] Created scan-laser');
      }
    }
    
    // âœ… scan-laser ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¢ºå®Ÿã«è¨­å®š
    scanLaser.style.position = 'absolute';
    scanLaser.style.left = '5%';
    scanLaser.style.width = '90%';
    scanLaser.style.height = '3px';
    scanLaser.style.zIndex = '9999'; // æœ€å‰é¢ï¼ˆç¢ºå®Ÿã«è¡¨ç¤ºï¼‰
    scanLaser.style.pointerEvents = 'none';
    scanLaser.style.top = '15%'; // åˆæœŸä½ç½®
    
    // CSSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¯CSSã‚¯ãƒ©ã‚¹ã§é©ç”¨ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã“ã“ã§ã¯è¨­å®šä¸è¦
    
    if (isDebug()) {
      console.log('[EnsureScanbar] DOM ensured', {
        frameExists: !!scanFrame,
        laserExists: !!scanLaser,
        frameZIndex: scanFrame.style.zIndex,
        laserZIndex: scanLaser.style.zIndex
      });
    }
    
    return true;
  }
  
  // âœ… ã‚¹ã‚­ãƒ£ãƒ³ãƒãƒ¼ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤ºé–¢æ•°ï¼ˆæ”¹å–„ç‰ˆï¼‰
  function displayScanbarDebugInfo() {
    if (!isDebug()) return;
    
    const scanLaser = document.querySelector('.scan-laser');
    const scanFrame = document.querySelector('.scan-frame');
    
    const scanbarMode = 'DOM'; // DOMè¦ç´ ã§å®Ÿè£…
    let elementFound = false;
    let scanbarVisible = 'unknown';
    let laserZIndex = 'N/A';
    let frameZIndex = 'N/A';
    let laserRect = 'N/A';
    let frameRect = 'N/A';
    let laserElId = 'N/A';
    let parentElId = 'N/A';
    let computedZIndex = 'N/A';
    
    if (scanLaser) {
      elementFound = true;
      laserElId = scanLaser.id || '(no id)';
      parentElId = scanLaser.parentElement ? (scanLaser.parentElement.className || scanLaser.parentElement.id || '(no id/class)') : 'no parent';
      
      const laserStyle = window.getComputedStyle(scanLaser);
      laserZIndex = laserStyle.zIndex;
      computedZIndex = laserStyle.zIndex;
      
      const rect = scanLaser.getBoundingClientRect();
      laserRect = `w:${rect.width.toFixed(1)}, h:${rect.height.toFixed(1)}, top:${rect.top.toFixed(1)}`;
      
      // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const isVisible = (
        laserStyle.display !== 'none' &&
        laserStyle.visibility !== 'hidden' &&
        parseFloat(laserStyle.opacity) > 0 &&
        rect.width > 0 &&
        rect.height > 0
      );
      scanbarVisible = isVisible ? 'true' : 'false';
    } else {
      elementFound = false;
      scanbarVisible = 'element not found';
    }
    
    if (scanFrame) {
      const frameStyle = window.getComputedStyle(scanFrame);
      frameZIndex = frameStyle.zIndex;
      
      const rect = scanFrame.getBoundingClientRect();
      frameRect = `w:${rect.width.toFixed(1)}, h:${rect.height.toFixed(1)}`;
    }
    
    const debugInfo = {
      scanbarMode,
      elementFound,
      scanbarVisible,
      laserElId,
      parentElId,
      laserZIndex,
      computedZIndex,
      frameZIndex,
      laserRect,
      frameRect
    };
    
    console.log('[ScanbarDebug]', debugInfo);
    
    // ç”»é¢ã®å³ä¸Šãƒ­ã‚°ã‚¨ãƒªã‚¢ã«è¡¨ç¤º
    const errorDisplay = document.getElementById('debug-error-display');
    if (errorDisplay) {
      const debugText = `[Scanbar] Mode:${scanbarMode} | Found:${elementFound} | Visible:${scanbarVisible} | LaserZ:${laserZIndex} | FrameZ:${frameZIndex} | Parent:${parentElId}`;
      errorDisplay.textContent = debugText;
      errorDisplay.style.display = 'block';
    }
    
    // å®šæœŸçš„ã«æ›´æ–°ï¼ˆ1ç§’ã”ã¨ï¼‰
    const updateInterval = setInterval(() => {
      if (!isScanning) {
        clearInterval(updateInterval);
        return;
      }
      
      if (scanLaser) {
        const rect = scanLaser.getBoundingClientRect();
        const laserStyle = window.getComputedStyle(scanLaser);
        const isVisible = (
          laserStyle.display !== 'none' &&
          laserStyle.visibility !== 'hidden' &&
          parseFloat(laserStyle.opacity) > 0 &&
          rect.width > 0 &&
          rect.height > 0
        );
        
        const debugText = `[Scanbar] Mode:DOM | Visible:${isVisible} | LaserZ:${laserStyle.zIndex} | FrameZ:${frameZIndex} | Top:${rect.top.toFixed(1)}px`;
        
        if (errorDisplay) {
          errorDisplay.textContent = debugText;
        }
        
        console.log('[ScanbarDebug Update]', {
          visible: isVisible,
          top: rect.top.toFixed(1),
          opacity: laserStyle.opacity,
          animation: laserStyle.animation
        });
      }
    }, 1000);
  }

  async function stopScanner() {
    if(scanner) {
      try { await scanner.stop(); } catch(e) {}
      finally { document.getElementById('camera-area').style.display='none'; isScanning = false; }
    } else {
      document.getElementById('camera-area').style.display='none'; isScanning = false;
    }
  }

  function showHome() {
    try{ clearToasts(); }catch(e){}

    document.getElementById('mainView').style.display='block';
    document.getElementById('formView').style.display='none';
    renderHistory();
    renderStoreList();
    tempImgData = null;
    editingHistIdx = null;
  }

  async function showVeggieMenu() {
    showToast('ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã®ä¸‹ã«ã‚ã‚‹ã€Œ13æ¡ã®æ•°å­—ã€ã‚’å…¥ã‚Œã¦ã­', 6000);

    const raw = await customPrompt('å•†å“ã‚³ãƒ¼ãƒ‰ï¼ˆãƒãƒ¼ã‚³ãƒ¼ãƒ‰ä¸‹ã®13æ¡ï¼‰');
    if (!raw) return;

    const code = String(raw).replace(/\D/g, '').slice(0, 13);
    if (code.length !== 13) {
      showToast('13æ¡ã®æ•°å­—ã ã‘å…¥ã‚Œã¦ã­ï¼ˆä¾‹ï¼š490xxxxxxxxxxï¼‰', 8000);
      return;
    }

    showToast('OKã€‚å•†å“ã‚³ãƒ¼ãƒ‰ã§æ¢ã—ã¦ã¿ã‚‹ã­â€¦', 2500);

    // âœ… ã‚¹ã‚­ãƒ£ãƒ³æˆåŠŸæ™‚ã¨åŒã˜å‡¦ç†ã¸æ¸¡ã™
    manualBarcodeEntry(code);
  }

  // âœ… P0: å•†å“åã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆç®±å£²ã‚Šæƒ…å ±ãƒ»ä¸è¦ãªæƒ…å ±ã‚’é™¤å»ï¼‰
  function cleanProductName(name) {
    if (!name) return '';
    let cleaned = String(name).trim();
    
    // ç®±å£²ã‚Šæƒ…å ±ã‚’é™¤å»
    cleaned = cleaned.replace(/[Ã—xX]\d+[å€‹æœ¬å…¥æšç¼¶è¢‹]/g, ''); // Ã—10å€‹ã€Ã—12æœ¬ã€Ã—24å…¥ ãªã©
    cleaned = cleaned.replace(/\d+[å€‹æœ¬å…¥æšç¼¶è¢‹]ã‚»ãƒƒãƒˆ/g, ''); // 12å€‹ã‚»ãƒƒãƒˆ ãªã©
    cleaned = cleaned.replace(/\ï¼ˆã‚±ãƒ¼ã‚¹ï¼‰/g, ''); // ï¼ˆã‚±ãƒ¼ã‚¹ï¼‰
    cleaned = cleaned.replace(/\[ã‚±ãƒ¼ã‚¹\]/g, ''); // [ã‚±ãƒ¼ã‚¹]
    cleaned = cleaned.replace(/ã‚±ãƒ¼ã‚¹è²©å£²/g, ''); // ã‚±ãƒ¼ã‚¹è²©å£²
    
    // é€æ–™æƒ…å ±ã‚’é™¤å»
    cleaned = cleaned.replace(/é€æ–™[åˆ¥è¾¼ç„¡æ–™]/g, ''); // é€æ–™åˆ¥ã€é€æ–™è¾¼ã€é€æ–™ç„¡æ–™
    cleaned = cleaned.replace(/\|.*é€æ–™.*/g, ''); // | é€æ–™åˆ¥ ãªã©
    
    // ä½™åˆ†ãªç©ºç™½ãƒ»è¨˜å·ã‚’æ•´ç†
    cleaned = cleaned.replace(/\s+/g, ' ').trim();
    cleaned = cleaned.replace(/\s*\|\s*$/, '').trim(); // æœ«å°¾ã® | ã‚’é™¤å»
    
    return cleaned;
  }

  // âœ… P0: ãƒ¡ãƒ¼ã‚«ãƒ¼åæ¤œè¨¼ï¼ˆè²©å£²åº—åãªã©ã®ä¸æ­£ç¢ºãªæƒ…å ±ã‚’æ¤œå‡ºï¼‰
  function validateMakerName(maker) {
    if (!maker) return '';
    const cleaned = String(maker).trim();
    
    // è²©å£²åº—åã®ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆé™¤å¤–ã™ã¹ãã‚‚ã®ï¼‰
    const invalidPatterns = [
      /åº—$/,           // ã€Œâ—‹â—‹åº—ã€ã§çµ‚ã‚ã‚‹
      /ã‚·ãƒ§ãƒƒãƒ—$/,     // ã€Œâ—‹â—‹ã‚·ãƒ§ãƒƒãƒ—ã€ã§çµ‚ã‚ã‚‹
      /è²©å£²$/,         // ã€Œâ—‹â—‹è²©å£²ã€ã§çµ‚ã‚ã‚‹
      /^æ¥½å¤©/,         // ã€Œæ¥½å¤©â—‹â—‹ã€ã§å§‹ã¾ã‚‹
      /^Amazon/i,      // ã€ŒAmazonâ—‹â—‹ã€ã§å§‹ã¾ã‚‹
      /^Yahoo/i,       // ã€ŒYahooâ—‹â—‹ã€ã§å§‹ã¾ã‚‹
      /ï¼$/            // ã€Œâ—‹â—‹ï¼ã€ã§çµ‚ã‚ã‚‹ï¼ˆè²©å£²åº—åã®ç‰¹å¾´ï¼‰
    ];
    
    // ä¸æ­£ç¢ºãªãƒ‘ã‚¿ãƒ¼ãƒ³ã«ä¸€è‡´ã™ã‚‹å ´åˆã¯ç©ºæ–‡å­—ã‚’è¿”ã™
    for (const pattern of invalidPatterns) {
      if (pattern.test(cleaned)) {
        if (isDebug()) {
          console.log(`[MakerValidation] Invalid maker name detected: ${cleaned}`);
        }
        return '';
      }
    }
    
    return cleaned;
  }

  // âœ… P0: JAN/EAN-13 ãƒã‚§ãƒƒã‚¯ãƒ‡ã‚¸ãƒƒãƒˆæ¤œè¨¼
  function validateJanCheckDigit(jan) {
    if (!jan || jan.length !== 13) return false;
    const digits = jan.split('').map(Number);
    if (digits.some(isNaN)) return false;
    
    const checkDigit = digits[12];
    let sum = 0;
    for (let i = 0; i < 12; i++) {
      sum += digits[i] * (i % 2 === 0 ? 1 : 3);
    }
    const calculatedCheckDigit = (10 - (sum % 10)) % 10;
    return checkDigit === calculatedCheckDigit;
  }

  // âœ… P0: JANæ­£è¦åŒ–ï¼ˆæ•°å­—ã®ã¿ã«çµ±ä¸€ï¼‰
  function normalizeJan(code) {
    if (!code) return '';
    // æ•°å­—ä»¥å¤–ã‚’é™¤å»ï¼ˆç©ºç™½ãƒ»ãƒã‚¤ãƒ•ãƒ³ãƒ»å…¨è§’æ•°å­—ã‚’å«ã‚€ï¼‰
    let jan = String(code).replace(/[^0-9]/g, '');
    // 13æ¡ã«ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆ8æ¡ãƒ»12æ¡ã®å ´åˆã¯å…ˆé ­ã«0ã‚’è¿½åŠ ï¼‰
    if (jan.length === 8) {
      jan = '00000' + jan; // EAN-8 â†’ EAN-13å¤‰æ›
    } else if (jan.length === 12) {
      jan = '0' + jan; // UPC-A â†’ EAN-13å¤‰æ›
    }
    return jan;
  }

  // âœ… å•†å“åã®æ­£è¦åŒ–ï¼ˆçµ±åˆåˆ¤å®šç”¨ï¼‰
  function normalizeProductName(name, maker) {
    const n = String(name || '').trim().toLowerCase().replace(/\s+/g, '');
    const m = String(maker || '').trim().toLowerCase().replace(/\s+/g, '');
    return `${n}|${m}`;
  }

  // âœ… M_å•†å“ã¨JANã®è‡ªå‹•çµ±åˆï¼ˆèµ·å‹•æ™‚ãƒ»YahooæˆåŠŸã«ä¾å­˜ã—ãªã„ï¼‰
  function migrateMergeManualToJan() {
    if (!db || !db.products) return;
    
    let mergedCount = 0;
    const manualKeys = Object.keys(db.products).filter(k => k.startsWith('M_'));
    const janKeys = Object.keys(db.products).filter(k => /^\d{8,14}$/.test(k));
    
    manualKeys.forEach(mKey => {
      const mp = db.products[mKey];
      if (!mp || !mp.name) return;
      
      const mNormalized = normalizeProductName(mp.name, mp.maker);
      if (!mNormalized || mNormalized === '|') return;
      
      // åŒä¸€å•†å“ã®JANã‚’æ¢ã™
      const matchedJan = janKeys.find(jKey => {
        const jp = db.products[jKey];
        if (!jp || !jp.name) return false;
        const jNormalized = normalizeProductName(jp.name, jp.maker);
        return jNormalized === mNormalized;
      });
      
      if (matchedJan) {
        const jp = db.products[matchedJan];
        
        // history ã‚’ãƒãƒ¼ã‚¸
        if (Array.isArray(mp.history) && mp.history.length > 0) {
          jp.history = [...(jp.history || []), ...mp.history];
          // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§ã‚½ãƒ¼ãƒˆ
          jp.history.sort((a, b) => histTs(a) - histTs(b));
        }
        
        // imageKey ã‚’ãƒãƒ¼ã‚¸
        if (mp.imageKey && !jp.imageKey) {
          jp.imageKey = mp.imageKey;
        }
        
        // imageUrl ã‚’ãƒãƒ¼ã‚¸
        if (mp.imageUrl && !jp.imageUrl) {
          jp.imageUrl = mp.imageUrl;
        }
        
        // M_å•†å“ã‚’å‰Šé™¤
        delete db.products[mKey];
        mergedCount++;
        
        if (isDebug()) console.log('[Migrate] Merged:', mKey, 'â†’', matchedJan);
      }
    });
    
    if (mergedCount > 0) {
      saveLocalOnly();
      if (isDebug()) console.log('[Migrate] Total merged:', mergedCount);
    }
  }

  // âœ… ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿å‡¦ç†ï¼ˆã‚¹ã‚­ãƒ£ãƒ³/æ‰‹å…¥åŠ›å…±é€šï¼‰with OFFå„ªå…ˆ + dirtyãƒ•ãƒ©ã‚°ä¿è­· + P0ã‚¿ã‚¤ãƒ ãƒ©ã‚°å¯¾ç­–
  async function processBarcodeData(code) {
    // âœ… P0: JANæ­£è¦åŒ–ï¼ˆæ•°å­—ã®ã¿ã«çµ±ä¸€ãƒ»ç©ºç™½ãƒ»ãƒã‚¤ãƒ•ãƒ³é™¤å»ï¼‰
    let jan = normalizeJan(code);
    
    // âœ… P0: 13æ¡ï¼ˆJAN/EAN-13ï¼‰ãƒã‚§ãƒƒã‚¯
    if (jan.length !== 13) {
      const errorMsg = `ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãŒä¸æ­£ã§ã™ï¼ˆ13æ¡ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰: ${jan}ï¼ˆå…ƒ: ${code}ï¼‰`;
      showToast(errorMsg, 5000);
      if (isDebug()) {
        console.error("[ProcessBarcode] Invalid JAN length:", jan, "original:", code);
        addErrorLog(`[JAN Invalid] ${errorMsg}`);
      }
      return; // 13æ¡ã§ãªã„å ´åˆã¯å‡¦ç†ã‚’ä¸­æ­¢
    }
    
    // âœ… P0: ãƒã‚§ãƒƒã‚¯ãƒ‡ã‚¸ãƒƒãƒˆæ¤œè¨¼
    if (!validateJanCheckDigit(jan)) {
      const errorMsg = `ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ãƒ‡ã‚¸ãƒƒãƒˆãŒä¸æ­£ã§ã™: ${jan}`;
      showToast(errorMsg, 5000);
      if (isDebug()) {
        console.error("[ProcessBarcode] Invalid check digit:", jan);
        addErrorLog(`[JAN Check Digit Error] ${errorMsg}`);
      }
      return; // ãƒã‚§ãƒƒã‚¯ãƒ‡ã‚¸ãƒƒãƒˆä¸æ­£ã®å ´åˆã¯å‡¦ç†ã‚’ä¸­æ­¢
    }
    
    // âœ… P0: debug=1 æ™‚ã®è©³ç´°è¡¨ç¤º
    if (isDebug()) {
      console.log("[ProcessBarcode] Valid JAN:", jan, "original:", code);
      // ç”»é¢ã«è©³ç´°æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆå¾Œç¶šã§è¿½åŠ ï¼‰
    }
    
    // âœ… P0: åŒä¸€JANã®äºŒé‡ç™ºç«ã‚’æ­¢ã‚ã‚‹ï¼ˆé€£ç¶šèª­å–ã‚Šå¯¾ç­–ï¼‰
    if (jan && processBarcodeInFlight.has(jan)) {
      if (isDebug()) {
        console.log("[ProcessBarcode] Already in flight, skip:", jan);
        showToast("æ—¢ã«å‡¦ç†ä¸­ã§ã™", 2000);
      }
      return;
    }
    
    // âœ… P0: åŒã˜JANã‚’0.8ã€œ1.2ç§’ä»¥å†…ã«å†æ¤œå‡ºã—ãŸã‚‰ç„¡è¦–ï¼ˆã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰
    if (jan && /^\d{8,14}$/.test(jan)) {
      const now = Date.now();
      const lastTime = janCoolDown.get(jan);
      if (lastTime && (now - lastTime) < 1000) { // 1ç§’ä»¥å†…ï¼ˆ0.8ã€œ1.2ç§’ã®ä¸­å¤®å€¤ï¼‰
        if (isDebug()) {
          console.log("[ProcessBarcode] Cool down, skip:", jan, "last:", lastTime, "now:", now);
          showToast("åŒã˜ã‚³ãƒ¼ãƒ‰ã‚’æ¤œå‡ºã—ã¾ã—ãŸï¼ˆã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ï¼‰", 1500);
        }
        return;
      }
      janCoolDown.set(jan, now);
      // âœ… å¤ã„ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³è¨˜éŒ²ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆ5ç§’ä»¥ä¸ŠçµŒéã—ãŸã‚‚ã®ã¯å‰Šé™¤ï¼‰
      for (const [key, time] of janCoolDown.entries()) {
        if (now - time > 5000) {
          janCoolDown.delete(key);
        }
      }
    }
    
    if (jan && /^\d{8,14}$/.test(jan)) {
      processBarcodeInFlight.add(jan);
    }
    
    curBarcode = jan; // âœ… P0: æ­£è¦åŒ–å¾Œã®JANã‚’ã‚»ãƒƒãƒˆï¼ˆå–å¾—å‰ï¼‰
    
    // âœ… P0: å¯¾ç­–A: openForm ã‚’å…ˆã«å‡ºã™ï¼ˆèª­ã‚ãŸç¬é–“ã«ç”»é¢ã‚’å‹•ã‹ã™ï¼‰
    openForm(jan);
    
    // âœ… P0: JANè¡¨ç¤ºãƒ»å–å¾—ä¸­ãƒˆãƒ¼ã‚¹ãƒˆãƒ»å…¥åŠ›æ¬„ã‚’è§¦ã‚Œã‚‹çŠ¶æ…‹ã«ã™ã‚‹
    if (jan && /^\d{8,14}$/.test(jan)) {
      showToast(`JAN: ${jan}`, 2000);
      // âœ… å¯¾ç­–A: ã€Œå–å¾—ä¸­â€¦ã€è¡¨ç¤º
      const nameInput = document.getElementById('inputName');
      const makerInput = document.getElementById('inputMaker');
      const originalPlaceholder = nameInput ? nameInput.placeholder : '';
      
      // âœ… dirtyãƒ•ãƒ©ã‚°: openFormç›´å¾Œã®å€¤ã‚’è¨˜éŒ²
      const nameAtStart = nameInput ? nameInput.value : '';
      const makerAtStart = makerInput ? makerInput.value : '';
      
      if (nameInput && !nameAtStart) {
        nameInput.placeholder = 'å•†å“æƒ…å ±ã‚’å–å¾—ä¸­â€¦';
      }
      
      try {
          const p = db.products[jan] || { history: [] };
        let yahooInfo = null;
        let rakutenInfo = null;
        let offInfo = null;
        let finalInfo = { name: '', maker: '', imageUrl: '', imageRefType: '', areaId: '' };
        let sourceUsed = 'none'; // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šã©ã®ã‚½ãƒ¼ã‚¹ã‚’æ¡ç”¨ã—ãŸã‹

        // âœ… P0: æœ€å„ªå…ˆ: LocalStorageã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆå…±æœ‰DBæš«å®šå®Ÿè£…ï¼‰
        const cachedData = getJanCache(jan);
        if (cachedData && cachedData.name) {
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰å¾©å…ƒ
          finalInfo.name = cachedData.name || '';
          finalInfo.maker = cachedData.maker || '';
          finalInfo.imageUrl = cachedData.imageUrl || '';
          finalInfo.imageRefType = cachedData.imageRefType || '';
          finalInfo.areaId = cachedData.areaId || '';
          sourceUsed = 'cache';

          // âœ… å³åº§ã«ãƒ•ã‚©ãƒ¼ãƒ ã«åæ˜ 
          const currentJanCheck = String(curBarcode || '').trim();
          if (currentJanCheck === jan) {
            if (nameInput && nameInput.value === nameAtStart && finalInfo.name) {
              nameInput.value = finalInfo.name;
              nameInput.placeholder = originalPlaceholder;
            }
            if (makerInput && makerInput.value === makerAtStart && finalInfo.maker) {
              makerInput.value = finalInfo.maker;
            }
            const imgEl = document.getElementById('productImage');
            if (imgEl && finalInfo.imageUrl && !imgEl.src) {
              imgEl.src = finalInfo.imageUrl;
            }
          }

          if (isDebug()) {
            showToast(`[ã‚­ãƒ£ãƒƒã‚·ãƒ¥] ä½¿ç”¨: ${finalInfo.name.substring(0, 20)}...`, 3000);
            console.log("[ProcessBarcode] Cache hit:", cachedData);
          }

          // âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒååˆ†ãªå ´åˆã¯ã€Webæ¤œç´¢ã‚’ã‚¹ã‚­ãƒƒãƒ—
          const isCacheSufficient = finalInfo.name && finalInfo.name.length > 3;
          if (isCacheSufficient) {
            // âœ… DBã«ä¿å­˜ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼‰
            if (finalInfo.name && (!p.name || !p.name.trim())) {
              p.name = finalInfo.name;
            }
            if (finalInfo.maker && (!p.maker || !p.maker.trim())) {
              p.maker = finalInfo.maker;
            }
            if (finalInfo.imageUrl && (!p.imageUrl || !p.imageUrl.startsWith('http'))) {
              p.imageUrl = finalInfo.imageUrl;
            }
            db.products[jan] = p;
            saveDb();

            // âœ… å‡¦ç†å®Œäº†
            processBarcodeInFlight.delete(jan);
            return;
          }
        }

        // âœ… P0: åæ˜ ãƒ©ã‚°çŸ­ç¸®ï¼ˆ"å…ˆã«ä»®åæ˜ â†’è£ã§è£œå®Œ"ï¼‰
        // âœ… å„ªå…ˆé †ä½1: Yahooæœ€å„ªå…ˆï¼ˆå•†å“èº«å…ƒæƒ…å ±ï¼‹ä¾¡æ ¼æƒ…å ±ï¼‰
        yahooInfo = await lookupYahooByJan(jan);
        
        if (yahooInfo) {
          // âœ… å“è³ªã‚¹ã‚³ã‚¢ã§æ¡ç”¨ã‚’çµã‚‹ï¼ˆYahooã®ã‚¹ã‚³ã‚¢åˆ¤å®šï¼‰
          const yahooTrustScore = yahooInfo.trustScore || 100;
          const yahooPackHint = yahooInfo.packHint || false;
          
          // âœ… YahooãŒå¾®å¦™ï¼ˆã‚¹ã‚³ã‚¢ä½ã„ï¼‰ãªã‚‰æ¥½å¤©ã‚’æ¡ç”¨ã™ã‚‹
          if (yahooTrustScore < 70 || (yahooPackHint && yahooTrustScore < 80)) {
            // Yahooã®ã‚¹ã‚³ã‚¢ãŒä½ã„å ´åˆã¯æ¥½å¤©ã‚’å„ªå…ˆæ¤œè¨
            if (isDebug()) {
              showToast(`[Yahoo] ã‚¹ã‚³ã‚¢ä½ (${yahooTrustScore}) â†’ æ¥½å¤©æ¤œè¨`, 3000);
            }
          } else {
            // âœ… Yahooã§å•†å“èº«å…ƒæƒ…å ±ã‚’åŸ‹ã‚ã‚‹ï¼ˆã‚¹ã‚³ã‚¢ãŒååˆ†ãªå ´åˆï¼‰
            finalInfo.name = cleanProductName(yahooInfo.name || '');
            finalInfo.maker = validateMakerName(yahooInfo.maker || '');
            finalInfo.imageUrl = yahooInfo.imageUrl || '';
            sourceUsed = 'yahoo';

            // âœ… P0: Yahooå–å¾—â†’æ•´å½¢â†’æ®µéšæ›´æ–°ï¼ˆå…ˆã«ä»®åæ˜ ï¼‰
            const currentJanCheck = String(curBarcode || '').trim();
            if (currentJanCheck === jan) {
              // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ã¦ã„ãªã„å ´åˆã®ã¿æ›´æ–°
              if (nameInput && nameInput.value === nameAtStart && finalInfo.name) {
                nameInput.value = finalInfo.name;
                nameInput.placeholder = originalPlaceholder;
              }
              if (makerInput && makerInput.value === makerAtStart && finalInfo.maker) {
                makerInput.value = finalInfo.maker;
              }
              // ç”»åƒã‚‚å³åº§ã«æ›´æ–°ï¼ˆå¯èƒ½ãªå ´åˆï¼‰
              const imgEl = document.getElementById('productImage');
              if (imgEl && finalInfo.imageUrl && !imgEl.src) {
                imgEl.src = finalInfo.imageUrl;
              }
            }

            // âœ… ãƒ‡ãƒãƒƒã‚°: Yahooå–å¾—æˆåŠŸ
            if (isDebug()) {
              showToast(`[Yahoo] OK (ã‚¹ã‚³ã‚¢:${yahooTrustScore})`, 3000);
            }
          }

          // âœ… YahooçµæœãŒå¼±ã„/ç©ºã€ã¾ãŸã¯ã‚¹ã‚³ã‚¢ãŒä½ã„å ´åˆã¯æ¥½å¤©ã§è£œå®Œ
          const yahooWeak = !finalInfo.name || !finalInfo.maker || !finalInfo.imageUrl || yahooTrustScore < 70;
          if (yahooWeak) {
            // âœ… å„ªå…ˆé †ä½2: æ¥½å¤©ï¼ˆå›½å†…DBç¬¬2å„ªå…ˆï¼‰
            rakutenInfo = await lookupRakutenByJan(jan);
            
            if (rakutenInfo) {
              // âœ… ä¸è¶³ã—ã¦ã„ã‚‹é …ç›®ã ã‘è£œå®Œï¼ˆä¸Šæ›¸ãã—ãªã„ï¼‰
              if (!finalInfo.name && rakutenInfo.name) {
                finalInfo.name = cleanProductName(rakutenInfo.name);
                sourceUsed = 'yahoo+rakuten';
              }
              if (!finalInfo.maker && rakutenInfo.maker) {
                finalInfo.maker = validateMakerName(rakutenInfo.maker);
                sourceUsed = 'yahoo+rakuten';
              }
              // âœ… ç”»åƒãŒã‚±ãƒ¼ã‚¹ç”»åƒã£ã½ã„â†’æ¥½å¤©ã®å˜å“ç”»åƒãŒã‚ã‚Œã°å·®ã—æ›¿ãˆï¼ˆã‚¹ã‚³ã‚¢ã‚’ä¸‹ã’ã‚‹ï¼‰
              if ((yahooInfo.packHint || yahooInfo.isCase) && rakutenInfo.imageUrl) {
                finalInfo.imageUrl = rakutenInfo.imageUrl;
                sourceUsed = 'yahoo+rakuten';
                if (isDebug()) {
                  showToast(`[æ¥½å¤©] ã‚±ãƒ¼ã‚¹ç”»åƒâ†’å˜å“ç”»åƒã«å·®ã—æ›¿ãˆ`, 3000);
                }
              } else if (!finalInfo.imageUrl && rakutenInfo.imageUrl) {
                finalInfo.imageUrl = rakutenInfo.imageUrl;
                sourceUsed = 'yahoo+rakuten';
              }

              // âœ… P0: æ¥½å¤©å–å¾—â†’æ®µéšæ›´æ–°ï¼ˆä¸è¶³é …ç›®ã ã‘è£œå®Œï¼‰
              const currentJanCheck2 = String(curBarcode || '').trim();
              if (currentJanCheck2 === jan) {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ã¦ã„ãªã„å ´åˆã®ã¿æ›´æ–°
                if (nameInput && nameInput.value === nameAtStart && finalInfo.name && !nameInput.value) {
                  nameInput.value = finalInfo.name;
                  nameInput.placeholder = originalPlaceholder;
                }
                if (makerInput && makerInput.value === makerAtStart && finalInfo.maker && !makerInput.value) {
                  makerInput.value = finalInfo.maker;
                }
                // ç”»åƒã‚‚å³åº§ã«æ›´æ–°ï¼ˆå¯èƒ½ãªå ´åˆï¼‰
                const imgEl = document.getElementById('productImage');
                if (imgEl && finalInfo.imageUrl && (!imgEl.src || imgEl.src.includes('placeholder'))) {
                  imgEl.src = finalInfo.imageUrl;
                }
              }

              if (isDebug()) {
                showToast(`[æ¥½å¤©] è£œå®ŒOK`, 3000);
              }
            }
          }
        } else {
          // âœ… YahooãŒæœªå–å¾—ã®å ´åˆ
          // âœ… å„ªå…ˆé †ä½2: æ¥½å¤©ï¼ˆå›½å†…DBç¬¬2å„ªå…ˆï¼‰
          rakutenInfo = await lookupRakutenByJan(jan);
          
          if (rakutenInfo) {
            // âœ… æ¥½å¤©ã§å•†å“èº«å…ƒæƒ…å ±ã‚’åŸ‹ã‚ã‚‹
            finalInfo.name = cleanProductName(rakutenInfo.name || '');
            finalInfo.maker = validateMakerName(rakutenInfo.maker || '');
            finalInfo.imageUrl = rakutenInfo.imageUrl || '';
            sourceUsed = 'rakuten';

            // âœ… P0: æ¥½å¤©å–å¾—â†’æ®µéšæ›´æ–°ï¼ˆå…ˆã«ä»®åæ˜ ï¼‰
            const currentJanCheck3 = String(curBarcode || '').trim();
            if (currentJanCheck3 === jan) {
              // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ã¦ã„ãªã„å ´åˆã®ã¿æ›´æ–°
              if (nameInput && nameInput.value === nameAtStart && finalInfo.name) {
                nameInput.value = finalInfo.name;
                nameInput.placeholder = originalPlaceholder;
              }
              if (makerInput && makerInput.value === makerAtStart && finalInfo.maker) {
                makerInput.value = finalInfo.maker;
              }
              // ç”»åƒã‚‚å³åº§ã«æ›´æ–°ï¼ˆå¯èƒ½ãªå ´åˆï¼‰
              const imgEl = document.getElementById('productImage');
              if (imgEl && finalInfo.imageUrl && !imgEl.src) {
                imgEl.src = finalInfo.imageUrl;
              }
            }
          } else {
            // âœ… Yahooã‚‚æ¥½å¤©ã‚‚æœªå–å¾—ã®å ´åˆã®ã¿ã€OFFã‚’ä½¿ç”¨ï¼ˆç¬¬3å„ªå…ˆï¼‰
            // âœ… OFFã‚’ä½¿ã†æ¡ä»¶: Yahooã‚‚æ¥½å¤©ã‚‚ã€Œæœªå–å¾—ã€ã¾ãŸã¯ã€Œæ•´å½¢å¾Œã‚‚ä¸è‡ªç„¶ã€
            offInfo = await lookupOffByJan(jan);
            
            if (offInfo) {
              // âœ… OFFã§å•†å“èº«å…ƒæƒ…å ±ã‚’åŸ‹ã‚ã‚‹ï¼ˆæ¡ä»¶ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ãƒ»æœ€çµ‚è£œåŠ©ï¼‰
              // OFFã¯ã€Œã‚¿ã‚¤ãƒˆãƒ«ç¢ºå®šã€ã§ã¯ãªãã€ã‚«ãƒ†ã‚´ãƒªãƒ»æˆåˆ†ãƒ»è£œåŠ©ç”»åƒã®ç©´åŸ‹ã‚ã«å¯„ã›ã‚‹ï¼ˆä¸»å½¹ã«ã—ãªã„ï¼‰
              // æ—¥æœ¬èªåãŒã‚ã‚‹ã€ã¾ãŸã¯æ—¥æœ¬å‘ã‘ãƒ‡ãƒ¼ã‚¿ã£ã½ã„æ™‚ã ã‘æ¡ç”¨
              // ç”»åƒãŒ"è‡ªæ’®ã‚Š/ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ•ç¨¿"ã£ã½ã„ï¼ˆé›‘ãƒ»æš—ã„ãƒ»æ–œã‚ãƒ»èƒŒæ™¯ã‚ã‚Šç­‰ï¼‰å ´åˆã¯æ¡ç”¨ã—ãªã„
              if (offInfo.name && offInfo.name.trim()) {
                // æ—¢ã«Yahoo/æ¥½å¤©ã§åå‰ãŒå–ã‚Œã¦ã„ã‚‹å ´åˆã¯ä¸Šæ›¸ãã—ãªã„ï¼ˆè£œåŠ©ã¨ã—ã¦ä½¿ã†ï¼‰
                if (!finalInfo.name || finalInfo.name.trim().length < 3) {
                  finalInfo.name = cleanProductName(offInfo.name);
                  sourceUsed = 'off';
                }
              }
              if (offInfo.maker && offInfo.maker.trim() && !finalInfo.maker) {
                finalInfo.maker = validateMakerName(offInfo.maker);
                if (sourceUsed === 'none') sourceUsed = 'off';
              }
              // ç”»åƒã¯æœ€å¾Œã®æ‰‹æ®µï¼ˆè‡ªæ’®ã‚Š/ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ•ç¨¿ã£ã½ã„å ´åˆã¯æ¡ç”¨ã—ãªã„ï¼‰
              if (offInfo.imageUrl && offInfo.imageUrl.trim() && !finalInfo.imageUrl) {
                // ç”»åƒURLã« "front" ãŒå«ã¾ã‚Œã‚‹ã€ã¾ãŸã¯æ˜ã‚‰ã‹ã«å•†å“æ­£é¢ç”»åƒã®å ´åˆã®ã¿æ¡ç”¨
                if (offInfo.imageUrl.includes('front') || offInfo.imageUrl.includes('image_front')) {
                  finalInfo.imageUrl = offInfo.imageUrl;
                  if (sourceUsed === 'none') sourceUsed = 'off';
                }
              }

              // âœ… P0: OFFå–å¾—â†’æ®µéšæ›´æ–°ï¼ˆæœ€å¾Œã®è£œåŠ©ï¼‰
              const currentJanCheck4 = String(curBarcode || '').trim();
              if (currentJanCheck4 === jan) {
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ã¦ã„ãªã„å ´åˆã®ã¿æ›´æ–°
                if (nameInput && nameInput.value === nameAtStart && finalInfo.name && !nameInput.value) {
                  nameInput.value = finalInfo.name;
                  nameInput.placeholder = originalPlaceholder;
                }
                if (makerInput && makerInput.value === makerAtStart && finalInfo.maker && !makerInput.value) {
                  makerInput.value = finalInfo.maker;
                }
                // ç”»åƒã‚‚å³åº§ã«æ›´æ–°ï¼ˆå¯èƒ½ãªå ´åˆï¼‰
                const imgEl = document.getElementById('productImage');
                if (imgEl && finalInfo.imageUrl && (!imgEl.src || imgEl.src.includes('placeholder'))) {
                  imgEl.src = finalInfo.imageUrl;
                }
              }

              if (isDebug() && sourceUsed === 'off') {
                showToast(`[OFF] æœ€çµ‚è£œåŠ©ã¨ã—ã¦æ¡ç”¨`, 3000);
              }
            }
          }
        }

        // âœ… P0: å¤ã„çµæœã®ä¸Šæ›¸ãé˜²æ­¢ï¼ˆç¾åœ¨ã®JANã¨ä¸€è‡´ã™ã‚‹æ™‚ã ã‘åæ˜ ï¼‰
        const currentJan = String(curBarcode || '').trim();
        if (currentJan !== jan) {
          if (isDebug()) {
            console.log("[ProcessBarcode] JAN mismatch, skip update:", currentJan, "!=", jan);
            showToast("å‡¦ç†ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ", 2000);
          }
          processBarcodeInFlight.delete(jan);
          return; // å¤ã„çµæœã¯åæ˜ ã—ãªã„
        }

        // âœ… ãƒ‡ãƒãƒƒã‚°: ã©ã®ã‚½ãƒ¼ã‚¹ã‚’æ¡ç”¨ã—ãŸã‹
        if (isDebug()) {
          showToast(`[æ¡ç”¨] ${sourceUsed}`, 3000);
          console.log("[ProcessBarcode] Source used:", sourceUsed, { yahooInfo, rakutenInfo, offInfo });
        }

        // âœ… å•†å“æƒ…å ±ã‚’DBã«ä¿å­˜ï¼ˆfinalInfoã‚’ä½¿ç”¨ï¼‰
        if (finalInfo.name && (!p.name || !p.name.trim())) {
          p.name = finalInfo.name;
        }
        if (finalInfo.maker && (!p.maker || !p.maker.trim())) {
          p.maker = finalInfo.maker;
        }
        if (finalInfo.imageUrl && (!p.imageUrl || !p.imageUrl.startsWith('http'))) {
          p.imageUrl = finalInfo.imageUrl;
          }
          
          // âœ… æ—¢å­˜ã® M_ å•†å“ï¼ˆæ‰‹å…¥åŠ›ç”±æ¥ï¼‰ã¨çµ±åˆ
        if (finalInfo.name || finalInfo.maker) {
          const normalized = normalizeProductName(finalInfo.name, finalInfo.maker);
          Object.keys(db.products || {}).forEach(key => {
            if (key.startsWith('M_') && key !== jan) {
              const mp = db.products[key];
              if (!mp) return;
              const mNormalized = normalizeProductName(mp.name, mp.maker);
              if (mNormalized === normalized) {
                // çµ±åˆï¼šhistory ã¨ imageKey ã‚’ãƒãƒ¼ã‚¸
                if (Array.isArray(mp.history) && mp.history.length > 0) {
                  p.history = [...(p.history || []), ...mp.history];
                }
                if (mp.imageKey && !p.imageKey) {
                  p.imageKey = mp.imageKey;
                }
                if (mp.imageUrl && !p.imageUrl) {
                  p.imageUrl = mp.imageUrl;
                }
                // M_ å•†å“ã‚’å‰Šé™¤
                delete db.products[key];
                if (isDebug()) console.log('[Merge] M_ product merged:', key, 'â†’', jan);
              }
            }
          });
        }
          
          db.products[jan] = p;
          saveLocalOnly();

        // âœ… P0: å–å¾—ã—ãŸå•†å“æƒ…å ±ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜ï¼ˆå…±æœ‰DBæš«å®šå®Ÿè£…ï¼‰
        if (finalInfo.name || finalInfo.maker || finalInfo.imageUrl) {
          // imageRefTypeã‚’åˆ¤å®š
          let imageRefType = '';
          if (finalInfo.imageUrl) {
            if (sourceUsed.includes('yahoo')) imageRefType = 'ec';
            else if (sourceUsed.includes('rakuten')) imageRefType = 'ec';
            else if (sourceUsed === 'off') imageRefType = 'off';
            else imageRefType = 'ec'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
          }
          finalInfo.imageRefType = imageRefType;

          setJanCache(jan, {
            name: finalInfo.name || '',
            maker: finalInfo.maker || '',
            imageUrl: finalInfo.imageUrl || '',
            imageRefType: imageRefType,
            source: sourceUsed
          });
        }
        
        // âœ… dirtyãƒ•ãƒ©ã‚°ã§ä¿è­·: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—å§‹ã‚ã¦ã„ãŸã‚‰ä¸Šæ›¸ãã—ãªã„
        if (nameInput) {
          const nameNow = nameInput.value || '';
          // é–‹å§‹æ™‚ã¨å¤‰ã‚ã£ã¦ã„ãªã‘ã‚Œã°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ã¦ã„ãªã„ï¼‰è‡ªå‹•åæ˜ 
          if (nameNow === nameAtStart && finalInfo.name) {
            nameInput.value = finalInfo.name;
          } else if (nameNow !== nameAtStart) {
            if (isDebug()) console.log('[ProcessBarcode] Name dirty, skip auto-fill');
          }
          nameInput.placeholder = originalPlaceholder;
        }
        
        if (makerInput) {
          const makerNow = makerInput.value || '';
          // é–‹å§‹æ™‚ã¨å¤‰ã‚ã£ã¦ã„ãªã‘ã‚Œã°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…¥åŠ›ã—ã¦ã„ãªã„ï¼‰è‡ªå‹•åæ˜ 
          if (makerNow === makerAtStart && finalInfo.maker) {
            makerInput.value = finalInfo.maker;
          } else if (makerNow !== makerAtStart) {
            if (isDebug()) console.log('[ProcessBarcode] Maker dirty, skip auto-fill');
          }
        }
        
        // âœ… P0: æƒ…å ±å–å¾—çµæœã®ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºï¼ˆæ”¹å–„ç‰ˆï¼‰
        const hasData = finalInfo.name || finalInfo.maker || finalInfo.imageUrl;
        if (hasData) {
          showToast("å•†å“æƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸ", 3000);
        } else {
          showToast("å•†å“æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ", 5000);
        }
        
        // âœ… P0: debug=1 æ™‚ã®è©³ç´°è¡¨ç¤ºï¼ˆLAST_JAN / SOURCE / STATUS / å–å¾—ãƒ‡ãƒ¼ã‚¿ï¼‰
        if (isDebug()) {
          const debugStatus = {
            LAST_JAN: jan,
            SOURCE: sourceUsed,
            STATUS: hasData ? 'å–å¾—æˆåŠŸ' : 'å–å¾—å¤±æ•—',
            NAME: finalInfo.name || '(ãªã—)',
            MAKER: finalInfo.maker || '(ãªã—)',
            IMAGE: finalInfo.imageUrl ? 'âœ… ã‚ã‚Š' : 'âŒ ãªã—'
          };
          console.log('[Debug] Product Data:', debugStatus);
          
          // ç”»é¢ã«ç°¡æ˜“è¡¨ç¤ºï¼ˆ5ç§’é–“ï¼‰
          const debugMsg = `[DEBUG] JAN: ${jan}\nSOURCE: ${sourceUsed}\nSTATUS: ${debugStatus.STATUS}\nNAME: ${debugStatus.NAME}\nIMAGE: ${debugStatus.IMAGE}`;
          showToast(debugMsg, 5000);
        }
        
        // âœ… ç”»åƒã‚‚æ›´æ–°ï¼ˆæ—¢å­˜ã®openFormå‡¦ç†ã¨çµ±åˆï¼‰
        const prevImg = document.getElementById('previewImg');
        if (prevImg && finalInfo.imageUrl) {
          prevImg.src = finalInfo.imageUrl;
        }
      } catch(e) {
        // âœ… P0: å–å¾—å¤±æ•—æ™‚ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
        showToast(`å•†å“æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ`, 5000);
        if (isDebug()) {
          showToast(`æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼: ${e.message}`, 5000);
          console.error('[ProcessBarcode] Error:', e);
          addErrorLog(`[Product Fetch Error] ${e.message}`);
        }
        // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚placeholderã‚’æˆ»ã™
        if (nameInput) {
          nameInput.placeholder = originalPlaceholder;
        }
      } finally {
        // âœ… P0: å‡¦ç†å®Œäº†æ™‚ã«ãƒ•ãƒ©ã‚°ã‚’è§£é™¤
        if (jan && /^\d{8,14}$/.test(jan)) {
          processBarcodeInFlight.delete(jan);
        }
      }
    } else {
      // âœ… JANãŒç„¡åŠ¹ãªå ´åˆã‚‚ãƒ•ãƒ©ã‚°ã‚’è§£é™¤
      if (jan) {
        processBarcodeInFlight.delete(jan);
      }
    }
  }

  // âœ… æ‰‹å…¥åŠ›ãƒãƒ¼ã‚³ãƒ¼ãƒ‰å‡¦ç†ï¼ˆå…±é€šé–¢æ•°ã‚’å‘¼ã¶ï¼‰
  async function manualBarcodeEntry(code) {
    try {
      await processBarcodeData(code);
    } catch(e) {
      if (isDebug()) console.warn('[manualBarcodeEntry]', e);
      showToast('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ãŸã¿ãŸã„ã€‚ã‚‚ã†ä¸€åº¦ã‚„ã£ã¦ã¿ã¦ã­', 8000);
    }
  }

  function setupFocusGuides() {
    const gs = { 'inputName': "ä¾‹ï¼šã‚³ãƒ¼ãƒ© 500ml", 'inputPrice': "ä¾¡æ ¼ã‚’å…¥åŠ›" };
    Object.keys(gs).forEach(id => {
      const el=document.getElementById(id);
      if(el) el.onfocus = () => showToast(gs[id], 1500);
    });
  }

  // âœ… æ¤œç´¢ãƒœã‚¿ãƒ³ï¼šå•†å“ã‚³ãƒ¼ãƒ‰ï¼‹å•†å“åã§ç”»åƒæ¤œç´¢ã‚’é–‹ã
  function searchImageWeb() {
    const name = (document.getElementById('inputName')?.value || '').trim();
    const code = String(curBarcode || '').trim();

    const q = (code && name) ? `${code} ${name}` : (code || name);
    if (!q) {
      showToast('å•†å“ã‚³ãƒ¼ãƒ‰ï¼ˆ13æ¡ï¼‰ã‹å•†å“åã‚’å…¥ã‚Œã¦ã­', 6000);
      return;
    }

    const url = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(q)}`;
    window.open(url, '_blank', 'noopener');
    showToast('ç”»åƒæ¤œç´¢ã‚’é–‹ã„ãŸã‚ˆã€‚ç”»åƒã‚’ä¿å­˜ã—ã¦ã€Œãƒ•ã‚©ãƒ«ãƒ€ã€ã‹ã‚‰é¸ã‚“ã§ã­', 7000);
  }

  // âœ… ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆSNSå…±æœ‰ç”¨ï¼šFirebaseã«ä¿å­˜ï¼‰
  async function handleImage(input) {
    if (!input || !input.files || !input.files[0]) {
      return;
    }
    const file = input.files[0];
    showToast("ç”»åƒã‚’å‡¦ç†ä¸­â€¦", 2000);

    try {
      // âœ… ç”»åƒã‚’ç¸®å°ï¼ˆã‚µã‚¤ã‚ºåˆ¶é™å¯¾ç­–ãƒ»EXIFå‰Šé™¤ï¼‰
      const blob = await fileToThumbBlob(file, 512, 0.85); // æœ€å¤§512pxã€å“è³ª85%
      if (!blob) {
        showToast("ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ", 8000);
        return;
      }

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
      const prev = document.getElementById('previewImg');
      if (prev) {
        try {
          const url = URL.createObjectURL(blob);
          prev.src = url;
          prev.referrerPolicy = "no-referrer";
        } catch(e) {
          console.warn('[Image] createObjectURL failed:', e);
        }
      }

      // âœ… Firebaseã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆSNSå…±æœ‰ï¼‰
      if (fbUrl && curBarcode) {
        showToast("ç”»åƒã‚’å…±æœ‰ä¸­â€¦", 3000);
        try {
          const { imageId } = await uploadImageToFirebase(curBarcode, blob);
          tempImgData = { type:'shared', imageId, blob };
          showToast("ç”»åƒã‚’å…±æœ‰ã—ã¾ã—ãŸ", 3000);
        } catch(e) {
          showToast(`å…±æœ‰å¤±æ•—: ${e.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`, 8000);
          // å…±æœ‰å¤±æ•—æ™‚ã‚‚ç«¯æœ«å†…ã«ä¿å­˜ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
          const key = `img_${Date.now()}_${Math.random().toString(16).slice(2)}`;
          const ok = await idbPut(key, blob);
          if (ok) {
            tempImgData = { type:'key', key };
            showToast("ç«¯æœ«å†…ã«ä¿å­˜ã—ã¾ã—ãŸï¼ˆå…±æœ‰ã¯å¤±æ•—ï¼‰", 5000);
          }
        }
      } else {
        // Firebaseæœªè¨­å®šæ™‚ã¯ç«¯æœ«å†…ã®ã¿ä¿å­˜
        const key = `img_${Date.now()}_${Math.random().toString(16).slice(2)}`;
        const ok = await idbPut(key, blob);
        if (!ok) {
          showToast("ç«¯æœ«ã®ç”»åƒä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè¨­å®š/å®¹é‡ã‚’ç¢ºèªï¼‰", 10000);
          return;
        }
        tempImgData = { type:'key', key };
        showToast("ç”»åƒã‚’ç«¯æœ«å†…ã«ä¿å­˜ã—ã¾ã—ãŸ", 5000);
      }
    } catch(e) {
      showToast(`ç”»åƒå‡¦ç†ã‚¨ãƒ©ãƒ¼: ${e.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`, 8000);
      if (isDebug()) console.error('[handleImage]', e);
    }
  }

  function customPrompt(msg, def = "") {
    return new Promise(res => {
      document.getElementById('dialogMsg').innerText = msg;
      document.getElementById('dialogInputArea').style.display="block";
      const i = document.getElementById('dialogInput');
      i.value = def;
      document.getElementById('dialogCancel').style.display="block";
      document.getElementById('dialogModal').style.display="flex";
      document.getElementById('dialogOk').onclick = () => { document.getElementById('dialogModal').style.display="none"; res(i.value); };
      document.getElementById('dialogCancel').onclick = () => { document.getElementById('dialogModal').style.display="none"; res(null); };
    });
  }

  function customConfirm(msg) {
    return new Promise(res => {
      document.getElementById('dialogMsg').innerText = msg;
      document.getElementById('dialogInputArea').style.display="none";
      document.getElementById('dialogCancel').style.display="block";
      document.getElementById('dialogModal').style.display="flex";
      document.getElementById('dialogOk').onclick = () => { document.getElementById('dialogModal').style.display="none"; res(true); };
      document.getElementById('dialogCancel').onclick = () => { document.getElementById('dialogModal').style.display="none"; res(false); };
    });
  }

  async function confirmDeleteHist() {
    if(editingHistIdx === null) return;
    const ok = await customConfirm("ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ");
    if(!ok) return;
    db.products[curBarcode].history.splice(editingHistIdx, 1);
    saveLocalOnly();
    syncFirebasePut();
    showHome();
  }

  // ========= Settings / Sync =========
  async function startMigration() {
    const btn = document.getElementById('syncBtn');
    const urlEl = document.getElementById('fb-url-input');
    const cityEl = document.getElementById('home-city-input');

    const u = (urlEl ? urlEl.value : '').trim();
    const cityInput = (cityEl ? cityEl.value : '').trim();

    if (btn) { btn.disabled = true; btn.innerText = "åŒæœŸä¸­â€¦"; }
    showToast("åŒæœŸã‚’é–‹å§‹â€¦", 3000);
    activeSyncController = new AbortController();

    try {
      db.config.homeCity = cityInput;
      db = normalizeDb(db);
      saveLocalOnly();

      if(!u) {
        showToast("ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜å®Œäº†", 3000);
        closeSettings(); showHome();
        return;
      }

      const targetUrl = getSafeUrl(u);

      // âœ… PUTå‰ã«ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’èª­ã¿ã€ãƒãƒ¼ã‚¸ã—ã¦ã‹ã‚‰é€ã‚‹ï¼ˆç«¯æœ«é–“ã®å–ã‚Šã“ã¼ã—æ¸›ã€ç”»åƒæƒ…å ±ã‚‚ä¿è­·ï¼‰
      try {
        const res0 = await fetchWithTimeout(targetUrl, { signal: activeSyncController.signal }, 9000);
        const cloud0 = await res0.json();
        if (cloud0 && cloud0.products) {
          db = mergeDb(db, cloud0); // âœ… ãƒãƒ¼ã‚¸æ–¹å¼ã§ç”»åƒæƒ…å ±ãŒæ¶ˆãˆãªã„
          saveLocalOnly();
        }
      } catch(e) {
        // èª­ã‚ãªãã¦ã‚‚ç¶šè¡Œ
      }

      // PUTï¼ˆç”»åƒã¯é€ã‚‰ãªã„ï¼‰
      const payload = stripForCloud(db);
      await fetchWithTimeout(targetUrl, {
        method: 'PUT',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
        signal: activeSyncController.signal
      }, 12000);

      // âœ… æˆåŠŸå¾Œï¼šGETã§èª­ã¿ç›´ã—ï¼ˆEdgeã®ç©ºè¡¨ç¤ºå¯¾ç­–ã€ãƒãƒ¼ã‚¸æ–¹å¼ã§ç”»åƒãŒæ¶ˆãˆãªã„ï¼‰
      fbUrl = u; // let ãªã®ã§OK
      localStorage.setItem('smartPriceFirebaseUrl', u);
      await syncFirebase(); // âœ… ãƒãƒ¼ã‚¸æ–¹å¼

      showToast("åŒæœŸæˆåŠŸï¼", 3000);
      closeSettings(); showHome();

    } catch(e) {
      const msg = (e.name === 'AbortError') ? "ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ/ä¸­æ–­" : e.message;
      showToast(`åŒæœŸå¤±æ•—ï¼ˆ${msg}ï¼‰`, 10000);
    } finally {
      activeSyncController = null;
      resetSyncBtn();
    }
  }

  function openSettings() {
  clearToasts();
    try{ clearToasts(); }catch(e){}

    try {
      db = normalizeDb(db);
      resetSyncBtn();
      const modal = document.getElementById('settingsModal');
      if(!modal) { showToast('è¨­å®šç”»é¢ã‚’é–‹ã‘ã¾ã›ã‚“', 8000); return; }
      modal.style.display = 'flex';
      const urlInput = document.getElementById('fb-url-input');
      if(urlInput) urlInput.value = fbUrl;
      const cityInput = document.getElementById('home-city-input');
      if(cityInput) cityInput.value = db.config.homeCity || '';
      renderCityChips();
      
      // âœ… ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ã¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      const backupButtons = document.getElementById('debugBackupButtons');
      if (backupButtons) {
        backupButtons.style.display = isDebug() ? 'block' : 'none';
      }
    } catch(e) {
      showToast('è¨­å®šç”»é¢ã‚¨ãƒ©ãƒ¼', 8000);
    }
  }

  function closeSettings() {
  clearToasts();
    try{ clearToasts(); }catch(e){}

    const modal = document.getElementById('settingsModal');
    if(modal) modal.style.display = 'none';
  }

  function renderCityChips() {
    const chipArea = document.getElementById('city-history-chips');
    if(!chipArea) return;
    chipArea.innerHTML = "";
    db = normalizeDb(db);
    const cities = Array.isArray(db.config.homeCities) ? db.config.homeCities : [];
    cities.forEach(city => {
      if(typeof city !== 'string' || !city.trim()) return;
      const chip = document.createElement('span');
      chip.className = 'city-chip';
      chip.innerText = city;
      chip.onclick = () => {
        const inp = document.getElementById('home-city-input');
        if(inp) inp.value = city;
        showToast(`${city}ã‚’é¸æŠ`, 1500);
      };
      chipArea.appendChild(chip);
    });
  }

  // âœ… P0: ç¾åœ¨ã®locationã«è‡ªå‹•è¿½å¾“ã™ã‚‹URLç”Ÿæˆ
  function buildBaseUrl() {
    let pathname = location.pathname;
    // index.htmlã§çµ‚ã‚ã‚‹å ´åˆã¯ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤–ã™
    if (pathname.endsWith('/index.html') || pathname.endsWith('index.html')) {
      pathname = pathname.replace(/\/?index\.html$/, '');
    }
    // æœ€å¾Œã®ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ï¼ˆãŸã ã—ãƒ«ãƒ¼ãƒˆã®å ´åˆã¯æ®‹ã™ï¼‰
    pathname = pathname.replace(/\/+$/, '') || '/';
    return location.origin + pathname;
  }
  
  function buildUrl(withDebug=false) {
    const base = buildBaseUrl();
    // ç¾åœ¨ã®URLã® ?b= ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã„ã€ãªã‘ã‚Œã° BUILD_ID ã‚’ä½¿ã†
    const currentParams = new URLSearchParams(location.search);
    const buildParam = currentParams.get('b') || BUILD_ID;
    
    // URLã‚’çµ„ã¿ç«‹ã¦
    let url = base;
    if (buildParam) {
      url += `?b=${encodeURIComponent(buildParam)}`;
    }
    
    // ãƒ‡ãƒãƒƒã‚°URLã ã‘ã« &debug=1 ã‚’ä»˜ã‘ã‚‹
    if (withDebug) {
      url += (buildParam ? '&' : '?') + 'debug=1';
    }
    
    return url;
  }

  function openWebModal() {
    const m = document.getElementById('webModal');
    if(!m) return;
    const n = document.getElementById('webUrlNormal');
    const d = document.getElementById('webUrlDebug');
    if(n) n.value = buildUrl(false);
    if(d) d.value = buildUrl(true);
    
    // âœ… PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
    const installBtn = document.getElementById('pwaInstallBtn');
    if (installBtn) {
      if (deferredPrompt) {
        installBtn.style.display = 'block';
      } else {
        installBtn.style.display = 'none';
      }
    }
    
    m.style.display = "flex";
  }
  function closeWebModal() {
    const m = document.getElementById('webModal');
    if(m) m.style.display = "none";
  }
  
  // âœ… PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Ÿè¡Œ
  async function installPWA() {
    if (!deferredPrompt) {
      showToast('ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æº–å‚™ãŒã§ãã¦ã„ã¾ã›ã‚“', 3000);
      return;
    }
    
    try {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      
      if (outcome === 'accepted') {
        showToast('ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸï¼', 3000);
      } else {
        showToast('ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ', 3000);
      }
      
      deferredPrompt = null;
      const installBtn = document.getElementById('pwaInstallBtn');
      if (installBtn) {
        installBtn.style.display = 'none';
      }
    } catch(e) {
      if (isDebug()) console.error('[PWA] Install failed:', e);
      showToast('ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ', 3000);
    }
  }
  async function copyUrl(id) {
    const el = document.getElementById(id);
    if(!el) return;
    const text = el.value || "";
    try {
      await navigator.clipboard.writeText(text);
      showToast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ", 2000);
    } catch(e) {
      el.focus(); el.select();
      try { document.execCommand('copy'); showToast("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ", 2000); }
      catch(e2) { showToast("ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸ", 8000); }
    }
  }
  function openUrlFromBox(id) {
    const el = document.getElementById(id);
    if(!el) return;
    const text = el.value || "";
    window.open(text, "_blank", "noopener");
  }

  // ========= ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ï¼ˆ&debug=1æ™‚ã®ã¿ï¼‰ =========
  
  // âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‡ºåŠ›ï¼ˆãƒ‡ãƒ¼ã‚¿ï¼‹ç”»åƒã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ï¼‰
  async function exportBackup() {
    if (!isDebug()) return;
    
    try {
      showToast("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‡ºåŠ›ä¸­â€¦", 3000);
      
      // 1. ãƒ‡ãƒ¼ã‚¿ï¼ˆlocalStorageï¼‰ã‚’å–å¾—
      const dataStr = localStorage.getItem('smart_price_db');
      if (!dataStr) {
        showToast("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“", 5000);
        return;
      }
      const data = JSON.parse(dataStr);
      
      // 2. ç”»åƒï¼ˆIndexedDBï¼‰ã‚’å–å¾—
      const dbi = await openImgDb();
      const images = {};
      if (dbi && dbi.objectStoreNames.contains(IMG_STORE)) {
        const tx = dbi.transaction(IMG_STORE, "readonly");
        const store = tx.objectStore(IMG_STORE);
        const keys = await new Promise((resolve) => {
          const req = store.getAllKeys();
          req.onsuccess = () => resolve(req.result || []);
          req.onerror = () => resolve([]);
        });
        
        for (const key of keys) {
          const blob = await idbGet(key);
          if (blob) {
            // Blobã‚’base64ã«å¤‰æ›
            const dataUrl = await new Promise((resolve, reject) => {
              const fr = new FileReader();
              fr.onload = () => resolve(fr.result);
              fr.onerror = () => reject(new Error('ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—'));
              fr.readAsDataURL(blob);
            });
            images[key] = dataUrl;
          }
        }
      }
      
      // 3. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
      const backup = {
        version: APP_VERSION,
        buildId: BUILD_ID,
        exportDate: new Date().toISOString(),
        data: data,
        images: images
      };
      
      // 4. ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      const jsonStr = JSON.stringify(backup, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `smart_price_backup_${new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showToast("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‡ºåŠ›å®Œäº†", 3000);
      if (isDebug()) {
        console.log('[Backup] Exported:', Object.keys(backup.data.products || {}).length, 'products,', Object.keys(backup.images).length, 'images');
      }
    } catch(e) {
      showToast(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‡ºåŠ›å¤±æ•—: ${e.message}`, 8000);
      if (isDebug()) console.error('[Backup] Export failed:', e);
    }
  }
  
  // âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—èª­ã¿è¾¼ã¿ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒï¼‰
  async function importBackup() {
    if (!isDebug()) return;
    
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'application/json,.json';
    input.onchange = async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      
      try {
        showToast("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—èª­ã¿è¾¼ã¿ä¸­â€¦", 3000);
        
        // 1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
        const text = await file.text();
        const backup = JSON.parse(text);
        
        if (!backup.data || typeof backup.data !== 'object') {
          throw new Error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãŒç„¡åŠ¹ã§ã™');
        }
        
        // 2. ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒï¼ˆlocalStorageï¼‰
        localStorage.setItem('smart_price_db', JSON.stringify(backup.data));
        db = normalizeDb(backup.data);
        
        // 3. ç”»åƒã‚’å¾©å…ƒï¼ˆIndexedDBï¼‰
        if (backup.images && typeof backup.images === 'object') {
          const dbi = await openImgDb();
          if (dbi && dbi.objectStoreNames.contains(IMG_STORE)) {
            let restored = 0;
            for (const [key, dataUrl] of Object.entries(backup.images)) {
              if (typeof dataUrl === 'string' && dataUrl.startsWith('data:')) {
                const blob = dataURLtoBlob(dataUrl);
                if (blob) {
                  const ok = await idbPut(key, blob);
                  if (ok) restored++;
                }
              }
            }
            if (isDebug()) {
              console.log('[Backup] Restored:', restored, 'images');
            }
          }
        }
        
        // 4. UIæ›´æ–°
        initCategorySelect();
        renderStoreList();
        await renderHistory();
        
        showToast("ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—èª­ã¿è¾¼ã¿å®Œäº†", 3000);
        if (isDebug()) {
          console.log('[Backup] Imported:', Object.keys(backup.data.products || {}).length, 'products');
        }
      } catch(e) {
        showToast(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—èª­ã¿è¾¼ã¿å¤±æ•—: ${e.message}`, 8000);
        if (isDebug()) console.error('[Backup] Import failed:', e);
      }
    };
    input.click();
  }

  // ========= P1: åˆæœŸåŒ–å‡¦ç†ï¼ˆæ‹›å¾…ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šï¼†ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ =========
  (function initializeUserProfile() {
    try {
      // 1. æ—¢å­˜ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
      let profile = getUserProfile();

      // 2. ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦ä½œæˆ
      if (!profile) {
        profile = {
          uid: generateUid(),
          areaId: null,
          invitedBy: null,
          createdAt: new Date().toISOString()
        };
        setUserProfile(profile);
        if (isDebug()) {
          console.log('[UserProfile] Created new profile:', profile);
        }
      }

      // 3. URLã‹ã‚‰æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Š
      const inviteCode = parseInviteCode();
      if (inviteCode) {
        // æ‹›å¾…ã‚³ãƒ¼ãƒ‰ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€areaIdã¨invitedByã‚’æ›´æ–°
        // ç°¡æ˜“å®Ÿè£…: æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã‚’ãã®ã¾ã¾areaIdã¨ã—ã¦ä½¿ç”¨
        // æœ¬æ ¼å®Ÿè£…ã§ã¯ã€ã‚µãƒ¼ãƒãƒ¼APIã§æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã‚’æ¤œè¨¼ã—ã¦areaIdã‚’å–å¾—ã™ã‚‹
        if (!profile.areaId) {
          profile.areaId = `area_${inviteCode}`;
          profile.invitedBy = inviteCode; // ç°¡æ˜“å®Ÿè£…ï¼ˆæœ¬æ¥ã¯æ‹›å¾…è€…ã®UIDã‚’å–å¾—ï¼‰
          profile.invitedAt = new Date().toISOString();
          setUserProfile(profile);

          if (isDebug()) {
            showToast(`[æ‹›å¾…] ã‚¨ãƒªã‚¢ã«å‚åŠ : ${profile.areaId}`, 5000);
            console.log('[UserProfile] Invited to area:', profile);
          } else {
            showToast(`ã‚¨ãƒªã‚¢ã«å‚åŠ ã—ã¾ã—ãŸ`, 3000);
          }
        }
      }

      // 4. ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’è¡¨ç¤º
      if (isDebug()) {
        console.log('[UserProfile] Current profile:', profile);
        showToast(`[DEBUG] UID: ${profile.uid}\nArea: ${profile.areaId || 'æœªè¨­å®š'}`, 4000);
      }

    } catch(e) {
      if (isDebug()) {
        console.error('[UserProfile] Initialization failed:', e);
      }
    }
  })();
</script>
<script>
// Service Worker æš«å®šç„¡åŠ¹åŒ–ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ±šæŸ“å¯¾ç­–ï¼‰
if (false && "serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js", { scope: "./" }).catch(()=>{});
  });
}
// æ—¢å­˜ã®Service Workerã‚’è§£é™¤ï¼ˆPCçœŸã£é»’å¯¾ç­–ï¼‰
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.getRegistrations().then(function(registrations) {
    for(let registration of registrations) {
      registration.unregister();
    }
  });
}
</script>

<script>
/* === Smart Price Settings Unified Patch (v19.9.45 / 2026-02-07_2000_sw-reset) === */
(function () {
  "use strict";

  // --- Helpers ---
  function spParams() { return new URLSearchParams(location.search); }
  function spIsAdminMode() {
    const p = spParams();
    return p.get('mode') === 'admin';
  }
  function spIsDebug() {
    const p = spParams();
    return p.has('debug');
  }
  function spNowISO() {
    const d = new Date();
    const pad = (n) => String(n).padStart(2,'0');
    return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) + ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds());
  }
  function spSafeText(s) {
    return (s == null) ? '' : String(s);
  }

  // Copy by element id
  window.spCopy = async function(id) {
    try {
      const el = document.getElementById(id);
      if (!el) return;
      const text = ('value' in el) ? el.value : el.textContent;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
        if (typeof showToast === 'function') showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 1200);
      } else {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        if (typeof showToast === 'function') showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 1200);
      }
    } catch (e) {
      console.warn('[spCopy] failed', e);
      if (typeof showToast === 'function') showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 2000);
    }
  };

  // --- Referral / Family share ---
  const LS_MY_REF = 'sp_ref_my';
  const LS_REF_FROM = 'sp_ref_from';
  const LS_FAMILY = 'sp_family_code';

  function spGenId() {
    // 6 chars (base36)
    return Math.random().toString(36).slice(2, 8).toUpperCase();
  }

  function spGetOrCreateMyRef() {
    let v = localStorage.getItem(LS_MY_REF);
    if (!v) {
      v = spGenId();
      localStorage.setItem(LS_MY_REF, v);
    }
    return v;
  }

  function spSaveFamily(code) {
    const v = (code || '').trim();
    if (v) localStorage.setItem(LS_FAMILY, v);
    else localStorage.removeItem(LS_FAMILY);
    return v;
  }

  function spBuildReferralLink(myId) {
    const url = new URL(location.href);
    // keep build param for cache busting, but remove debug/mode to avoid leaking
    url.searchParams.set('ref', myId);
    url.searchParams.delete('debug');
    url.searchParams.delete('mode');
    // ensure b exists
    if (!url.searchParams.get('b')) url.searchParams.set('b', '2026-02-07_2000_sw-reset');
    return url.toString();
  }

  window.spSaveFamilyCode = function() {
    const input = document.getElementById('family-code-input');
    const status = document.getElementById('family-code-status');
    if (!input) return;
    const saved = spSaveFamily(input.value);
    if (status) status.textContent = saved ? ('ä¿å­˜ã—ã¾ã—ãŸï¼š' + saved) : 'æœªè¨­å®š';
    if (typeof showToast === 'function') showToast('å®¶æ—å…±æœ‰ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 1500);
  };

  window.spShareReferral = async function() {
    try {
      const myId = spGetOrCreateMyRef();
      const link = spBuildReferralLink(myId);
      if (navigator.share) {
        await navigator.share({ title: 'Smart Price ç´¹ä»‹ãƒªãƒ³ã‚¯', text: 'Smart Price ã®ç´¹ä»‹ãƒªãƒ³ã‚¯ã§ã™ã€‚', url: link });
      } else {
        await window.spCopy('ref-link');
      }
    } catch (e) {
      console.warn('[spShareReferral] failed', e);
      try { await window.spCopy('ref-link'); } catch(_e) {}
    }
  };

  function spHandleRefParam() {
    const p = spParams();
    const ref = p.get('ref');
    const my = spGetOrCreateMyRef();
    if (ref && ref !== my) {
      localStorage.setItem(LS_REF_FROM, ref);
    }
  }

  // --- Support / Inquiry ---
  const LS_SUPPORT = 'sp_support_logs_v1'; // max 50
  const MAX_SUPPORT = 50;

  function spUAInfo() {
    const ua = navigator.userAgent || '';
    const plat = navigator.platform || '';
    return { ua, plat };
  }

  function spDetectBrowser() {
    const ua = (navigator.userAgent || '').toLowerCase();
    if (ua.includes('edg/')) return 'Edge';
    if (ua.includes('chrome/')) return 'Chrome';
    if (ua.includes('safari/') && !ua.includes('chrome/')) return 'Safari';
    if (ua.includes('firefox/')) return 'Firefox';
    return 'Browser';
  }

  function spDefaultDevice() {
    // coarse default; user can edit
    const ua = navigator.userAgent || '';
    if (/android/i.test(ua)) return 'Androidç«¯æœ«';
    if (/iphone|ipad|ipod/i.test(ua)) return 'iPhone/iPad';
    if (/windows/i.test(ua)) return 'Windows PC';
    if (/macintosh/i.test(ua)) return 'Mac';
    return 'ç«¯æœ«';
  }

  function spDefaultOS() {
    const ua = navigator.userAgent || '';
    if (/android\s([0-9\.]+)/i.test(ua)) return 'Android ' + (ua.match(/android\s([0-9\.]+)/i)||[])[1];
    if (/iphone os\s([0-9_]+)/i.test(ua)) return 'iOS ' + ((ua.match(/iphone os\s([0-9_]+)/i)||[])[1]||'').replace(/_/g,'.');
    if (/windows nt\s([0-9\.]+)/i.test(ua)) return 'Windows ' + (ua.match(/windows nt\s([0-9\.]+)/i)||[])[1];
    if (/mac os x\s([0-9_]+)/i.test(ua)) return 'macOS ' + ((ua.match(/mac os x\s([0-9_]+)/i)||[])[1]||'').replace(/_/g,'.');
    return 'OS';
  }

  let _supportFiles = [];

  function spRenderSupportPreview() {
    const wrap = document.getElementById('support-preview');
    if (!wrap) return;
    wrap.innerHTML = '';
    _supportFiles.forEach((f, idx) => {
      const box = document.createElement('div');
      box.style.position = 'relative';
      const img = document.createElement('img');
      img.src = f.dataUrl;
      img.style.width = '88px';
      img.style.height = '88px';
      img.style.objectFit = 'cover';
      img.style.borderRadius = '10px';
      img.style.border = '1px solid rgba(255,255,255,.12)';
      const btn = document.createElement('button');
      btn.textContent = 'Ã—';
      btn.className = 'btn btn-dark';
      btn.style.position = 'absolute';
      btn.style.top = '-10px';
      btn.style.right = '-10px';
      btn.style.width = '28px';
      btn.style.height = '28px';
      btn.style.borderRadius = '999px';
      btn.style.padding = '0';
      btn.style.lineHeight = '1';
      btn.onclick = () => {
        _supportFiles.splice(idx,1);
        spRenderSupportPreview();
      };
      box.appendChild(img);
      box.appendChild(btn);
      wrap.appendChild(box);
    });
  }

  async function spFileToDataUrl(file, maxW=900, maxH=900) {
    const dataUrl = await new Promise((res, rej) => {
      const fr = new FileReader();
      fr.onload = () => res(fr.result);
      fr.onerror = rej;
      fr.readAsDataURL(file);
    });
    // downscale using canvas
    const img = await new Promise((res, rej) => {
      const i = new Image();
      i.onload = () => res(i);
      i.onerror = rej;
      i.src = dataUrl;
    });
    const w0 = img.width || 1, h0 = img.height || 1;
    const scale = Math.min(1, maxW / w0, maxH / h0);
    const w = Math.max(1, Math.round(w0 * scale));
    const h = Math.max(1, Math.round(h0 * scale));
    const canvas = document.createElement('canvas');
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, w, h);
    // jpeg to reduce size
    return canvas.toDataURL('image/jpeg', 0.82);
  }

  function spLoadSupportLogs() {
    try {
      const raw = localStorage.getItem(LS_SUPPORT);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    } catch(e) {
      return [];
    }
  }

  function spSaveSupportLogs(arr) {
    try {
      localStorage.setItem(LS_SUPPORT, JSON.stringify(arr.slice(0, MAX_SUPPORT)));
    } catch(e) {
      console.warn('[spSaveSupportLogs] failed', e);
    }
  }

  function spCollectSupportText() {
    const symptom = spSafeText(document.getElementById('support-symptom')?.value).trim();
    const device = spSafeText(document.getElementById('support-device')?.value).trim();
    const os = spSafeText(document.getElementById('support-os')?.value).trim();
    const browser = spSafeText(document.getElementById('support-browser')?.value).trim();
    const myRef = spGetOrCreateMyRef();
    const refFrom = localStorage.getItem(LS_REF_FROM) || '';
    const family = localStorage.getItem(LS_FAMILY) || '';
    const url = location.href;
    const version = window.FULL_VERSION || window.VERSION_INFO || window.APP_VERSION || '';
    const build = window.BUILD_ID || '2026-02-07_2000_sw-reset';
    const ua = spUAInfo();

    const lines = [];
    lines.push('ã€Smart Price ãŠå•ã„åˆã‚ã›ã€‘');
    lines.push('æ—¥æ™‚: ' + spNowISO());
    lines.push('VERSION: ' + version);
    lines.push('BUILD: ' + build);
    if (myRef) lines.push('ç´¹ä»‹ID: ' + myRef);
    if (refFrom) lines.push('ç´¹ä»‹å…ƒ(ref): ' + refFrom);
    if (family) lines.push('å®¶æ—å…±æœ‰ã‚³ãƒ¼ãƒ‰: ' + family);
    lines.push('URL: ' + url);
    lines.push('æ©Ÿç¨®: ' + (device || 'æœªå…¥åŠ›'));
    lines.push('OS: ' + (os || 'æœªå…¥åŠ›'));
    lines.push('ãƒ–ãƒ©ã‚¦ã‚¶: ' + (browser || 'æœªå…¥åŠ›'));
    lines.push('UA: ' + ua.ua);
    lines.push('');
    lines.push('ç—‡çŠ¶:');
    lines.push(symptom || 'ï¼ˆæœªå…¥åŠ›ï¼‰');
    lines.push('');
    lines.push('ã‚¹ã‚¯ã‚·ãƒ§: ' + (_supportFiles.length ? (_supportFiles.length + 'æšï¼ˆã“ã®ç”»é¢ã§é¸æŠï¼‰') : 'ãªã—'));
    return lines.join('\n');
  }

  window.spCopySupport = async function() {
    const text = spCollectSupportText();
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
        if (typeof showToast === 'function') showToast('å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 1500);
      } else {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        if (typeof showToast === 'function') showToast('å†…å®¹ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 1500);
      }
    } catch(e) {
      console.warn('[spCopySupport] failed', e);
      if (typeof showToast === 'function') showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ', 2000);
    }
  };

  window.spSaveSupport = function() {
    const entry = {
      ts: Date.now(),
      text: spCollectSupportText(),
      symptom: spSafeText(document.getElementById('support-symptom')?.value).trim().slice(0, 120),
      files: _supportFiles.map(f => ({ name: f.name, dataUrl: f.dataUrl })).slice(0, 3),
    };
    const logs = spLoadSupportLogs();
    logs.unshift(entry);
    spSaveSupportLogs(logs);
    if (typeof showToast === 'function') showToast('ä¿å­˜ã—ã¾ã—ãŸï¼ˆé‹å–¶è€…ãƒ¢ãƒ¼ãƒ‰ã§ç¢ºèªã§ãã¾ã™ï¼‰', 1800);
    // clear symptom only
    const sym = document.getElementById('support-symptom');
    if (sym) sym.value = '';
    _supportFiles = [];
    spRenderSupportPreview();
    // refresh admin list if visible
    spRenderAdminSupportList();
  };

  function spBindSupportFiles() {
    const inp = document.getElementById('support-screens');
    if (!inp || inp.dataset.bound === '1') return;
    inp.dataset.bound = '1';
    inp.addEventListener('change', async () => {
      try {
        const files = Array.from(inp.files || []);
        // keep up to 3 images
        const take = files.slice(0, 3);
        _supportFiles = [];
        for (const f of take) {
          const dataUrl = await spFileToDataUrl(f);
          _supportFiles.push({ name: f.name, dataUrl });
        }
        spRenderSupportPreview();
      } catch(e) {
        console.warn('[support files] failed', e);
        if (typeof showToast === 'function') showToast('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 2000);
      }
    });
  }

  // --- Admin: Support history ---
  function spRenderAdminSupportList() {
    const wrap = document.getElementById('admin-support-list');
    if (!wrap) return;
    const logs = spLoadSupportLogs();
    if (!logs.length) {
      wrap.innerHTML = '<div class="hint">ä¿å­˜ã•ã‚ŒãŸãŠå•ã„åˆã‚ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
      return;
    }
    wrap.innerHTML = '';
    logs.slice(0, 50).forEach((e, i) => {
      const row = document.createElement('div');
      row.className = 'p-2 mb-2';
      row.style.border = '1px solid rgba(255,255,255,.08)';
      row.style.borderRadius = '12px';
      row.style.background = 'rgba(255,255,255,.02)';
      const dt = new Date(e.ts);
      const title = spSafeText(e.symptom || '').trim() || 'ï¼ˆå†…å®¹æœªå…¥åŠ›ï¼‰';
      row.innerHTML = `
        <div class="small text-secondary mb-1">${dt.toLocaleString()}</div>
        <div class="text-white small mb-2">${title}</div>
        <div class="d-flex gap-2">
          <button class="btn btn-dark btn-sm flex-grow-1" data-i="${i}">ã‚³ãƒ”ãƒ¼</button>
          <button class="btn btn-outline-secondary btn-sm flex-grow-1" data-d="${i}">è©³ç´°</button>
        </div>
        <div class="small text-secondary mt-2" style="display:none;" id="support-detail-${i}"></div>
      `;
      wrap.appendChild(row);
      row.querySelector('button[data-i]')?.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(e.text || '');
          if (typeof showToast === 'function') showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', 1200);
        } catch(_e) {
          window.spCopy('selfcheck-log'); // fallback noop
        }
      });
      row.querySelector('button[data-d]')?.addEventListener('click', () => {
        const d = row.querySelector('#support-detail-' + i);
        if (!d) return;
        if (d.style.display === 'none') {
          const files = (e.files || []).map(f => f.name).join(', ');
          d.textContent = (e.text || '') + (files ? ('\n\næ·»ä»˜: ' + files) : '');
          d.style.whiteSpace = 'pre-wrap';
          d.style.display = 'block';
        } else {
          d.style.display = 'none';
        }
      });
    });
  }

  // --- Admin: Unconfirmed products (yesterday) ---
  function spYesterdayRange() {
    const now = new Date();
    const y = new Date(now);
    y.setDate(now.getDate() - 1);
    const start = new Date(y.getFullYear(), y.getMonth(), y.getDate(), 0, 0, 0, 0).getTime();
    const end = new Date(y.getFullYear(), y.getMonth(), y.getDate(), 23, 59, 59, 999).getTime();
    return { start, end };
  }

  function spGetProductLastTs(p) {
    try {
      if (p && Array.isArray(p.history) && p.history.length) {
        const last = p.history[p.history.length - 1];
        const ts = last?.t || last?.ts || last?.time || last?.date;
        if (typeof ts === 'number') return ts;
        if (typeof ts === 'string') {
          const n = Date.parse(ts);
          return isNaN(n) ? 0 : n;
        }
      }
      if (typeof p?.updatedAt === 'number') return p.updatedAt;
      if (typeof p?.createdAt === 'number') return p.createdAt;
    } catch(e) {}
    return 0;
  }

  function spIsUnconfirmed(p) {
    const name = spSafeText(p?.name).trim();
    const maker = spSafeText(p?.maker).trim() || spSafeText(p?.manufacturer).trim();
    const brand = spSafeText(p?.brand).trim();
    const hasImg = !!(p?.imageKey || p?.imageUrl || p?.img || p?.image);
    // æœªç¢ºå®š: åå‰ or ãƒ¡ãƒ¼ã‚«ãƒ¼æ¬ è½ or ç”»åƒæ¬ è½
    return (!name || !maker || !hasImg);
  }

  function spRenderUnconfirmedList() {
    const wrap = document.getElementById('admin-unconfirmed-list');
    if (!wrap) return;
    if (!window.db || !db.products) {
      wrap.innerHTML = '<div class="hint">DBãŒæœªåˆæœŸåŒ–ã§ã™ã€‚</div>';
      return;
    }
    const r = spYesterdayRange();
    const codes = Object.keys(db.products || {});
    const targets = [];
    for (const code of codes) {
      const p = db.products[code];
      if (!p) continue;
      const ts = spGetProductLastTs(p);
      if (ts >= r.start && ts <= r.end && spIsUnconfirmed(p)) {
        targets.push({ code, p });
      }
    }
    if (!targets.length) {
      wrap.innerHTML = '<div class="hint">æ˜¨æ—¥åˆ†ã®æœªç¢ºå®šå•†å“ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
      return;
    }

    wrap.innerHTML = '';
    targets.slice(0, 50).forEach(({
      code, p
    }) => {
      const box = document.createElement('div');
      box.className = 'p-2 mb-2';
      box.style.border = '1px solid rgba(255,255,255,.08)';
      box.style.borderRadius = '12px';
      box.style.background = 'rgba(255,255,255,.02)';
      const name = spSafeText(p.name).trim();
      const maker = spSafeText(p.maker || p.manufacturer).trim();
      const brand = spSafeText(p.brand).trim();
      box.innerHTML = `
        <div class="small text-secondary mb-1">JAN: <b class="text-white">${code}</b></div>
        <div class="mb-2">
          <input class="form-control bg-dark text-white border-secondary mb-2" data-f="name" data-code="${code}" placeholder="å•†å“å" value="${name.replace(/"/g,'&quot;')}">
          <input class="form-control bg-dark text-white border-secondary mb-2" data-f="maker" data-code="${code}" placeholder="ãƒ¡ãƒ¼ã‚«ãƒ¼" value="${maker.replace(/"/g,'&quot;')}">
          <input class="form-control bg-dark text-white border-secondary" data-f="brand" data-code="${code}" placeholder="ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ˆä»»æ„ï¼‰" value="${brand.replace(/"/g,'&quot;')}">
        </div>
      `;
      wrap.appendChild(box);
    });
  }

  window.spConfirmUnconfirmedAll = function() {
    try {
      if (!window.db || !db.products) return;
      const inputs = document.querySelectorAll('#admin-unconfirmed-list [data-code][data-f]');
      const updates = {};
      inputs.forEach(inp => {
        const code = inp.getAttribute('data-code');
        const f = inp.getAttribute('data-f');
        if (!updates[code]) updates[code] = {};
        updates[code][f] = (inp.value || '').trim();
      });
      let changed = 0;
      Object.keys(updates).forEach(code => {
        const p = db.products[code];
        if (!p) return;
        const u = updates[code];
        if (u.name) p.name = u.name;
        if (u.maker) {
          p.maker = u.maker;
          p.manufacturer = u.maker;
        }
        if (u.brand) p.brand = u.brand;
        // æœ€çµ‚æ›´æ–°ã‚’æŠ¼ã—è¾¼ã‚€
        p.updatedAt = Date.now();
        changed++;
      });
      if (typeof saveLocalOnly === 'function') saveLocalOnly();
      else if (typeof saveLocal === 'function') saveLocal();
      spRenderUnconfirmedList();
      if (typeof showToast === 'function') showToast('ç¢ºå®šã—ã¾ã—ãŸï¼ˆ' + changed + 'ä»¶ï¼‰', 1800);
    } catch (e) {
      console.warn('[spConfirmUnconfirmedAll] failed', e);
      if (typeof showToast === 'function') showToast('ç¢ºå®šã«å¤±æ•—ã—ã¾ã—ãŸ', 2000);
    }
  };

  // --- Self check ---
  window.spRunSelfCheck = function() {
    const log = [];
    try {
      log.push('SELF CHECK (' + spNowISO() + ')');
      log.push('VERSION: ' + (window.FULL_VERSION || window.VERSION_INFO || window.APP_VERSION || ''));
      log.push('BUILD: ' + (window.BUILD_ID || '2026-02-07_2000_sw-reset'));
      log.push('MODE: ' + (spIsAdminMode() ? 'admin' : 'normal') + (spIsDebug() ? ' / debug' : ''));
      log.push('');
      // Config
      log.push('[config]');
      log.push('SP_CONFIG.loaded: ' + (!!window.SP_CONFIG && Object.keys(window.SP_CONFIG||{}).length));
      log.push('firebaseUrl(var): ' + (typeof fbUrl === 'string' ? 'OK' : 'NG'));
      log.push('yahooProxyExecUrl: ' + (window.SP_CONFIG?.yahooProxyExecUrl ? 'OK' : 'NG'));
      log.push('');
      // Functions
      const fn = (name) => (typeof window[name] === 'function');
      const must = ['processBarcodeData','lookupYahooByJan','lookupRakutenByJan','startMigration','openSettings','showToast'];
      log.push('[functions]');
      must.forEach(n => log.push(n + ': ' + (fn(n) ? 'OK' : 'NG')));
      log.push('');
      log.push('localStorage keys:');
      log.push('ref_my=' + (localStorage.getItem(LS_MY_REF)||''));
      log.push('ref_from=' + (localStorage.getItem(LS_REF_FROM)||''));
      log.push('family=' + (localStorage.getItem(LS_FAMILY)||''));
    } catch(e) {
      log.push('ERROR: ' + e.message);
    }
    const ta = document.getElementById('selfcheck-log');
    if (ta) ta.value = log.join('\n');
    if (typeof showToast === 'function') showToast('æ¤œè¨¼ãƒ­ã‚°ã‚’ä½œæˆã—ã¾ã—ãŸ', 1500);
  };

  // --- Settings UI wiring ---
  function spSetupSettingsUnified() {
    // Referral UI
    const myId = spGetOrCreateMyRef();
    const refMy = document.getElementById('ref-my-id');
    const refLink = document.getElementById('ref-link');
    if (refMy) refMy.value = myId;
    if (refLink) refLink.value = spBuildReferralLink(myId);

    const fam = localStorage.getItem(LS_FAMILY) || '';
    const famIn = document.getElementById('family-code-input');
    const famSt = document.getElementById('family-code-status');
    if (famIn && famIn.value !== fam) famIn.value = fam;
    if (famSt) famSt.textContent = fam ? ('ä¿å­˜æ¸ˆã¿ï¼š' + fam) : 'æœªè¨­å®š';

    const from = localStorage.getItem(LS_REF_FROM) || '';
    const fromSt = document.getElementById('ref-from-status');
    if (fromSt) fromSt.textContent = from ? ('ç´¹ä»‹å…ƒ(ref): ' + from) : '';

    // Support defaults
    const dev = document.getElementById('support-device');
    const os = document.getElementById('support-os');
    const br = document.getElementById('support-browser');
    if (dev && !dev.value) dev.value = spDefaultDevice();
    if (os && !os.value) os.value = spDefaultOS();
    if (br && !br.value) br.value = spDetectBrowser();

    spBindSupportFiles();

    // Operator menu gating
    const enabled = document.getElementById('operatorEnabled');
    if (enabled) enabled.style.display = spIsAdminMode() ? 'block' : 'none';

    // Firebase URL protection: show only in operator section (readonly)
    const fb = document.getElementById('fb-url-input');
    if (fb) {
      fb.readOnly = true;
      fb.value = spIsAdminMode() ? (typeof fbUrl === 'string' ? fbUrl : '') : '';
    }

    if (spIsAdminMode()) {
      spRenderUnconfirmedList();
      spRenderAdminSupportList();
    }
  }

  // Patch openSettings so every time it opens, we refresh our sections
  const _origOpenSettings = window.openSettings;
  window.openSettings = function() {
    try {
      if (typeof _origOpenSettings === 'function') _origOpenSettings();
    } catch(e) {
      console.warn('[openSettings] orig failed', e);
    }
    try {
      spSetupSettingsUnified();
    } catch(e) {
      console.warn('[spSetupSettingsUnified] failed', e);
    }
  };

  // Fix debugLog: avoid wrong showToast signature usage (keeps app alive)
  if (typeof window.debugLog === 'function') {
    window.debugLog = function(message, type) {
      if (!spIsDebug()) return;
      try {
        showToast(String(message), 10000);
        console.log('[DEBUG]', type || 'log', message);
      } catch(e) {
        console.log('[DEBUG]', type || 'log', message);
      }
    };
  }

  // Ensure default toast life: normal 5 sec, debug 10 sec (if showToast supports default ms)
  // (This file's showToast already decides internally; we leave behavior unless ms omitted.)

  // Apply once on load
  spHandleRefParam();
  // In case settings already open at load
  document.addEventListener('DOMContentLoaded', () => {
    try { spSetupSettingsUnified(); } catch(e) {}
  });
})();
</script>

<!-- âœ… DEBUG PANEL v4 (bodyçµ‚äº†ç›´å‰ã«é…ç½®) -->
<script>
(function () {
  const params = new URLSearchParams(location.search);
  if (!params.has('debug')) return;

  // DOMãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«å®Ÿè¡Œ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDebugPanel);
  } else {
    // ã™ã§ã«DOMãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯å³å®Ÿè¡Œ
    initDebugPanel();
  }

  function initDebugPanel() {
    // ãƒ‡ãƒãƒƒã‚°ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³
    const toggleBtn = document.createElement('div');
    toggleBtn.id = 'debug-toggle-btn';
    toggleBtn.className = 'show';
    toggleBtn.title = 'ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«ã‚’é–‹ã';
    toggleBtn.innerHTML = '<i class="bi bi-bug-fill"></i>';

    // ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«
    const panel = document.createElement('div');
    panel.id = 'debug-panel';
    panel.innerHTML = `
      <div id="debug-panel-header">
        <div id="debug-panel-title">ğŸ› DEBUG PANEL - ${window.VERSION_INFO || 'v19.9.45'}</div>
        <button id="debug-panel-close">Ã—</button>
      </div>
      <div id="debug-panel-content"></div>
    `;

    document.body.appendChild(toggleBtn);
    document.body.appendChild(panel);

    const content = panel.querySelector('#debug-panel-content');

    const log = (k, v) => {
      const div = document.createElement('div');
      div.innerHTML = `<b>${k}</b>: ${String(v)}`;
      content.appendChild(div);
    };

    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’åé›†
    log('TIME', new Date().toISOString());
    log('URL', location.href);
    log('PATH', location.pathname);
    log('BUILD', params.get('b') || window.BUILD_ID || '(none)');
    log('VERSION', window.VERSION_INFO || window.APP_VERSION || 'v19.9.45');
    log('TITLE', document.title || '(empty)');
    log('USER_AGENT', navigator.userAgent.substring(0, 80) + '...');

    // Service WorkerçŠ¶æ…‹
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(rs => {
        log('SW', rs.length ? `${rs.length} REGISTERED (UNREGISTERING)` : 'NONE');
        rs.forEach(r => r.unregister());
      }).catch(e => log('SW', 'ERROR ' + e.message));
    } else {
      log('SW', 'NOT SUPPORTED');
    }

    // localStorageæƒ…å ±
    try {
      const dbStr = localStorage.getItem('smart_price_db');
      if (dbStr) {
        const db = JSON.parse(dbStr);
        log('DB_PRODUCTS', Object.keys(db.products || {}).length);
        log('DB_STORES', Object.keys(db.stores || {}).length);
      } else {
        log('DB', 'EMPTY');
      }
    } catch (e) {
      log('DB', 'ERROR: ' + e.message);
    }

    // config.json resolver
    const isBook = location.pathname.includes('/Smart-Price-Book/');
    const isDev = location.pathname.includes('/dev/');
    const isEmergency = location.pathname.includes('/emergency/');

    const fetchOnce = (url, tag) =>
      fetch(url, { cache: 'no-store' }).then(r => {
        log(tag, r.ok ? ('OK ' + url) : ('FAIL ' + r.status + ' ' + url));
        return r.ok;
      }).catch(e => {
        log(tag, 'ERROR ' + e.message + ' ' + url);
        return false;
      });

    if (!isBook) {
      log('CONFIG_URL', './config.json');
      fetchOnce('./config.json', 'CONFIG_FETCH');
    } else if (isDev || isEmergency) {
      log('CONFIG_URL', './config.json');
      fetchOnce('./config.json', 'CONFIG_FETCH');
    } else {
      log('CONFIG_URL', './config.json â†’ ./dev/config.json (fallback)');
      fetchOnce('./config.json', 'CONFIG_1ST').then(ok => {
        if (ok) {
          log('CONFIG_FINAL', './config.json');
          return;
        }
        fetchOnce('./dev/config.json', 'CONFIG_2ND').then(() => {
          log('CONFIG_FINAL', './dev/config.json');
        });
      });
    }

    // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    window.addEventListener('error', e => log('ERROR', e.message));
    window.addEventListener('unhandledrejection', e => log('PROMISE_REJECT', e.reason));

    log('STATUS', 'JS RUNNING âœ“');

    // ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    toggleBtn.addEventListener('click', () => {
      if (panel.classList.contains('show')) {
        panel.classList.remove('show');
        console.log('[DEBUG] ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã¾ã—ãŸ');
      } else {
        panel.classList.add('show');
        console.log('[DEBUG] ãƒ‘ãƒãƒ«ã‚’é–‹ãã¾ã—ãŸ');
      }
    });

    // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    const closeBtn = panel.querySelector('#debug-panel-close');
    closeBtn.addEventListener('click', () => {
      panel.classList.remove('show');
      console.log('[DEBUG] ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã¾ã—ãŸ');
    });

    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    console.log('[DEBUG] ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã§ã™ã€‚å³ä¸‹ã®ãƒœã‚¿ãƒ³ã§ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤ºã§ãã¾ã™ã€‚');
    console.log('[DEBUG] VERSION:', window.VERSION_INFO || window.APP_VERSION, '| BUILD:', window.BUILD_ID);
  }
})();
</script>
<!-- /DEBUG PANEL v4 -->


  <!-- âœ… BUILD/VERSION MISMATCH DETECTOR (debug=1 only) -->
  <script>
  (function() {
    try {
      window.addEventListener('load', function() {
        var params = new URLSearchParams(location.search);
        var urlBuild = params.get('b');
        var buildId = window.BUILD_ID || '';
        if (urlBuild && buildId && urlBuild !== buildId) {
          try {
            console.warn('[BUILD MISMATCH] url b=', urlBuild, ' actual=', buildId);
          } catch(e) {}
          if (params.has('debug') && typeof window.showDebugToast === 'function') {
            window.showDebugToast('âš ï¸ æ—§ç‰ˆã®å¯èƒ½æ€§: ?reset=sw ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
          }
        }
      }, { once: true });
    } catch(e) {}
  })();
  </script>

<!--
  Smart Price - Init Fix + Export/Import (NO FIREBASE)
  VERSION: v19.9.51
  AUTHOR: Yui
  DATE(JST): 2026-02-08 20:45 JST
  BUILD(b): 2026-02-08_2045_initfix_exportimport_nofb
  POLICY:
  - Firebase/UID/æ¥ç¶šå…ˆURLã«ã¯è§¦ã‚Œãªã„
  - UIå‡çµï¼šç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ï¼ˆDEBUG PANELï¼‰å†…ã«ã ã‘æ©Ÿèƒ½è¿½åŠ 
-->
<script>
(function(){
  'use strict';

  // ===== safe helpers =====
  function _qs(){ try{return new URL(location.href).searchParams;}catch(e){return new URLSearchParams('');} }
  function _getBuild(){ const p=_qs(); return p.get('b') || (window.BUILD_ID||'') || 'N/A'; }
  function _getVersion(){ return (window.VERSION_INFO||'').trim() || 'N/A'; }
  function _nowJP(){ try{ return new Date().toLocaleString('ja-JP'); }catch(e){ return String(new Date()); } }

  function _toast(msg) {
    try { if (typeof showToast === 'function') showToast(String(msg), 6000); } catch(e) {}
    try { if (typeof debugLog === 'function') debugLog(String(msg)); } catch(e) {}
  }

  async function _copy(text) {
    try {
      await navigator.clipboard.writeText(text);
      _toast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
      return true;
    } catch(e) {
      _toast('ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸï¼ˆä¸‹ã«è¡¨ç¤ºã—ãŸå†…å®¹ã‚’é•·æŠ¼ã—ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ï¼‰');
      return false;
    }
  }

  function _buildUrl(edits) {
    const u = new URL(location.href);
    const p = u.searchParams;
    if (edits && Object.prototype.hasOwnProperty.call(edits,'reset')) {
      if (edits.reset === null) p.delete('reset'); else p.set('reset', String(edits.reset));
    }
    if (edits && Object.prototype.hasOwnProperty.call(edits,'b')) {
      if (edits.b === null) p.delete('b'); else p.set('b', String(edits.b));
    }
    u.search = p.toString();
    return u.toString();
  }

  function _dbEmpty(db) {
    if (!db) return true;
    if (typeof db !== 'object') return true;
    const keys = Object.keys(db);
    if (!keys.length) return true;
    const p = Array.isArray(db.purchases) ? db.purchases.length : 0;
    const prod = db.products && typeof db.products === 'object' ? Object.keys(db.products).length : 0;
    return (p===0 && prod===0 && keys.length<=3);
  }

  function _safeParse(jsonStr) {
    try {
      return { ok:true, value: JSON.parse(jsonStr) };
    } catch(e) {
      return { ok:false, error: String(e) };
    }
  }

  // ===== v19.9.50+ init-fix: localStorage.smart_price_db -> window.db (display-modeéä¾å­˜) =====
  function _ensureDbFromLocalStorage() {
    try {
      if (!_dbEmpty(window.db)) return;
      const dbStr = localStorage.getItem('smart_price_db');
      if (dbStr) {
        const parsed = _safeParse(dbStr);
        if (parsed.ok && parsed.value && typeof parsed.value === 'object') {
          window.db = parsed.value;
          return;
        }
      }
      // fallback
      window.db = window.db || { products: {}, stores: {}, purchases: [] };
    } catch(e) {
      window.db = window.db || { products: {}, stores: {}, purchases: [] };
    }
  }

  // ===== export/import (admin only) =====
  function spAdminExportDb() {
    const dbStr = localStorage.getItem('smart_price_db') || '';
    const dataStr = localStorage.getItem('smart_price_data') || '';
    const payload = {
      kind: 'SmartPriceExport',
      version: _getVersion(),
      build: _getBuild(),
      exportedAtJST: _nowJP(),
      smart_price_db: dbStr,
      smart_price_data: dataStr
    };
    const text = JSON.stringify(payload);
    _showOut(text);
    _copy(text);
  }

  function spAdminImportDbFromText(text) {
    const parsed = _safeParse(text || '');
    if (!parsed.ok) {
      _toast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—ï¼šJSONã¨ã—ã¦èª­ã‚ã¾ã›ã‚“');
      return false;
    }
    const obj = parsed.value;
    // æœŸå¾…å½¢å¼ or ç”Ÿã®smart_price_dbæ–‡å­—åˆ—
    let dbStr = '';
    let dataStr = '';
    if (obj && obj.kind === 'SmartPriceExport') {
      dbStr = String(obj.smart_price_db || '');
      dataStr = String(obj.smart_price_data || '');
    } else if (typeof obj === 'object' && obj.products && obj.purchases) {
      dbStr = JSON.stringify(obj);
    } else {
      _toast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—ï¼šå½¢å¼ãŒé•ã„ã¾ã™ï¼ˆExportæ–‡å­—åˆ—ã‚’è²¼ã£ã¦ãã ã•ã„ï¼‰');
      return false;
    }

    if (!dbStr) {
      _toast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—ï¼šsmart_price_db ãŒç©ºã§ã™');
      return false;
    }

    // dbStr ã®ä¸­èº«ãŒJSONã¨ã—ã¦å£Šã‚Œã¦ãªã„ã‹ç¢ºèª
    const dbParsed = _safeParse(dbStr);
    if (!dbParsed.ok) {
      _toast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—ï¼šsmart_price_db ãŒå£Šã‚Œã¦ã„ã¾ã™');
      return false;
    }

    try {
      localStorage.setItem('smart_price_db', dbStr);
      if (dataStr) localStorage.setItem('smart_price_data', dataStr);
      window.db = dbParsed.value;
      _toast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆOKï¼šå†æç”»ã—ã¾ã™');
      try { if (typeof renderHistory === 'function') renderHistory(); } catch(e) {}
      return true;
    } catch(e) {
      _toast('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¤±æ•—ï¼šä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ');
      return false;
    }
  }

  // ===== diag text (no firebase) =====
  async function spAdminBuildDiagText() {
    let swCount='N/A', cacheCount='N/A';
    try {
      if ('serviceWorker' in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        swCount = regs.length;
      }
    } catch(e) { swCount='ERROR'; }
    try {
      if ('caches' in window) {
        const keys = await caches.keys();
        cacheCount = keys.length;
      }
    } catch(e) { cacheCount='ERROR'; }

    const keys = (()=>{ try{return Object.keys(localStorage||{}).length;}catch(e){return 'ERROR';} })();
    const hasDb = (()=>{ try{return !!localStorage.getItem('smart_price_db');}catch(e){return false;} })();

    let out = '';
    out += 'ã€Smart Price è¨ºæ–­ãƒ­ã‚°ï¼ˆé‹å–¶è€…ï¼Firebaseãªã—ï¼‰ã€‘\n';
    out += 'æ—¥æ™‚: ' + _nowJP() + '\n\n';
    out += 'â–  VERSION\n';
    out += 'VERSION: ' + _getVersion() + '\n';
    out += 'BUILD(b): ' + _getBuild() + '\n';
    out += 'URL: ' + location.href + '\n';
    out += 'PATH: ' + location.pathname + '\n\n';
    out += 'â–  SW/CACHE\n';
    out += 'SWç™»éŒ²æ•°: ' + swCount + '\n';
    out += 'Cacheæ•°: ' + cacheCount + '\n\n';
    out += 'â–  LOCAL STORAGE\n';
    out += 'ã‚­ãƒ¼æ•°: ' + keys + '\n';
    out += 'smart_price_db: ' + (hasDb ? 'ã‚ã‚Š' : 'ãªã—') + '\n\n';
    out += 'â–  DBï¼ˆç«¯æœ«å†… / window.dbï¼‰\n';
    try {
      const db = window.db || {};
      const pc = Array.isArray(db.purchases) ? db.purchases.length : 0;
      const prc = db.products && typeof db.products==='object' ? Object.keys(db.products).length : 0;
      out += 'è³¼å…¥ä»¶æ•°: ' + pc + '\n';
      out += 'å•†å“ä»¶æ•°: ' + prc + '\n';
    } catch(e) {
      out += 'è³¼å…¥ä»¶æ•°: ERROR\nå•†å“ä»¶æ•°: ERROR\n';
    }
    out += '\nâ–  URL QUICK LINKS\n';
    out += 'RESET_URL: ' + _buildUrl({ reset:'sw', b:_getBuild() }) + '\n';
    out += 'NORMAL_URL: ' + _buildUrl({ reset:null, b:_getBuild() }) + '\n';
    return out;
  }

  // ===== DEBUG PANEL injector =====
  let _outEl = null;
  let _inEl = null;

  function _findDebugPanel() {
    const known = document.querySelector('#debug-panel, #debugPanel, [data-debug-panel], .debug-panel');
    if (known) return known;
    const cand = document.querySelectorAll('div,section,aside,dialog');
    for (const el of cand) {
      if (el && el.textContent && el.textContent.indexOf('DEBUG PANEL') >= 0) return el;
    }
    return null;
  }

  function _showOut(text) {
    if (_outEl) {
      _outEl.style.display = 'block';
      _outEl.value = String(text || '');
    }
  }

  function _inject(panel) {
    if (!panel) return false;
    if (panel.querySelector('#sp-admin-tools-v1951')) return true;

    const wrap = document.createElement('div');
    wrap.id = 'sp-admin-tools-v1951';
    wrap.style.marginTop = '10px';
    wrap.innerHTML =
      '<div class="d-flex gap-2 mt-2">'
      + '<button class="btn btn-sm btn-dark flex-grow-1" id="sp-url">URLã‚³ãƒ”ãƒ¼</button>'
      + '<button class="btn btn-sm btn-dark flex-grow-1" id="sp-reset">SWè§£é™¤URL</button>'
      + '</div>'
      + '<div class="d-flex gap-2 mt-2">'
      + '<button class="btn btn-sm btn-warning w-100 fw-bold" id="sp-diag">è¨ºæ–­ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼</button>'
      + '</div>'
      + '<div class="d-flex gap-2 mt-2">'
      + '<button class="btn btn-sm btn-secondary flex-grow-1" id="sp-export">DBã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>'
      + '<button class="btn btn-sm btn-secondary flex-grow-1" id="sp-import">DBã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>'
      + '</div>'
      + '<textarea id="sp-in" class="form-control bg-dark text-white border-secondary mt-2" rows="4" '
      + ' placeholder="ã“ã“ã«ã€DBã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã€ã®æ–‡å­—åˆ—ã‚’è²¼ã£ã¦ã‹ã‚‰ã€DBã‚¤ãƒ³ãƒãƒ¼ãƒˆ" '
      + ' style="white-space:pre-wrap;word-break:break-all;"></textarea>'
      + '<textarea id="sp-out" class="form-control bg-dark text-white border-secondary mt-2" rows="6" readonly '
      + ' style="display:none;white-space:pre-wrap;word-break:break-all;"></textarea>'
      + '<div class="small text-secondary mt-1" style="opacity:.9;">'
      + 'â€»ã‚³ãƒ”ãƒ¼ã§ããªã„ç«¯æœ«ã¯ã€ä¸‹ã®æ¬„ã‚’é•·æŠ¼ã—ã‚³ãƒ”ãƒ¼ã§OKã€‚Firebaseã¯ä½¿ã„ã¾ã›ã‚“ã€‚'
      + '</div>';

    panel.appendChild(wrap);
    _outEl = wrap.querySelector('#sp-out');
    _inEl = wrap.querySelector('#sp-in');

    wrap.querySelector('#sp-url')?.addEventListener('click', async()=>{ const ok=await _copy(location.href); if(!ok)_showOut(location.href); });
    wrap.querySelector('#sp-reset')?.addEventListener('click', async()=>{ const u=_buildUrl({reset:'sw', b:_getBuild()}); const ok=await _copy(u); if(!ok)_showOut(u); });
    wrap.querySelector('#sp-diag')?.addEventListener('click', async()=>{ const t=await spAdminBuildDiagText(); _showOut(t); await _copy(t); });
    wrap.querySelector('#sp-export')?.addEventListener('click', ()=> spAdminExportDb() );
    wrap.querySelector('#sp-import')?.addEventListener('click', ()=> {
      const text = (_inEl && _inEl.value) ? _inEl.value : '';
      if (!text.trim()) { _toast('è²¼ã‚Šä»˜ã‘ãŒç©ºã§ã™'); return; }
      spAdminImportDbFromText(text.trim());
    });

    return true;
  }

  // expose minimal API for compatibility
  window.spAdminExportDb = spAdminExportDb;
  window.spAdminImportDbFromText = spAdminImportDbFromText;

  // init fix should run early after load
  document.addEventListener('DOMContentLoaded', function() {
    _ensureDbFromLocalStorage();
  });

  const mo = new MutationObserver(()=>{ const p=_findDebugPanel(); if(p) _inject(p); });
  mo.observe(document.body, {childList:true, subtree:true});
  const p0=_findDebugPanel(); if(p0) _inject(p0);

})();
</script>

</body>
</html>
