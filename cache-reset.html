
<!doctype html>
<!--
APP: Smart Price
TOOL: Cache Reset Tool (Edge/Chrome)
VERSION: v0.1.0
DATE(JST): 2026-02-11 21:28
TITLE: SW/Cache/Storage 一括クリア & 再読込（同一オリジン専用）
CHANGES:
- 1クリックで Service Worker解除/Cache削除/localStorage削除/IndexedDB削除 を実行
- クリア後に「?b=」を新しい値に付けて再読込（キャッシュ固定を回避）
BUILD_PARAM(b): ?b=2026-02-11_2128_cachetool
DEBUG_PARAM: &debug=1（任意）
POLICY: UI_FREEZE（アプリ本体UIは変更しない。これは補助ツール）
AUTHOR: ChatGPT
-->
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Smart Price Cache Reset Tool v0.1.0</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0; font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: #0b1220; color: #e8eefc;
    }
    .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    .card {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    h1 { font-size: 18px; margin: 0 0 10px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 860px) { .grid { grid-template-columns: 1fr 1fr; } }
    .row { display: grid; grid-template-columns: 180px 1fr; gap: 8px; align-items: start; }
    .k { opacity: 0.75; font-size: 12px; padding-top: 2px; }
    .v { font-size: 13px; word-break: break-all; }
    .btns { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
    button {
      appearance: none; border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.08);
      color: #e8eefc; padding: 10px 12px; border-radius: 12px;
      cursor: pointer; font-weight: 600; font-size: 13px;
    }
    button.primary {
      background: #f0c84a; color: #1a1a1a; border-color: rgba(0,0,0,0.12);
    }
    button.danger {
      background: rgba(255,90,90,0.25); border-color: rgba(255,90,90,0.35);
    }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .note { opacity: 0.85; font-size: 12px; line-height: 1.6; margin-top: 10px; }
    pre {
      margin: 0; padding: 12px; border-radius: 12px;
      background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.10);
      overflow: auto; font-size: 12px; line-height: 1.55;
    }
    .ok { color: #79f2c0; }
    .ng { color: #ff8a8a; }
    .muted { opacity: 0.7; }
    .pill {
      display: inline-block; padding: 2px 8px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.06);
      font-size: 12px; margin-left: 6px;
    }
    input {
      width: 100%; box-sizing: border-box;
      background: rgba(255,255,255,0.08); color: #e8eefc;
      border: 1px solid rgba(255,255,255,0.14); border-radius: 10px;
      padding: 10px 10px; font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Smart Price / Cache Reset Tool <span class="pill">v0.1.0</span></h1>
      <div class="grid">
        <div class="card" style="padding:14px;">
          <div class="row"><div class="k">いま開いてるURL</div><div class="v" id="curUrl"></div></div>
          <div class="row"><div class="k">オリジン（重要）</div><div class="v" id="origin"></div></div>
          <div class="row"><div class="k">ブラウザ</div><div class="v" id="ua"></div></div>
          <div class="row"><div class="k">Service Worker</div><div class="v" id="sw"></div></div>
          <div class="row"><div class="k">Cache Storage</div><div class="v" id="cs"></div></div>
          <div class="row"><div class="k">localStorage</div><div class="v" id="ls"></div></div>
          <div class="row"><div class="k">IndexedDB</div><div class="v" id="idb"></div></div>

          <div class="btns">
            <button class="primary" id="btnAll">① 全部クリア → ② b付け直し → ③ 再読込</button>
            <button class="danger" id="btnClear">クリアだけ（再読込なし）</button>
            <button id="btnReload">b を更新して再読込だけ</button>
            <button id="btnScan">状態を再チェック</button>
          </div>

          <div class="note">
            <b>超重要：</b>このツールは <span class="muted">Smart Price と同じドメイン（smart-price-official.github.io）</span> に置いて開いてね。<br/>
            ちがうドメイン（file:// や別サイト）だと、Service Worker/キャッシュを触れないよ。
          </div>
        </div>

        <div class="card" style="padding:14px;">
          <div class="row"><div class="k">開きたいアプリURL</div>
            <div class="v"><input id="appUrl" value="https://smart-price-official.github.io/Smart-Price-Book/" /></div>
          </div>
          <div class="row"><div class="k">b（上書き）</div>
            <div class="v"><input id="bVal" value="2026-02-11_2128_cachetool" /></div>
          </div>
          <div class="btns">
            <button id="btnOpen">このURLを b 付きで開く</button>
            <button id="btnOpenDebug">b + debug=1 で開く</button>
          </div>

          <div class="note">
            ここは「開き直し用」。<br/>
            「更新されない…」のときは、まず <b>全クリア → b更新 → 再読込</b> が最短。
          </div>

          <h1 style="margin-top:14px;font-size:14px;">実行ログ</h1>
          <pre id="log"></pre>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const logEl = $("log");
  const stamp = ()=>new Date().toISOString();
  const log = (s, cls="")=>{
    const line = `[${stamp()}] ${s}`;
    logEl.textContent += line + "\n";
    logEl.scrollTop = logEl.scrollHeight;
  };

  function setText(id, text) { $(id).textContent = text; }
  function qs(name) { return new URL(location.href).searchParams.get(name); }

  function withUpdatedB(url, b, debug) {
    const u = new URL(url, location.href);
    u.searchParams.set("b", b);
    if (debug) u.searchParams.set("debug", "1");
    else u.searchParams.delete("debug");
    return u.toString();
  }

  async function scan() {
    setText("curUrl", location.href);
    setText("origin", location.origin);
    setText("ua", navigator.userAgent);

    // SW
    try {
      if (!("serviceWorker" in navigator)) {
        setText("sw", "未対応");
      } else {
        const regs = await navigator.serviceWorker.getRegistrations();
        const urls = regs.map(r => r.scope).join(" / ");
        setText("sw", `${regs.length} 件` + (urls ? `（${urls}）` : ""));
      }
    } catch(e) {
      setText("sw", "取得失敗: " + e.message);
    }

    // CacheStorage
    try {
      if (!("caches" in window)) {
        setText("cs", "未対応");
      } else {
        const keys = await caches.keys();
        setText("cs", `${keys.length} 件` + (keys.length ? `（${keys.join(", ")}）` : ""));
      }
    } catch(e) {
      setText("cs", "取得失敗: " + e.message);
    }

    // localStorage
    try {
      const n = localStorage.length;
      let sample = [];
      for (let i=0;i<Math.min(n, 6);i++) sample.push(localStorage.key(i));
      setText("ls", `${n} 件` + (sample.length ? `（例: ${sample.join(", ")}）` : ""));
    } catch(e) {
      setText("ls", "取得失敗: " + e.message);
    }

    // IndexedDB
    try {
      if (!("indexedDB" in window)) {
        setText("idb", "未対応");
      } else if (indexedDB.databases) {
        const dbs = await indexedDB.databases();
        const names = dbs.map(d=>d.name).filter(Boolean);
        setText("idb", `${names.length} 件` + (names.length ? `（${names.join(", ")}）` : ""));
      } else {
        setText("idb", "一覧APIなし（Edgeの古い環境）");
      }
    } catch(e) {
      setText("idb", "取得失敗: " + e.message);
    }
  }

  async function clearServiceWorkers() {
    if (!("serviceWorker" in navigator)) return 0;
    const regs = await navigator.serviceWorker.getRegistrations();
    let ok = 0;
    for (const r of regs) {
      try {
        const rOk = await r.unregister();
        if (rOk) ok++;
      } catch(e) {}
    }
    return ok;
  }

  async function clearCaches() {
    if (!("caches" in window)) return 0;
    const keys = await caches.keys();
    let ok = 0;
    for (const k of keys) {
      try {
        const rOk = await caches.delete(k);
        if (rOk) ok++;
      } catch(e) {}
    }
    return ok;
  }

  function clearLocalStorage() {
    const n = localStorage.length;
    localStorage.clear();
    return n;
  }

  async function clearIndexedDBs() {
    if (!("indexedDB" in window)) return 0;
    if (!indexedDB.databases) return -1; // unsupported
    const dbs = await indexedDB.databases();
    const names = dbs.map(d=>d.name).filter(Boolean);
    let ok = 0;
    await Promise.all(names.map(name => new Promise(resolve=>{
      try {
        const req = indexedDB.deleteDatabase(name);
        req.onsuccess = ()=>{ ok++; resolve(); };
        req.onerror = ()=>resolve();
        req.onblocked = ()=>resolve();
      } catch(e) { resolve(); }
    })));
    return ok;
  }

  async function clearAll() {
    logEl.textContent = "";
    log("クリア開始");

    let sw = 0, cs = 0, ls = 0, idb = 0;
    try {
      sw = await clearServiceWorkers();
      log(`ServiceWorker: unregister ${sw} 件`);
    } catch(e) {
      log(`ServiceWorker: 失敗 ${e.message}`);
    }

    try {
      cs = await clearCaches();
      log(`CacheStorage: delete ${cs} 件`);
    } catch(e) {
      log(`CacheStorage: 失敗 ${e.message}`);
    }

    try {
      ls = clearLocalStorage();
      log(`localStorage: clear ${ls} 件`);
    } catch(e) {
      log(`localStorage: 失敗 ${e.message}`);
    }

    try {
      idb = await clearIndexedDBs();
      if (idb === -1) log("IndexedDB: 一覧APIなし（このEdgeでは自動削除できません）");
      else log(`IndexedDB: delete ${idb} 件`);
    } catch(e) {
      log(`IndexedDB: 失敗 ${e.message}`);
    }

    log("クリア完了。状態を再チェックします。");
    await scan();
    return {sw, cs, ls, idb};
  }

  function updateBAndReload() {
    const newB = $("bVal").value || "2026-02-11_2128_cachetool";
    const u = new URL(location.href);
    u.searchParams.set("b", newB);
    // いつでも強制更新したいので tool自体もb付け替え
    location.href = u.toString();
  }

  function openApp(debug) {
    const base = $("appUrl").value.trim();
    const b = $("bVal").value.trim() || "2026-02-11_2128_cachetool";
    const url = withUpdatedB(base, b, debug);
    window.open(url, "_blank", "noopener");
  }

  $("btnScan").addEventListener("click", scan);
  $("btnClear").addEventListener("click", clearAll);
  $("btnReload").addEventListener("click", updateBAndReload);

  $("btnAll").addEventListener("click", async ()=>{
    await clearAll();
    // クリア直後に、同じオリジンのアプリをb付きで開く
    openApp(false);
    log("アプリを新しい b 付きで別タブに開きました。");
  });

  $("btnOpen").addEventListener("click", ()=>openApp(false));
  $("btnOpenDebug").addEventListener("click", ()=>openApp(true));

  // init
  // toolのbが無いなら付ける（ツール自体のキャッシュも回避）
  const curB = qs("b");
  if (!curB) {
    const u = new URL(location.href);
    u.searchParams.set("b", "2026-02-11_2128_cachetool");
    history.replaceState(null, "", u.toString());
  }
  scan();
})();
</script>
</body>
</html>
