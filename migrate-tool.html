<!doctype html>
<html lang="ja">
<head>
  <!--
  APP: Smart Price / Migrate Tool
  VERSION: v0.3.2-wizard-url
  DATE(JST): 2026-02-09 22:02
  TITLE: MIGRATE TOOL（URL版）：コピー導線＋VERSION抽出
  CHANGES:
  - 左→右 / 右→左 の「コピー（JSON作成）」ボタンを追加（※実際の移行は Import で反映）
  - URLからHTMLを取得して VERSION/BUILD を抽出表示（GitHub blob/raw/Pages に対応を試行）
  - 次にやることを上から順に“押すだけ”で進むガイドを強化
  BUILD_PARAM(b): ?b=2026-02-09_2202_wizard-url-v032
  DEBUG_PARAM: &debug=1
  POLICY: 単一HTML / UIはツール内のみ（Smart Price本体UIは変更しない）
  AUTHOR: Yui
  -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Smart Price / Migrate Tool v0.3.2-wizard-url</title>
  <style>
    :root {
      --bg0:#0b1020; --bg1:#0f1630;
      --line:rgba(255,255,255,.10);
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --btn:#1f2a52; --btn2:#27356a;
      --shadow:0 18px 60px rgba(0,0,0,.45);
      --r:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --ui: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Sans", "Yu Gothic", sans-serif;
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family:var(--ui);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(96,165,250,.16), transparent 55%),
        radial-gradient(900px 500px at 85% 25%, rgba(34,197,94,.12), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      color:var(--txt);
    }
    header{
      position:sticky; top:0; z-index:50;
      background: linear-gradient(90deg, rgba(220,38,38,.92), rgba(127,29,29,.92));
      border-bottom:1px solid rgba(255,255,255,.12);
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .hdr{
      max-width:1200px; margin:0 auto; padding:10px 16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{display:flex; align-items:center; gap:10px; min-width:240px;}
    .dot{width:10px; height:10px; border-radius:50%; background:rgba(255,255,255,.9); box-shadow:0 0 0 3px rgba(255,255,255,.16);}
    .ttl{font-weight:800; letter-spacing:.2px;}
    .sub{font-size:12px; opacity:.85;}
    .chips{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    .chip{
      font-size:12px; padding:6px 10px; border-radius:999px;
      background:rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.16);
      backdrop-filter: blur(6px);
    }
    main{max-width:1200px; margin:0 auto; padding:16px;}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    @media (max-width:1000px){ .grid{grid-template-columns:1fr;} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h3{
      margin:0; padding:12px 14px;
      background:rgba(0,0,0,.20);
      border-bottom:1px solid var(--line);
      font-size:14px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .okpill,.badpill,.warnpill{
      font-size:11px; padding:4px 8px; border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(0,0,0,.20);
    }
    .okpill{color:rgba(34,197,94,.95);}
    .warnpill{color:rgba(245,158,11,.95);}
    .badpill{color:rgba(239,68,68,.95);}
    .body{padding:12px 14px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .row + .row{margin-top:10px;}
    .label{font-size:12px; color:var(--muted); margin-bottom:6px;}
    input[type="text"]{
      width:100%;
      background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.16);
      color:var(--txt);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
      box-sizing:border-box;
    }
    .btn{
      appearance:none; border:none;
      background: linear-gradient(180deg, var(--btn2), var(--btn));
      color:var(--txt);
      border:1px solid rgba(255,255,255,.16);
      border-radius:12px;
      padding:10px 12px;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 10px 25px rgba(0,0,0,.25);
    }
    .btn:active{transform: translateY(1px);}
    .btnpri{background: linear-gradient(180deg, rgba(96,165,250,.88), rgba(37,99,235,.86));}
    .btngreen{background: linear-gradient(180deg, rgba(34,197,94,.88), rgba(21,128,61,.86));}
    .btnred{background: linear-gradient(180deg, rgba(239,68,68,.88), rgba(185,28,28,.86));}
    .btnsmall{padding:8px 10px; font-size:12px;}
    .hint{font-size:12px; color:var(--muted); line-height:1.5;}
    .mono{font-family:var(--mono);}
    .log{
      font-family:var(--mono);
      font-size:12px;
      background:rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.14);
      border-radius:12px;
      padding:10px 12px;
      white-space:pre-wrap;
      word-break:break-word;
      min-height:80px;
    }
    .bigstep{
      margin-top:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      padding:12px 14px;
    }
    .bigstep h4{margin:0 0 8px 0; font-size:13px;}
    .todo{
      display:flex; gap:10px; align-items:flex-start;
      padding:8px 0;
      border-top:1px dashed rgba(255,255,255,.10);
    }
    .todo:first-of-type{border-top:none;}
    .num{
      width:22px; height:22px; border-radius:999px;
      display:inline-flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.16);
      font-size:12px; font-weight:800;
      flex:0 0 auto;
      margin-top:1px;
    }
    .split{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    @media (max-width:1000px){ .split{grid-template-columns:1fr;} }
  </style>
</head>
<body>
<header>
  <div class="hdr">
    <div class="brand">
      <div class="dot"></div>
      <div>
        <div class="ttl">Smart Price / Migrate Tool（URL版・コピー導線）</div>
        <div class="sub mono">VERSION v0.3.2-wizard-url · BUILD 2026-02-09_2202_wizard-url-v032</div>
      </div>
    </div>
    <div class="chips">
      <div class="chip mono">NOW: 2026-02-09 22:02:50 JST</div>
      <div class="chip mono" id="chipOrigin">ORIGIN: (loading)</div>
      <div class="chip mono">AUTHOR: Yui</div>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <h3>① 左（正本/マスター） <span class="warnpill" id="leftStatus">未点検</span></h3>
      <div class="body">
        <div class="label">対象URL（ここに貼る）</div>
        <input type="text" id="leftUrl" placeholder="例：v19.9.43[0207] の URL / または file:/// の index.html" />
        <div class="row">
          <button class="btn btnpri" id="btnLeftProbe">このURLのデータを点検</button>
          <button class="btn btnsmall" id="btnLeftOpen">このURLを開く</button>
          <button class="btn btnsmall" id="btnLeftVer">URLからVERSIONを抽出</button>
        </div>

        <div class="split" style="margin-top:10px;">
          <div>
            <div class="label">点検ログ（左）</div>
            <div class="log" id="leftLog">まだです。</div>
          </div>
          <div>
            <div class="label">検出VERSION（左）</div>
            <div class="log" id="leftVerLog">まだです。</div>
          </div>
        </div>

        <div class="bigstep">
          <h4>左→右（正本データを渡す）</h4>
          <div class="hint">※別URLの保存領域へ「直接コピー」はブラウザ仕様で不可。<br>なので <b>Export（JSON）→ Import</b> が最短です。</div>
          <div class="row" style="margin-top:10px;">
            <button class="btn btngreen" id="btnExportLeft">左のデータを Export（JSON保存）</button>
            <button class="btn btnsmall" id="btnCopyLeftSummary">左のサマリをコピー</button>
          </div>
          <div class="hint mono" id="leftExportHint" style="margin-top:8px;"></div>
        </div>
      </div>
    </section>

    <section class="card">
      <h3>② 右（取り込み先） <span class="warnpill" id="rightStatus">未点検</span></h3>
      <div class="body">
        <div class="label">対象URL（ここに貼る）</div>
        <input type="text" id="rightUrl" placeholder="例：https://smart-price-official.github.io/Smart-Price-Book/ など" />
        <div class="row">
          <button class="btn btnpri" id="btnRightProbe">このURLのデータを点検</button>
          <button class="btn btnsmall" id="btnRightOpen">このURLを開く</button>
          <button class="btn btnsmall" id="btnRightVer">URLからVERSIONを抽出</button>
        </div>

        <div class="split" style="margin-top:10px;">
          <div>
            <div class="label">点検ログ（右）</div>
            <div class="log" id="rightLog">まだです。</div>
          </div>
          <div>
            <div class="label">検出VERSION（右）</div>
            <div class="log" id="rightVerLog">まだです。</div>
          </div>
        </div>

        <div class="bigstep">
          <h4>右で Import（左のExport JSONを取り込む）</h4>
          <div class="row" style="margin-top:10px;">
            <input type="file" id="fileImport" accept=".json,application/json" />
            <button class="btn btngreen" id="btnImportHere">このページに Import（このORIGINへ）</button>
          </div>
          <div class="hint mono" id="rightImportHint" style="margin-top:8px;"></div>
        </div>
      </div>
    </section>
  </div>

  <section class="card" style="margin-top:12px;">
    <h3>③ 判定（比較） <span class="warnpill" id="cmpStatus">未実行</span></h3>
    <div class="body">
      <div class="row">
        <button class="btn btnpri" id="btnCompare">左右を比較して結論を出す</button>
        <button class="btn btnsmall" id="btnSwap">左右を入れ替える（表示だけ）</button>
        <button class="btn btnsmall btnred" id="btnReset">全部クリア</button>
        <button class="btn btngreen" id="btnCopyConclusion">結論をコピー</button>
      </div>
      <div class="label" style="margin-top:10px;">比較結果</div>
      <div class="log" id="compareLog">まだです。</div>

      <div class="bigstep" style="margin-top:12px;">
        <h4>次に押すボタン（ここだけ見ればOK）</h4>
        <div class="todo"><span class="num">1</span><div><b>左URL</b>に v19.9.43[0207] を貼る → <b>「このURLのデータを点検」</b></div></div>
        <div class="todo"><span class="num">2</span><div><b>右URL</b>に 取り込み先URL → <b>「このURLのデータを点検」</b></div></div>
        <div class="todo"><span class="num">3</span><div><b>（任意）VERSION抽出</b> → 取り違え防止</div></div>
        <div class="todo"><span class="num">4</span><div><b>比較して結論</b> → 左が正本ならOK</div></div>
        <div class="todo"><span class="num">5</span><div><b>左でExport</b> → <b>右でImport</b> → 右アプリを再読み込み</div></div>
      </div>
    </div>
  </section>
</main>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const state = {
    left: { url:'', probe:null, ver:null },
    right:{ url:'', probe:null, ver:null },
  };

  function setChipOrigin(){ $('chipOrigin').textContent = 'ORIGIN: ' + location.origin; }
  function nowIso(){ return new Date().toISOString(); }

  function approxCharsLocalStorage(){
    let total = 0;
    for (let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      const v = localStorage.getItem(k) || '';
      total += (k ? k.length : 0) + v.length;
    }
    return total;
  }

  function topKeysLocalStorage(limit=20){
    const arr = [];
    for (let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      const v = localStorage.getItem(k) || '';
      arr.push({ k, sz: (k?k.length:0)+v.length });
    }
    arr.sort((a,b)=>b.sz-a.sz);
    return arr.slice(0, limit);
  }

  function exportLocalStorageAll(){
    const out = {};
    for (let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      out[k] = localStorage.getItem(k);
    }
    return out;
  }

  async function listIDBs(){
    if (!indexedDB.databases) return [];
    try {
      const dbs = await indexedDB.databases();
      return (dbs || []).map(d => ({ name: d.name || '', version: d.version || 0 }));
    } catch(e) { return []; }
  }

  async function probeThisOrigin(){
    const lsKeys = localStorage.length;
    const lsApprox = approxCharsLocalStorage();
    const lsTop = topKeysLocalStorage(25);
    const dbs = await listIDBs();
    return {
      kind:'SmartPriceOriginProbe',
      toolVersion:'v0.3.2-wizard-url',
      build:'2026-02-09_2202_wizard-url-v032',
      atUTC: nowIso(),
      origin: location.origin,
      href: location.href,
      localStorage:{ keys: lsKeys, approxChars: lsApprox, topKeys: lsTop },
      indexedDB:{ databases: dbs },
      note:'このツールは「いま開いているORIGIN」だけ読めます（ブラウザ仕様）。'
    };
  }

  function renderProbe(side, summary){
    const logEl = side==='left' ? $('leftLog') : $('rightLog');
    const statusEl = side==='left' ? $('leftStatus') : $('rightStatus');

    const dbs = (summary.indexedDB && summary.indexedDB.databases) ? summary.indexedDB.databases : [];
    const lines = [];
    lines.push(`[ORIGIN] ${summary.origin}`);
    lines.push(`[HREF]   ${summary.href}`);
    lines.push('');
    lines.push(`[localStorage] keys=${summary.localStorage.keys}, approxChars=${summary.localStorage.approxChars}`);
    lines.push('topKeys:');
    summary.localStorage.topKeys.forEach(x => lines.push(`- ${x.k} (${x.sz} chars)`));
    lines.push('');
    lines.push('[IndexedDB] databases:');
    if (!dbs.length) lines.push('- (none or not supported)');
    else dbs.forEach(d => lines.push(`- ${d.name} (ver ${d.version})`));

    logEl.textContent = lines.join('\n');

    if (summary.localStorage.keys === 0 && summary.localStorage.approxChars < 1000 && dbs.length === 0){
      statusEl.textContent = 'ほぼ空';
      statusEl.className = 'badpill';
    } else {
      statusEl.textContent = '検出OK';
      statusEl.className = 'okpill';
    }
  }

  function downloadJson(obj, filename){
    const blob = new Blob([JSON.stringify(obj, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  }

  async function copyText(text){ return navigator.clipboard.writeText(text); }

  function normalizeGitHubRaw(url){
    try{
      const u = new URL(url);
      if (u.hostname === 'github.com'){
        const parts = u.pathname.split('/').filter(Boolean);
        if (parts.length >= 5 && parts[2] === 'blob'){
          const org = parts[0], repo = parts[1], sha = parts[3];
          const path = parts.slice(4).join('/');
          return `https://raw.githubusercontent.com/${org}/${repo}/${sha}/${path}`;
        }
      }
    }catch(e){}
    return url;
  }

  function extractVersionFieldsFromHtml(htmlText){
    const out = { title:null, version:null, appVersion:null, fullVersion:null, buildId:null, detectedBy:[] };
    const mTitle = htmlText.match(/<title>([^<]{1,120})<\/title>/i);
    if (mTitle){ out.title = mTitle[1].trim(); out.detectedBy.push('title'); }

    const pick = (re, key, tag) => {
      const m = htmlText.match(re);
      if (m && m[1]) { out[key] = m[1]; out.detectedBy.push(tag); }
    };

    pick(/window\.VERSION_INFO\s*=\s*['"]([^'"]+)['"]/i, 'version', 'window.VERSION_INFO');
    pick(/window\.APP_VERSION\s*=\s*['"]([^'"]+)['"]/i, 'appVersion', 'window.APP_VERSION');
    pick(/window\.FULL_VERSION\s*=\s*['"]([^'"]+)['"]/i, 'fullVersion', 'window.FULL_VERSION');
    pick(/window\.BUILD_ID\s*=\s*['"]([^'"]+)['"]/i, 'buildId', 'window.BUILD_ID');
    pick(/\bVERSION\s*:\s*([^\n\r]{1,80})/i, 'version', 'comment VERSION:');
    pick(/\bBUILD\s*\(?.*?\)?\s*:\s*([^\n\r]{1,120})/i, 'buildId', 'comment BUILD:');

    return out;
  }

  async function fetchHtmlForVersion(url){
    const normalized = normalizeGitHubRaw(url);
    const candidates = [normalized];
    try{
      const u = new URL(normalized);
      if (u.hostname.endsWith('github.io') && !u.pathname.endsWith('.html')){
        let p = u.pathname;
        if (!p.endsWith('/')) p += '/';
        candidates.push(u.origin + p + 'index.html' + u.search);
      }
    }catch(e){}

    let lastErr = null;
    for (const cand of candidates){
      try{
        const res = await fetch(cand, { cache:'no-store', mode:'cors' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        return { usedUrl: cand, text };
      }catch(e){ lastErr = e; }
    }
    throw lastErr || new Error('fetch failed');
  }

  function renderVersion(side, info, usedUrl){
    const el = side==='left' ? $('leftVerLog') : $('rightVerLog');
    const lines = [];
    lines.push(`[FETCH] ${usedUrl || '(n/a)'}`);
    lines.push('');
    lines.push(`title: ${info.title || '(not found)'}`);
    lines.push(`version: ${info.version || '(not found)'}`);
    lines.push(`appVersion: ${info.appVersion || '(not found)'}`);
    lines.push(`fullVersion: ${info.fullVersion || '(not found)'}`);
    lines.push(`buildId: ${info.buildId || '(not found)'}`);
    lines.push(`detectedBy: ${(info.detectedBy || []).join(', ') || '(none)'}`);
    el.textContent = lines.join('\n');
  }

  function makeSummaryText(side, probe, verInfo, url){
    const p = probe || {};
    const v = verInfo || {};
    const dbs = (p.indexedDB && p.indexedDB.databases) ? p.indexedDB.databases.length : 0;
    return [
      `[${side.toUpperCase()}]`,
      `url: ${url || ''}`,
      `origin: ${p.origin || ''}`,
      `localStorage keys: ${(p.localStorage && p.localStorage.keys) ?? ''}`,
      `localStorage approxChars: ${(p.localStorage && p.localStorage.approxChars) ?? ''}`,
      `indexedDB dbs: ${dbs}`,
      `version: ${v.version || v.appVersion || ''}`,
      `build: ${v.buildId || ''}`,
      `title: ${v.title || ''}`,
    ].join('\n');
  }

  function compareAndConclude(){
    const A = state.left.probe;
    const B = state.right.probe;
    const res = {
      kind:'SmartPriceCompareResult',
      toolVersion:'v0.3.2-wizard-url',
      build:'2026-02-09_2202_wizard-url-v032',
      atUTC: nowIso(),
      leftUrl: $('leftUrl').value.trim(),
      rightUrl: $('rightUrl').value.trim(),
      left:{ probe:A, ver: state.left.ver },
      right:{ probe:B, ver: state.right.ver },
      score:{ left:0, right:0 },
      conclusion:'',
      next:''
    };

    const score = (p) => {
      if (!p) return 0;
      const ls = (p.localStorage && p.localStorage.approxChars) ? p.localStorage.approxChars : 0;
      const keys = (p.localStorage && p.localStorage.keys) ? p.localStorage.keys : 0;
      const dbs = (p.indexedDB && p.indexedDB.databases) ? p.indexedDB.databases.length : 0;
      return ls + keys*120 + dbs*800;
    };

    res.score.left = score(A);
    res.score.right = score(B);

    let winner = 'left';
    if (res.score.right > res.score.left) winner = 'right';

    if (winner === 'left'){
      res.conclusion = '結論：左（正本）が「多い」ので、左を正本（master）として採用。';
      res.next = '次：左でExport → 右でImport（取り込み）';
    } else {
      res.conclusion = '結論：右の方が「多い」（要注意）。必要なら左右を入れ替えて運用。';
      res.next = '次：右でExport → 左でImport（取り込み）';
    }
    return res;
  }

  // events
  $('btnLeftOpen').onclick = () => {
    const url = $('leftUrl').value.trim();
    if (!url) return alert('左URLを入れてください');
    window.open(url, '_blank', 'noopener');
  };
  $('btnRightOpen').onclick = () => {
    const url = $('rightUrl').value.trim();
    if (!url) return alert('右URLを入れてください');
    window.open(url, '_blank', 'noopener');
  };

  $('btnLeftProbe').onclick = async () => {
    const sum = await probeThisOrigin();
    state.left.probe = sum;
    state.left.url = $('leftUrl').value.trim();
    renderProbe('left', sum);
    $('leftExportHint').textContent = '';
  };
  $('btnRightProbe').onclick = async () => {
    const sum = await probeThisOrigin();
    state.right.probe = sum;
    state.right.url = $('rightUrl').value.trim();
    renderProbe('right', sum);
    $('rightImportHint').textContent = '';
  };

  $('btnLeftVer').onclick = async () => {
    const url = $('leftUrl').value.trim();
    if (!url) return alert('左URLを入れてください');
    $('leftVerLog').textContent = '取得中…';
    try{
      const { usedUrl, text } = await fetchHtmlForVersion(url);
      const info = extractVersionFieldsFromHtml(text);
      state.left.ver = info;
      renderVersion('left', info, usedUrl);
    }catch(e){
      $('leftVerLog').textContent = '取得失敗: ' + (e && e.message ? e.message : String(e)) + '\n\nヒント: GitHubの「blob」URLならrawへ変換します。PagesでCORS制限の可能性もあります。';
    }
  };
  $('btnRightVer').onclick = async () => {
    const url = $('rightUrl').value.trim();
    if (!url) return alert('右URLを入れてください');
    $('rightVerLog').textContent = '取得中…';
    try{
      const { usedUrl, text } = await fetchHtmlForVersion(url);
      const info = extractVersionFieldsFromHtml(text);
      state.right.ver = info;
      renderVersion('right', info, usedUrl);
    }catch(e){
      $('rightVerLog').textContent = '取得失敗: ' + (e && e.message ? e.message : String(e)) + '\n\nヒント: GitHubの「blob」URLならrawへ変換します。PagesでCORS制限の可能性もあります。';
    }
  };

  $('btnExportLeft').onclick = async () => {
    const pkg = {
      kind:'SmartPriceDataExport',
      toolVersion:'v0.3.2-wizard-url',
      build:'2026-02-09_2202_wizard-url-v032',
      atUTC: nowIso(),
      origin: location.origin,
      href: location.href,
      localStorage: exportLocalStorageAll(),
      indexedDB: { databases: await listIDBs() },
      extractedVersion: state.left.ver || null,
      enteredLeftUrl: $('leftUrl').value.trim(),
      enteredRightUrl: $('rightUrl').value.trim(),
      note:'このJSONは「このORIGIN」のlocalStorageを保存します。IndexedDB本体の全ダンプは対象外（将来拡張）。Smart Price本体にExportがあるならそちらが正本です。'
    };
    const fname = 'smartprice_export_' + new Date().toISOString().slice(0,16).replace(/[:T]/g,'') + '_left.json';
    downloadJson(pkg, fname);
    $('leftExportHint').textContent = '保存しました: ' + fname + '（次は右側でこのJSONをImport）';
  };

  $('btnCopyLeftSummary').onclick = async () => {
    const t = makeSummaryText('left', state.left.probe, state.left.ver, $('leftUrl').value.trim());
    try { await copyText(t); $('leftExportHint').textContent = '左サマリをコピーしました。'; }
    catch(e) { alert('コピー失敗（権限/HTTPSの影響）。'); }
  };

  $('btnImportHere').onclick = async () => {
    const f = $('fileImport').files && $('fileImport').files[0];
    if (!f) return alert('ImportするJSONファイルを選んでください');
    const txt = await f.text();
    let obj = null;
    try { obj = JSON.parse(txt); } catch(e) { return alert('JSONの読み取りに失敗しました'); }
    if (!obj || !obj.localStorage) return alert('このJSONは想定形式ではありません（localStorageがありません）');

    let applied = 0;
    for (const [k,v] of Object.entries(obj.localStorage)){
      try { localStorage.setItem(k, v); applied++; } catch(e) {}
    }
    $('rightImportHint').textContent = 'Importしました: localStorage ' + applied + ' 件。対象アプリURLを再読み込みしてください。';
    $('rightStatus').textContent = 'Import済';
    $('rightStatus').className = 'okpill';
  };

  $('btnCompare').onclick = () => {
    const res = compareAndConclude();
    $('compareLog').textContent = JSON.stringify(res, null, 2);
    $('cmpStatus').textContent = 'OK';
    $('cmpStatus').className = 'okpill';
  };

  $('btnCopyConclusion').onclick = async () => {
    const text = $('compareLog').textContent || '';
    try { await copyText(text); } catch(e) { alert('コピー失敗（権限/HTTPSの影響）。'); }
  };

  $('btnSwap').onclick = () => {
    const a = $('leftUrl').value;
    $('leftUrl').value = $('rightUrl').value;
    $('rightUrl').value = a;

    const la = $('leftLog').textContent;
    $('leftLog').textContent = $('rightLog').textContent;
    $('rightLog').textContent = la;

    const va = $('leftVerLog').textContent;
    $('leftVerLog').textContent = $('rightVerLog').textContent;
    $('rightVerLog').textContent = va;

    const sa = $('leftStatus').textContent;
    const sca = $('leftStatus').className;
    $('leftStatus').textContent = $('rightStatus').textContent;
    $('leftStatus').className = $('rightStatus').className;
    $('rightStatus').textContent = sa;
    $('rightStatus').className = sca;

    const sl = state.left; state.left = state.right; state.right = sl;
  };

  $('btnReset').onclick = () => {
    $('leftUrl').value = '';
    $('rightUrl').value = '';
    $('leftLog').textContent = 'まだです。';
    $('rightLog').textContent = 'まだです。';
    $('leftVerLog').textContent = 'まだです。';
    $('rightVerLog').textContent = 'まだです。';
    $('compareLog').textContent = 'まだです。';
    $('leftStatus').textContent = '未点検';
    $('rightStatus').textContent = '未点検';
    $('cmpStatus').textContent = '未実行';
    $('leftStatus').className = 'warnpill';
    $('rightStatus').className = 'warnpill';
    $('cmpStatus').className = 'warnpill';
    $('leftExportHint').textContent = '';
    $('rightImportHint').textContent = '';
    $('fileImport').value = '';
    state.left = { url:'', probe:null, ver:null };
    state.right = { url:'', probe:null, ver:null };
  };

  setChipOrigin();
})();
</script>
</body>
</html>
