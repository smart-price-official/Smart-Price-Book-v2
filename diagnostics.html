
<!doctype html>
<html lang="ja">
<head>
  <!--
    APP: Smart Price
    FILE: diagnostics.html
    VERSION: v1.0.0
    DATE(JST): 2026-02-04 19:13 JST
    TITLE: Smart Price åŸå› èª¿æŸ»ã‚¢ãƒ—ãƒªï¼ˆdiagnostics.htmlï¼‰ä¿®æ­£ç‰ˆ
    CHANGES:
    - GitHub Pages ç›´ç½®ãç”¨ã«å˜ä½“ã§å‹•ã diagnostics.html ã‚’å†ä½œæˆï¼ˆä»®ãƒšãƒ¼ã‚¸ã§ã¯ãªãæœ¬ä½“ï¼‰
    - Service Worker / Cache / Storage çŠ¶æ…‹è¡¨ç¤º + è§£é™¤ãƒœã‚¿ãƒ³
    - è¨­å®šURLãƒ»build(b=)ãƒ»debug(debug=1) ã‚’ç”»é¢ã§ç¢ºèªã§ãã‚‹ã‚ˆã†æ•´ç†
    BUILD_PARAM: ?b=2026-02-04_1913_diagfix
    DEBUG_PARAM: &debug=1
    AUTHOR: Yui
    POLICY: UIã¯å¢—ã‚„ã—ã™ããšã€ã‚¹ãƒãƒ›æ¤œè¨¼ã§è¿·ã‚ãªã„æœ€å°å°ç·š
  -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Smart Price Diagnostics</title>
  <style>
    :root{--bg:#121212;--panel:#1e1e1e;--line:#444;--text:#e0e0e0;--muted:#bdbdbd;--accent:#ff9800;--btn:#ff9800;--btnText:#121212;--danger:#d32f2f;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"BIZ UDã‚´ã‚·ãƒƒã‚¯","Meiryo",sans-serif;line-height:1.6}
    header{padding:18px 16px 10px;border-bottom:3px solid var(--accent)}
    header h1{margin:0;font-size:20px;color:var(--accent);letter-spacing:.3px}
    header .sub{margin-top:6px;color:var(--muted);font-size:12px;word-break:break-all}
    .wrap{padding:14px 12px 26px;max-width:980px;margin:0 auto}
    .section{background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:12px;margin:12px 0}
    .section-title{font-weight:800;color:var(--accent);margin:0 0 10px;display:flex;gap:8px;align-items:center}
    .row{display:grid;grid-template-columns:220px 1fr;gap:10px;padding:8px 0;border-top:1px solid rgba(255,255,255,.06)}
    .row:first-of-type{border-top:none}
    .k{color:var(--muted);font-size:12px}
    .v{font-size:13px;word-break:break-all}
    .btnbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{appearance:none;border:none;background:var(--btn);color:var(--btnText);font-weight:800;padding:12px 14px;border-radius:10px;cursor:pointer}
    button.secondary{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.22);font-weight:700}
    button.danger{background:var(--danger);color:#fff}
    .note{color:var(--muted);font-size:12px;margin-top:6px}
    .badge{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;font-weight:800;background:rgba(255,152,0,.18);border:1px solid rgba(255,152,0,.35);color:var(--accent)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    textarea{width:100%;min-height:150px;background:#0f0f0f;color:var(--text);border:1px solid rgba(255,255,255,.18);border-radius:10px;padding:10px;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace;font-size:12px}
    @media (max-width:720px){.row{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <h1>ğŸ” Smart Price åŸå› èª¿æŸ»ã‚¢ãƒ—ãƒª</h1>
    <div class="sub">
      <span class="badge">DIAG v1.0.0</span>
      <span class="mono">b=<span id="qBuild"></span></span>
      <span class="mono">debug=<span id="qDebug"></span></span>
      <div class="mono" id="locLine"></div>
    </div>
  </header>

  <div class="wrap">
    <div class="section" id="secA">
      <div class="section-title">ğŸ“Œ A) èª­ã¿è¾¼ã‚“ã HTMLã®æƒ…å ±</div>
      <div class="row"><div class="k">FULL VERSION</div><div class="v mono" id="aFull">ç¢ºèªä¸­â€¦</div></div>
      <div class="row"><div class="k">BUILD ID</div><div class="v mono" id="aBuild">ç¢ºèªä¸­â€¦</div></div>
      <div class="row"><div class="k">BUILD PARAM (?b=)</div><div class="v mono" id="aB">ç¢ºèªä¸­â€¦</div></div>
      <div class="row"><div class="k">Firebase</div><div class="v mono" id="aFb">ç¢ºèªä¸­â€¦</div></div>
      <div class="row"><div class="k">èª­ã¿è¾¼ã‚“ã URL</div><div class="v mono" id="aUrl">ç¢ºèªä¸­â€¦</div></div>
      <div class="row"><div class="k">Date.now()</div><div class="v mono" id="aNow">ç¢ºèªä¸­â€¦</div></div>
      <div class="btnbar"><button id="btnRefresh">ãƒšãƒ¼ã‚¸æƒ…å ±ã‚’æ›´æ–°</button></div>
      <div class="note">â€» ã“ã“ãŒåŸ‹ã¾ã‚‰ãªã„/å¤‰ãªã‚‰ã€Œã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ã€ŒService Workerã€ãŒç–‘ã„ã€‚</div>
    </div>

    <div class="section" id="secB">
      <div class="section-title">ğŸ§¹ B) Service Worker / ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®çŠ¶æ…‹</div>
      <div class="row"><div class="k">SW Controller</div><div class="v mono" id="bCtrl">ç¢ºèªä¸­â€¦</div></div>
      <div class="row"><div class="k">SW ç™»éŒ²æ•°</div><div class="v mono" id="bRegs">ç¢ºèªä¸­â€¦</div></div>
      <div class="row"><div class="k">ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ•°</div><div class="v mono" id="bCaches">ç¢ºèªä¸­â€¦</div></div>
      <div class="btnbar">
        <button class="danger" id="btnNuke">SWè§£é™¤ï¼‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ï¼‹ãƒªãƒ­ãƒ¼ãƒ‰</button>
        <button class="secondary" id="btnOnlyReload">ï¼ˆå‰Šé™¤ã—ãªã„ï¼‰ãƒªãƒ­ãƒ¼ãƒ‰</button>
      </div>
      <div class="note">â€» PWAï¼ˆãƒ›ãƒ¼ãƒ è¿½åŠ ï¼‰ã ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¼·ã„ã€‚ã¾ãšé€šå¸¸ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã®ãŒå®‰å…¨ã€‚</div>
    </div>

    <div class="section" id="secC">
      <div class="section-title">ğŸ—ƒï¸ C) ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç³»ã®çŠ¶æ…‹</div>
      <div class="row"><div class="k">localStorage ä½¿ç”¨é‡ï¼ˆæ¦‚ç®—ï¼‰</div><div class="v mono" id="cLsSize">ç¢ºèªä¸­â€¦</div></div>
      <div class="row"><div class="k">localStorage ã‚­ãƒ¼</div><div class="v mono" id="cLsKeys">ç¢ºèªä¸­â€¦</div></div>
      <div class="row"><div class="k">IndexedDB</div><div class="v mono" id="cIdb">ç¢ºèªä¸­â€¦</div></div>
      <div class="btnbar">
        <button id="btnExport">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‡ºåŠ›ï¼ˆlocalStorageï¼‰</button>
        <button class="secondary" id="btnCopy">ã‚³ãƒ”ãƒ¼</button>
      </div>
      <div class="note">â€» ã“ã“ã¯å°†æ¥â€œãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—â€ãƒœã‚¿ãƒ³é…ä¸‹ã«ç§»ã™æƒ³å®šã€‚ã¾ãšè¨ºæ–­ã§ã¯æœ€å°å®Ÿè£…ã€‚</div>
      <div style="margin-top:10px;">
        <textarea id="backupArea" placeholder="ã“ã“ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—JSONãŒå‡ºã¾ã™ï¼ˆã¾ãŸã¯è²¼ã‚Šä»˜ã‘ã¦å¾©å…ƒï¼‰"></textarea>
        <div class="btnbar">
          <button class="danger" id="btnImport">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—èª­ã¿è¾¼ã¿ï¼ˆlocalStorageã¸å¾©å…ƒï¼‰</button>
          <button class="secondary" id="btnClearLs">localStorage å…¨æ¶ˆã—</button>
        </div>
        <div class="note" style="color:#ef9a9a;">â€»ã€Œèª­ã¿è¾¼ã¿ã€ã¯ä¸Šæ›¸ãã€‚å¿…è¦ãªã‚‰å…ˆã«â€œå‡ºåŠ›â€ã—ã¦ä¿ç®¡ã—ã¦ã‹ã‚‰ã€‚</div>
      </div>
    </div>

    <div class="section" id="secD">
      <div class="section-title">ğŸŒ D) é€šä¿¡ãƒ»è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèªï¼ˆä»»æ„ï¼‰</div>
      <div class="row"><div class="k">config.jsonï¼ˆåŒéšå±¤ï¼‰</div><div class="v mono" id="dCfg">æœªå®Ÿè¡Œ</div></div>
      <div class="row"><div class="k">dev/config.jsonï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰</div><div class="v mono" id="dCfg2">æœªå®Ÿè¡Œ</div></div>
      <div class="btnbar"><button id="btnFetchCfg">config.json ã‚’èª­ã‚“ã§ã¿ã‚‹</button></div>
      <div class="note">â€» GitHub Pages é…å¸ƒã§ config.json ãŒæƒ³å®šå ´æ‰€ã«ç„¡ã„ã¨ã€æœ¬ä½“ãŒé€”ä¸­ã§æ­¢ã¾ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</div>
    </div>

    <div class="section">
      <div class="section-title">âœ… ã“ã“ãŒè¦‹ãˆã¦ã„ã‚Œã°OK</div>
      <div class="note">
        ã“ã®ãƒšãƒ¼ã‚¸ãŒè¡¨ç¤ºã§ãã¦ã„ã‚Œã°ã€å°‘ãªãã¨ã‚‚ <span class="mono">/diagnostics.html</span> ã® 404 ã¯è§£æ¶ˆã—ã¦ã„ã¾ã™ã€‚<br>
        ã‚‚ã—ã€Œæœ¬ä½“URLã¯å‹•ãã®ã« diagnostics ã ã‘å¤‰ã€ãªã‚‰ã€<b>é…å¸ƒå…ƒã®ã‚ºãƒ¬</b> ã¾ãŸã¯ <b>å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥</b> ãŒæ¿ƒåšã§ã™ã€‚
      </div>
    </div>
  </div>

<script>
(()=> {
  const qs = new URLSearchParams(location.search);
  const qBuild = qs.get('b') || '';
  const qDebug = qs.get('debug') || '';
  document.getElementById('qBuild').textContent = qBuild || '(ãªã—)';
  document.getElementById('qDebug').textContent = qDebug || '(ãªã—)';
  document.getElementById('locLine').textContent = location.href;

  const safeGet=(fn,fb)=>{try{return fn()}catch(e){return fb}};
  const approxLocalStorageBytes=()=>{
    let bytes=0;
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      const v=localStorage.getItem(k)||'';
      bytes+=(k.length+v.length)*2;
    }
    return bytes;
  };
  const humanBytes=(n)=>{
    if(!isFinite(n)) return 'ä¸æ˜';
    const u=['B','KB','MB','GB']; let i=0,x=n;
    while(x>=1024 && i<u.length-1){x/=1024;i++}
    return x.toFixed(i===0?0:2)+u[i];
  };

  const refreshA=async()=>{
    document.getElementById('aUrl').textContent=location.href;
    document.getElementById('aNow').textContent=String(Date.now());

    const full =
      window.FULL_VERSION ||
      window.VERSION_INFO ||
      document.querySelector('#versionBadge, .version-badge, [data-version]')?.textContent ||
      '(è¦ªãƒšãƒ¼ã‚¸ã‹ã‚‰å–å¾—ä¸å¯)';
    document.getElementById('aFull').textContent=String(full).trim();

    const build =
      window.BUILD_ID ||
      window.DEFAULT_BUILD ||
      (window.VERSION_INFO && window.VERSION_INFO.buildId) ||
      '(è¦ªãƒšãƒ¼ã‚¸ã‹ã‚‰å–å¾—ä¸å¯)';
    document.getElementById('aBuild').textContent=String(build).trim();

    document.getElementById('aB').textContent=qBuild? qBuild : 'ãªã—';

    const fb=safeGet(()=>localStorage.getItem('smartPriceFirebaseUrl')||localStorage.getItem('firebaseUrl')||'','');
    document.getElementById('aFb').textContent=fb?fb:'OFF';
  };

  const refreshB=async()=>{
    if(!('serviceWorker' in navigator)){
      document.getElementById('bCtrl').textContent='æœªå¯¾å¿œ';
      document.getElementById('bRegs').textContent='æœªå¯¾å¿œ';
      document.getElementById('bCaches').textContent='æœªå¯¾å¿œ';
      return;
    }
    document.getElementById('bCtrl').textContent=navigator.serviceWorker.controller?'ã‚ã‚Š':'ãªã—';
    const regs=await navigator.serviceWorker.getRegistrations();
    document.getElementById('bRegs').textContent=String(regs.length);

    if('caches' in window){
      const names=await caches.keys();
      document.getElementById('bCaches').textContent=names.length + (names.length?` ï¼ˆ${names.join(', ')}ï¼‰`:'');
    }else{
      document.getElementById('bCaches').textContent='æœªå¯¾å¿œ';
    }
  };

  const refreshC=async()=>{
    const bytes=approxLocalStorageBytes();
    document.getElementById('cLsSize').textContent=humanBytes(bytes)+`ï¼ˆã‚­ãƒ¼æ•° ${localStorage.length}ï¼‰`;
    const keys=[];
    for(let i=0;i<localStorage.length;i++) keys.push(localStorage.key(i));
    keys.sort();
    document.getElementById('cLsKeys').textContent=keys.length?keys.join(', '):'(ç©º)';
    document.getElementById('cIdb').textContent=safeGet(()=>window.indexedDB?'åˆ©ç”¨å¯':'ä¸å¯','ä¸æ˜');
  };

  const fetchText=async(url)=>{
    const res=await fetch(url,{cache:'no-store'});
    if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
    return await res.text();
  };

  const checkCfg=async()=>{
    const el1=document.getElementById('dCfg');
    const el2=document.getElementById('dCfg2');
    el1.textContent='ç¢ºèªä¸­â€¦'; el2.textContent='ç¢ºèªä¸­â€¦';
    try{
      const t=await fetchText('./config.json?b='+encodeURIComponent(qBuild||Date.now()));
      el1.textContent='OKï¼ˆèª­ã‚ãŸï¼‰: '+t.slice(0,120).replace(/\s+/g,' ')+(t.length>120?'â€¦':'');
    }catch(e){
      el1.textContent='NG: '+(e?.message||e);
    }
    try{
      const t2=await fetchText('./dev/config.json?b='+encodeURIComponent(qBuild||Date.now()));
      el2.textContent='OKï¼ˆèª­ã‚ãŸï¼‰: '+t2.slice(0,120).replace(/\s+/g,' ')+(t2.length>120?'â€¦':'');
    }catch(e){
      el2.textContent='NG: '+(e?.message||e);
    }
  };

  const nukeSWAndCaches=async()=>{
    if('serviceWorker' in navigator){
      const regs=await navigator.serviceWorker.getRegistrations();
      await Promise.all(regs.map(r=>r.unregister().catch(()=>null)));
    }
    if('caches' in window){
      const names=await caches.keys();
      await Promise.all(names.map(n=>caches.delete(n).catch(()=>null)));
    }
  };

  const exportLS=()=>{
    const obj={};
    for(let i=0;i<localStorage.length;i++){
      const k=localStorage.key(i);
      obj[k]=localStorage.getItem(k);
    }
    return JSON.stringify({
      app:'Smart Price',
      kind:'localStorage-backup',
      version:'v1.0.0',
      exportedAt:new Date().toISOString(),
      url:location.href,
      data:obj
    },null,2);
  };

  const importLS=(txt)=>{
    const payload=JSON.parse(txt);
    if(!payload||payload.kind!=='localStorage-backup'||!payload.data) throw new Error('å½¢å¼ãŒé•ã„ã¾ã™ï¼ˆlocalStorage-backup ã§ã¯ãªã„ï¼‰');
    const data=payload.data;
    Object.keys(data).forEach(k=>{
      const v=data[k];
      if(v===null||typeof v==='undefined') localStorage.removeItem(k);
      else localStorage.setItem(k,String(v));
    });
  };

  document.getElementById('btnRefresh').addEventListener('click',async()=>{await refreshA();await refreshB();await refreshC();});
  document.getElementById('btnOnlyReload').addEventListener('click',()=>location.reload());
  document.getElementById('btnNuke').addEventListener('click',async()=>{
    if(!confirm('Service Worker ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    await nukeSWAndCaches(); location.reload();
  });

  document.getElementById('btnExport').addEventListener('click',async()=>{
    document.getElementById('backupArea').value=exportLS();
    await refreshC();
  });
  document.getElementById('btnCopy').addEventListener('click',async()=>{
    const txt=document.getElementById('backupArea').value||'';
    if(!txt) return alert('å…ˆã«ã€Œãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å‡ºåŠ›ã€ã‚’æŠ¼ã—ã¦ã­ã€‚');
    try{await navigator.clipboard.writeText(txt); alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚');}
    catch(e){alert('ã‚³ãƒ”ãƒ¼ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ã­ã€‚');}
  });
  document.getElementById('btnImport').addEventListener('click',async()=>{
    const txt=document.getElementById('backupArea').value||'';
    if(!txt.trim()) return alert('è²¼ã‚Šä»˜ã‘ãŒç©ºã§ã™ã€‚');
    if(!confirm('localStorage ã‚’ä¸Šæ›¸ãå¾©å…ƒã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    try{importLS(txt); alert('å¾©å…ƒã—ã¾ã—ãŸã€‚'); await refreshA(); await refreshC();}
    catch(e){alert('å¾©å…ƒã§ãã¾ã›ã‚“ã§ã—ãŸ: '+(e?.message||e));}
  });
  document.getElementById('btnClearLs').addEventListener('click',async()=>{
    if(!confirm('localStorage ã‚’å…¨æ¶ˆã—ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
    localStorage.clear(); document.getElementById('backupArea').value='';
    await refreshA(); await refreshC();
  });

  document.getElementById('btnFetchCfg').addEventListener('click',checkCfg);

  (async()=>{await refreshA();await refreshB();await refreshC();})();
})();
</script>
</body>
</html>
